create or replace package body mktqads as


    FUNCTION MAIN_GENERAL_SRS (NOMLOG VARCHAR2, P_DATE_TRAIT DATE, P_CODE_PAYS VARCHAR2) return number IS
        V_ERR number:=0;
        V_RET number:=0;
        V_TRT VARCHAR2(100) := null;
        V_ERR_TRT number:=0;
        V_ERRUR NUMBER :=0;
        V_INSERTS NUMBER := 0;
        V_UPDATES NUMBER :=0;
        P_DATE_TRAI DATE;
        V_ERROR NUMBER :=0;
        V_CODE_PAYS VARCHAR2(2);

  BEGIN
     
  V_ERR := ALIM_MKTQASRS_CONTRACT(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;


 V_ERR := ALIM_MKTQASRS_FINANCING (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;
                            
 
 V_ERR := ALIM_MKTQASRS_SECURITIZATION (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;
                            

 V_ERR := ALIM_MKTQASRS_ACCOUNT (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;
                            
 V_ERR := ALIM_MKTQASRS_PAYMEANACTIF (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;
                            
 V_ERR := ALIM_MKTQASRS_VEHICULE (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;                             

 V_ERR := ALIM_MKTQASRS_VEHICULE_AMT (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;  
                            
 V_ERR := ALIM_MKTQASRS_VEH_ENDOFLIFE (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;
                            
 V_ERR := ALIM_MKTQASRS_SERVICES (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;                           

 V_ERR := ALIM_MKTQASRS_SCHEDULES (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;  
                            
 V_ERR := ALIM_MKTQASRS_STAKEHOLDER (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if; 

 V_ERR := ALIM_MKTQASRS_STAKEHOLDER_ADRS (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;
 V_ERR := ALIM_MKTQASRS_AMENDMENT (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;

 V_ERR := ALIM_MKTQASRS_AMENDMENT_EXTENS (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;

 V_ERR := ALIM_MKTQASRS_SIGNATORY (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if; 


---------------------------------------------------------------------------------------------------
--                              Agreement 
---------------------------------------------------------------------------------------------------      

 V_ERR := ALIM_MKTQASRS_AGREEMENT (NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;
                            
 V_ERR := ALIM_MKTQASRS_AGREEMENT_REQEST(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;

 V_ERR := ALIM_MKTQASRS_AGREEMENT_CONTRA(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;  

 V_ERR := ALIM_MKTQASRS_AGREEMENT_FEES(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if; 

---------------------------------------------------------------------------------------------------
--                              CustomerProfile 
---------------------------------------------------------------------------------------------------  

 V_ERR := ALIM_MKTQASRS_CUSTOMER_PROFILE(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if; 

 V_ERR := ALIM_MKTQASRS_CUSTOMER_PRF_CTT(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;
                            
---------------------------------------------------------------------------------------------------
--                              Asset Vehicule 
--------------------------------------------------------------------------------------------------- 
 V_ERR := ALIM_MKTQASRS_ASSET(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;

 V_ERR := ALIM_MKTQASRS_ASSET_VEHICULE(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if; 

 V_ERR := ALIM_MKTQASRS_ASSET_VEH_LABELS(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;


 V_ERR := ALIM_MKTQASRS_ASSET_VEH_PRICE(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;

 V_ERR := ALIM_MKTQASRS_ASSET_VEH_BASEPR(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;

 V_ERR := ALIM_MKTQASRS_ASSET_VEH_PR_DST(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if; 

 V_ERR := ALIM_MKTQASRS_ASSET_VEH_LIFECY(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;
                            
 V_ERR := ALIM_MKTQASRS_ASSET_VEH_DOMREF(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;
    

---------------------------------------------------------------------------------------------------
--                              Customer 
--------------------------------------------------------------------------------------------------- 

 V_ERR := ALIM_MKTQASRS_CUSTOMER(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;

 V_ERR := ALIM_MKTQASRS_CUS_AGREEMENT(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;
 V_ERR := ALIM_MKTQASRS_CUS_PERS_CONTACT(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;

 V_ERR := ALIM_MKTQASRS_CUS_ROLEBANKINGS(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;   

 V_ERR := ALIM_MKTQASRS_CUS_NATIONALID(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if; 

 V_ERR := ALIM_MKTQASRS_CUS_CONTACTMEAN(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if; 

 V_ERR := ALIM_MKTQASRS_CUS_CTMEAN_ADRS(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if; 

 V_ERR := ALIM_MKTQASRS_CUS_CTMEAN_PHONE(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;

 V_ERR := ALIM_MKTQASRS_CUS_CTMEAN_EMAIL(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;

 V_ERR := ALIM_MKTQASRS_CUS_CTMEAN_BKINF(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if; 
 
 V_ERR := ALIM_MKTQASRS_CUS_CTMEAN_CRREF(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;  

 V_ERR := ALIM_MKTQASRS_CUS_CTMEAN_EXREF(NOMLOG, P_DATE_TRAIT ,P_CODE_PAYS);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;  
                            
		return V_RET;
																														-- NE229K1 04/08/2016	E464135 PDA Argentina >>
END MAIN_GENERAL_SRS;  
---------------------------------------------------------------------------------------------------------------------------------
--
--
--                  PROJET : SRS
--
--------------------------------------------------------------------------------------------------------------------------------
Function ALIM_MKTQASRS_CONTRACT (Nomlog Varchar2, P_DATE_TRAI DATE, P_CODE_PAYS VARCHAR2 ) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CONTRACT';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CONTRACT'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;
  
  V_isBuyBackMake VARCHAR2(30);

  Cursor C_CONTRACT_SRS Is
                              SELECT
                                        AC.ACC_ACCOUNT_NUMBER || P_CODE_PAYS || 'SRS' AS tech_id,  --- AJOUT DE TECH_ID COMME POUR MILES (A CONFIRMER)
                                        TO_CHAR(AC.ACC_EXTRACT_DT, 'DD/MM/YYYY') AS tech_dateExtraction,
                                        AC.ACC_COUNTRY_CODE AS countryBranchCode,
                                        AC.ACC_ACCOUNT_NUMBER AS contractRef,
                                        'SRS'  AS backOfficeOrigin,
                                        AC.ACC_CONTRACT_STATUS AS contractStatus,
                                        AC.ACC_NPA_STATUS AS accountStatus,
                                        TO_CHAR(AC.ACC_NPA_ACCOUNT_STATUS_DATE, 'DD/MM/YYYY') AS accountStatusChangeDate,
                                        TO_CHAR(AC.ACC_CONTRACT_DT, 'DD/MM/YYYY') AS activationDate,
                                        AC.ACC_ORIGINAL_TERM AS durationContractInit,
                                        AC.ACC_TERM AS durationContract,
                                        TO_CHAR(AC.ACC_FINAL_INSTALLMENT_DUE_DT, 'DD/MM/YYYY') AS dateEndContract,
                                        TO_CHAR(AC.ACC_CONTRACT_PIF_DATE, 'DD/MM/YYYY') AS realDateEndContract,
                                        AC.ACC_PRODUCT_CODE AS productCategoryCode,
                                        NULL AS sellerAgency, ---AC.ACC_dealershipRef AS sellerAgency,   --- A VOIR (COLONNE INEXISTANT)
                                        AC.ACC_SALESMAN_NAME AS salesmanFullName,
                                        AC.ACC_SALESMAN_CODE AS salesmanCode,
                                        AC.ACC_LEASE_TYPE_CODE AS productCode,
                                        AC.ACC_PROMOTION_ID AS productSubCode,
                                        AC.ACC_SCHEME_ID_DESC AS commercialProductLabel,--- COLONNE CREEE SUR ORACLE
                                        TO_CHAR(ASS.ASS_VEHICLE_RETURN_DT, 'DD/MM/YYYY') AS dateEndContractWhenReturned, 
                                        -------------------CASE WHEN buyBackType = 'Network' THEN FALSE ELSE TRUE END  ----(FAIT EN CREANT UNE VARIABLE)
                                        (CASE WHEN AC.ACC_COUNTRY_CODE = 'DE' THEN
                                            (CASE WHEN AC.ACC_BUYBACK_METHOD IN ('1','2') THEN 'Network' ELSE 'Brand' END)
                                            
                                        WHEN AC.ACC_COUNTRY_CODE = 'FR' THEN
                                            (CASE WHEN AC.ACC_SCHEME_ID_DESC LIKE '%BUY BACK DEALER%' THEN 'Network' ELSE 'Brand' END)
                                            
                                        WHEN AC.ACC_COUNTRY_CODE = 'UK' THEN 'Brand'
                                            
                                        WHEN AC.ACC_COUNTRY_CODE = 'IT' THEN
                                            (CASE WHEN AC.ACC_OEM_BUYBACK = 'N' AND AC.ACC_DEALER_BUYBACK = 'Y' THEN 'Network' ELSE 'Brand' END)
                                            
                                        ELSE NULL
                                        END) AS buyBackType,
                                        'true' AS isLeasco,
                                        'false' AS isFinco   
                              FROM 
                              MKTOV.MKTQT_ACCOUNT_MSTR AC,
                              MKTOV.MKTQT_ASSET_MSTR ASS 
                              WHERE AC.ACC_ASSET_ID = ASS.ASS_ASSET_ID
                              AND AC.ACC_COUNTRY_CODE = ASS.ASS_COUNTRY_CODE
                              AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS
                              AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR S_CONTRACT_SRS IN C_CONTRACT_SRS
  LOOP
        
       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        IF S_CONTRACT_SRS.buyBackType = 'Network' THEN V_isBuyBackMake := 'false'; ELSE V_isBuyBackMake := 'true'; END IF; 


        INSERT INTO MKTOV.MKTQT_CONTRACT 
              (
tech_id,
tech_dateExtraction,
countryBranchCode,
contractRef,
backOfficeOrigin,
contractStatus,
accountStatus,
accountStatusChangeDate,
activationDate,
durationContractInit,
durationContract,
dateEndContract,
realDateEndContract,
productCategoryCode,
sellerAgency,
salesmanFullName,
salesmanCode,
productCode,
productSubCode,
commercialProductLabel,
dateEndContractWhenReturned,
isBuyBackMake,
buyBackType,
isLeasco,
isFinco,
code_pays,
date_situ
              )
        VALUES
              (
S_CONTRACT_SRS.tech_id,
S_CONTRACT_SRS.tech_dateExtraction,
S_CONTRACT_SRS.countryBranchCode,
S_CONTRACT_SRS.contractRef,
S_CONTRACT_SRS.backOfficeOrigin,
S_CONTRACT_SRS.contractStatus,
S_CONTRACT_SRS.accountStatus,
S_CONTRACT_SRS.accountStatusChangeDate,
S_CONTRACT_SRS.activationDate,
S_CONTRACT_SRS.durationContractInit,
S_CONTRACT_SRS.durationContract,
S_CONTRACT_SRS.dateEndContract,
S_CONTRACT_SRS.realDateEndContract,
S_CONTRACT_SRS.productCategoryCode,
S_CONTRACT_SRS.sellerAgency,
S_CONTRACT_SRS.salesmanFullName,
S_CONTRACT_SRS.salesmanCode,
S_CONTRACT_SRS.productCode,
S_CONTRACT_SRS.productSubCode,
S_CONTRACT_SRS.commercialProductLabel,
S_CONTRACT_SRS.dateEndContractWhenReturned,
V_isBuyBackMake,    ------ isBuyBackMake,
S_CONTRACT_SRS.buyBackType,
S_CONTRACT_SRS.isLeasco,
S_CONTRACT_SRS.isFinco,
p_code_pays,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
       When Dup_Val_On_Index Then
        Update  MKTOV.MKTQT_CONTRACT 
        Set     	
tech_dateExtraction = S_CONTRACT_SRS.tech_dateExtraction,
countryBranchCode = S_CONTRACT_SRS.countryBranchCode,
contractRef = S_CONTRACT_SRS.contractRef,
backOfficeOrigin = S_CONTRACT_SRS.backOfficeOrigin,
contractStatus = S_CONTRACT_SRS.contractStatus,
accountStatus = S_CONTRACT_SRS.accountStatus,
accountStatusChangeDate = S_CONTRACT_SRS.accountStatusChangeDate,
activationDate = S_CONTRACT_SRS.activationDate,
durationContractInit = S_CONTRACT_SRS.durationContractInit,
durationContract = S_CONTRACT_SRS.durationContract,
dateEndContract = S_CONTRACT_SRS.dateEndContract,
realDateEndContract = S_CONTRACT_SRS.realDateEndContract,
productCategoryCode = S_CONTRACT_SRS.productCategoryCode,
sellerAgency = S_CONTRACT_SRS.sellerAgency,
salesmanFullName = S_CONTRACT_SRS.salesmanFullName,
salesmanCode = S_CONTRACT_SRS.salesmanCode,
productCode = S_CONTRACT_SRS.productCode,
productSubCode = S_CONTRACT_SRS.productSubCode,
commercialProductLabel = S_CONTRACT_SRS.commercialProductLabel,
dateEndContractWhenReturned = S_CONTRACT_SRS.dateEndContractWhenReturned,
isBuyBackMake = V_isBuyBackMake,
buyBackType = S_CONTRACT_SRS.buyBackType,
isLeasco = S_CONTRACT_SRS.isLeasco,
isFinco = S_CONTRACT_SRS.isFinco ,
date_situ = p_date_trai
      Where   tech_id	=	S_CONTRACT_SRS.tech_id	
      AND code_pays = p_code_pays;
	

          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_CONTRACT;


Function ALIM_MKTQASRS_FINANCING ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_FINANCING';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_FINANCING'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ACC_ACCOUNT_NUMBER as     contractRef,
                              ACC_FINANCED_AMT_EXCL_TAX_AMT as     totalFinancedAmountET,
                              ACC_FINANCED_AMT_EXCL_TAX_AMT as     initialTotalFinancedAmountET,
                              ASS_VEHICLE_BASIC_PRICE as     fixedAssetAmountET,
                              ACC_RESIDUAL_VALUE_AMT as     residualValueAmountET,
                              ASS_SALEPRICEDEALER as     residualValueDealerAmountET,
                              ACC_CONTRACT_DT as     dateStartContract,  /* a voir */ 
                              ACC_DEPOSIT_AMT as     amountDeposit,
                              ACC_PAST_DUE_INSTALLMENTOUNT as     numberUnpaid,
                              ACC_OTSTDNG_PRNPL_BAL_AMUTURE as     amountRemainingCapital,
                              ACC_FIRST_DUE_DT as     startDateOfDueDate,
                              NULL as     endDateOfDueDate, /* voir si : ACC_ORIGINAL_OUTSTANDINGLNC_AM */ 
                              ACC_NOMINAL_RATE as     nominalRate,
                              ACC_FLOATING_RATE_TYPE as     rateType,
                              ACC_INTEREST_RATE_APR as     taegRate,
                              ACC_EXCESS_MILEAGE_RATE as     costAdditionalMileage,
                              ACC_ORIGINAL_OUTSTANDINGLNC_AM as     fin_amt_init_interst_outserv
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_ASSET_MSTR ASS
                    WHERE 
                    AC.ACC_ASSET_ID = ASS.ASS_ASSET_ID
                    AND AC.ACC_COUNTRY_CODE = ASS.ASS_COUNTRY_CODE
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_FINANCING 
              (
TECH_ID,
CONTRACTREF,
TOTALFINANCEDAMOUNTET,
INITIALTOTALFINANCEDAMOUNTET,
FIXEDASSETAMOUNTET,
RESIDUALVALUEAMOUNTET,
RESIDUALVALUEDEALERAMOUNTET,
DATESTARTCONTRACT,
AMOUNTDEPOSIT,
NUMBERUNPAID,
AMOUNTREMAININGCAPITAL,
STARTDATEOFDUEDATE,
ENDDATEOFDUEDATE,
NOMINALRATE,
RATETYPE,
TAEGRATE,
COSTADDITIONALMILEAGE,
FIN_AMT_INIT_INTERST_OUTSERV,
DATE_SITU,
CODE_PAYS
              )
        VALUES
              (
REC.TECH_ID,
REC.CONTRACTREF,
REC.TOTALFINANCEDAMOUNTET,
REC.INITIALTOTALFINANCEDAMOUNTET,
REC.FIXEDASSETAMOUNTET,
REC.RESIDUALVALUEAMOUNTET,
REC.RESIDUALVALUEDEALERAMOUNTET,
REC.DATESTARTCONTRACT,
REC.AMOUNTDEPOSIT,
REC.NUMBERUNPAID,
REC.AMOUNTREMAININGCAPITAL,
REC.STARTDATEOFDUEDATE,
REC.ENDDATEOFDUEDATE,
REC.NOMINALRATE,
REC.RATETYPE,
REC.TAEGRATE,
REC.COSTADDITIONALMILEAGE,
REC.FIN_AMT_INIT_INTERST_OUTSERV,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_FINANCING 
          Set     	
                    CONTRACTREF	=	REC.CONTRACTREF,
                    TOTALFINANCEDAMOUNTET	=	REC.TOTALFINANCEDAMOUNTET,
                    INITIALTOTALFINANCEDAMOUNTET	=	REC.INITIALTOTALFINANCEDAMOUNTET,
                    FIXEDASSETAMOUNTET	=	REC.FIXEDASSETAMOUNTET,
                    RESIDUALVALUEAMOUNTET	=	REC.RESIDUALVALUEAMOUNTET,
                    RESIDUALVALUEDEALERAMOUNTET	=	REC.RESIDUALVALUEDEALERAMOUNTET,
                    DATESTARTCONTRACT	=	REC.DATESTARTCONTRACT,
                    AMOUNTDEPOSIT	=	REC.AMOUNTDEPOSIT,
                    NUMBERUNPAID	=	REC.NUMBERUNPAID,
                    AMOUNTREMAININGCAPITAL	=	REC.AMOUNTREMAININGCAPITAL,
                    STARTDATEOFDUEDATE	=	REC.STARTDATEOFDUEDATE,
                    ENDDATEOFDUEDATE	=	REC.ENDDATEOFDUEDATE,
                    NOMINALRATE	=	REC.NOMINALRATE,
                    RATETYPE	=	REC.RATETYPE,
                    TAEGRATE	=	REC.TAEGRATE,
                    COSTADDITIONALMILEAGE	=	REC.COSTADDITIONALMILEAGE,
                    FIN_AMT_INIT_INTERST_OUTSERV	=	REC.FIN_AMT_INIT_INTERST_OUTSERV,
                    DATE_SITU	=	p_date_trai
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_FINANCING;



Function ALIM_MKTQASRS_SECURITIZATION ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_SECURITIZATION';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_SECURITIZATION'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ACC_ACCOUNT_NUMBER as     contractRef,
                              ACC_SECURITIZED_DT as dateStart,
                              ACC_SECURITIZATION_DEAL_BER as id,
                              CASE WHEN ACC_SECURITIZED_DT IS NOT NULL  THEN 'true' ELSE 'false' END isSecurized
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_ASSET_MSTR ASS
                    WHERE 
                    AC.ACC_ASSET_ID = ASS.ASS_ASSET_ID
                    AND AC.ACC_COUNTRY_CODE = ASS.ASS_COUNTRY_CODE
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null
                    ;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_SECURITIZATION 
              (
TECH_ID,
CONTRACTREF,
DATESTART,
ID,
ISSECURIZED,
DATE_SITU,
CODE_PAYS
              )
        VALUES
              (
REC.TECH_ID,
REC.CONTRACTREF,
REC.DATESTART,
REC.ID,
REC.ISSECURIZED,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_SECURITIZATION 
          Set     	
                    CONTRACTREF	=	REC.CONTRACTREF,
                    DATESTART	=	REC.DATESTART,
                    ID	=	REC.ID,
                    ISSECURIZED	=	REC.ISSECURIZED,
                    DATE_SITU	=	p_date_trai
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_SECURITIZATION;




Function ALIM_MKTQASRS_ACCOUNT ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_ACCOUNT';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_ACCOUNT'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ACC_ACCOUNT_NUMBER as     contractRef,
                              ACC_BALLOON_AMT as   balloonValueAmount,
                              ACC_NEXT_DUE_DT as   nextDueDate,
                              ACC_NEXT_INSTALLMENT_AMT as   nextRentAmountET,
                              ACC_INSTALLMENTS_REMNG_CFUTURE as   nbPaymentNotBilled,
                              ACC_LAST_PAYMENT_AMOUNT as   lastPaidAmountET,
                              ACC_FIRST_INSTALLMENT_AMOUNT as   amountFinancialInitRentET,
                              ACC_MONTHLY_INSTALLMENT_AMT as   amountFinancialRentET,
                              ACC_NEXT_INSTALLMENT_AMT as   amountFinancialRentWithServIT,
                              ACC_CONTRACT_DUE_DAY as   dayOfPayment,
                              ACC_INSTALLMENT_FREQUENCY as   periodicity,
                              FEE_CHARGE_AMOUNT as   chargeAmountET
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_FEES_CHARGES_MSTR FE
                    WHERE 
                    AC.ACC_ACCOUNT_NUMBER = FE.FEE_CONTRACT_NUMBER
                    AND AC.ACC_COUNTRY_CODE = FE.FEE_COUNTRY_CODE
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_ACCOUNT 
              (
TECH_ID	,
CONTRACTREF	,
BALLOONVALUEAMOUNT	,
NEXTDUEDATE	,
NEXTRENTAMOUNTET	,
NBPAYMENTNOTBILLED	,
LASTPAIDAMOUNTET	,
AMOUNTFINANCIALINITRENTET	,
AMOUNTFINANCIALRENTET	,
AMOUNTFINANCIALRENTWITHSERVIT	,
DAYOFPAYMENT	,
PERIODICITY	,
CHARGEAMOUNTET	,
DATE_SITU	,
CODE_PAYS	
              )
        VALUES
              (
REC.TECH_ID	,
REC.CONTRACTREF	,
REC.BALLOONVALUEAMOUNT	,
REC.NEXTDUEDATE	,
REC.NEXTRENTAMOUNTET	,
REC.NBPAYMENTNOTBILLED	,
REC.LASTPAIDAMOUNTET	,
REC.AMOUNTFINANCIALINITRENTET	,
REC.AMOUNTFINANCIALRENTET	,
REC.AMOUNTFINANCIALRENTWITHSERVIT	,
REC.DAYOFPAYMENT	,
REC.PERIODICITY	,
REC.CHARGEAMOUNTET	,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_ACCOUNT 
          Set     	
                    CONTRACTREF	=	REC.CONTRACTREF ,
                    BALLOONVALUEAMOUNT	=	REC.BALLOONVALUEAMOUNT ,
                    NEXTDUEDATE	=	REC.NEXTDUEDATE ,
                    NEXTRENTAMOUNTET	=	REC.NEXTRENTAMOUNTET ,
                    NBPAYMENTNOTBILLED	=	REC.NBPAYMENTNOTBILLED ,
                    LASTPAIDAMOUNTET	=	REC.LASTPAIDAMOUNTET ,
                    AMOUNTFINANCIALINITRENTET	=	REC.AMOUNTFINANCIALINITRENTET ,
                    AMOUNTFINANCIALRENTET	=	REC.AMOUNTFINANCIALRENTET ,
                    AMOUNTFINANCIALRENTWITHSERVIT	=	REC.AMOUNTFINANCIALRENTWITHSERVIT ,
                    DAYOFPAYMENT	=	REC.DAYOFPAYMENT , 
                    PERIODICITY	=	REC.PERIODICITY ,
                    CHARGEAMOUNTET	=	REC.CHARGEAMOUNTET ,
                    DATE_SITU	=	p_date_trai
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_ACCOUNT;


Function ALIM_MKTQASRS_PAYMEANACTIF ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_PAYMEANACTIF';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CPAYMEANACTIF'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT 
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ACC_ACCOUNT_NUMBER as  contractRef,
                              ACC_PAYMENT_METHOD_CODE as  paymentTypeCode,
                              ACC_DD_BANK_CAB as  bankAgency,
                              ACC_DD_BANK_ACCOUNT_NUMBER as  bankAccountNumber,
                              ACC_DD_BANK_CIN as  bankAccountKey,
                              ACC_DD_BANK_ABI as  bankNumber,
                              ACC_DD_BANK_NAME as  bankName,
                              ACC_IBAN as  sepaIban
                    FROM
                    MKTOV.MKTQT_ACCOUNT_MSTR AC
                    WHERE
                    AC.ACC_COUNTRY_CODE = P_CODE_PAYS;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_CPAYMEANACTIF 
              (
TECH_ID ,
CONTRACTREF ,
PAYMENTTYPECODE ,
BANKAGENCY ,
BANKACCOUNTNUMBER ,
BANKACCOUNTKEY ,
BANKNUMBER ,
BANKNAME ,
SEPAIBAN ,
DATE_SITU ,
CODE_PAYS	
              )
        VALUES
              (
REC.TECH_ID	,
REC.CONTRACTREF	,
REC.PAYMENTTYPECODE ,
REC.BANKAGENCY ,
REC.BANKACCOUNTNUMBER ,
REC.BANKACCOUNTKEY ,
REC.BANKNUMBER ,
REC.BANKNAME ,
REC.SEPAIBAN ,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CPAYMEANACTIF 
          Set     	
                    CONTRACTREF	=	REC.CONTRACTREF ,
                    PAYMENTTYPECODE	=	REC.PAYMENTTYPECODE ,
                    BANKAGENCY	=	REC.BANKAGENCY ,
                    BANKACCOUNTNUMBER	=	REC.BANKACCOUNTNUMBER ,
                    BANKACCOUNTKEY	=	REC.BANKACCOUNTKEY ,
                    BANKNUMBER	=	REC.BANKNUMBER ,
                    BANKNAME	=	REC.BANKNAME ,
                    SEPAIBAN	=	REC.SEPAIBAN ,
                    DATE_SITU	=	p_date_trai
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_PAYMEANACTIF;



Function ALIM_MKTQASRS_VEHICULE ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_VEHICULE';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CVEHICULE'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ACC_EXTRACT_DT as  tech_dateExtraction	,
                              ASS_ACCOUNT_NUMBER as     contractRef,
                              ASS_VEHICLE_VIN_NUMBER as  serialNumber	,
                              ASS_VEHDELIVERYDATE as  deliveryDate	,
                              ASS_VEHICLE_RETURN_DT as  expectedReturnDate	,
                              ASS_NEW_USED_CODE as  stateCode	,
                              ASS_ASSET_USAGE as  usageCode	,
                              ACC_CONTRACT_MILEAGE as  contactualMileage	
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_ASSET_MSTR ASS
                    WHERE 
                    AC.ACC_ASSET_ID = ASS.ASS_ASSET_ID
                    AND AC.ACC_COUNTRY_CODE = ASS.ASS_COUNTRY_CODE
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_CVEHICULE 
              (
TECH_ID	,
TECH_DATEEXTRACTION	,
CONTRACTREF	,
SERIALNUMBER	,
DELIVERYDATE	,
EXPECTEDRETURNDATE	,
STATECODE	,
USAGECODE	,
CONTACTUALMILEAGE	,
DATE_SITU	,
CODE_PAYS
              )
        VALUES
              (
REC.TECH_ID	,
REC.TECH_DATEEXTRACTION	,
REC.CONTRACTREF	,
REC.SERIALNUMBER	,
REC.DELIVERYDATE	,
REC.EXPECTEDRETURNDATE	,
REC.STATECODE	,
REC.USAGECODE	,
REC.CONTACTUALMILEAGE	,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CVEHICULE 
          Set     	
                    TECH_DATEEXTRACTION	=	REC.TECH_DATEEXTRACTION,
                    CONTRACTREF	=	REC.CONTRACTREF,
                    SERIALNUMBER	=	REC.SERIALNUMBER,
                    DELIVERYDATE	=	REC.DELIVERYDATE,
                    EXPECTEDRETURNDATE	=	REC.EXPECTEDRETURNDATE,
                    STATECODE	=	REC.STATECODE,
                    USAGECODE	=	REC.USAGECODE,
                    CONTACTUALMILEAGE	=	REC.CONTACTUALMILEAGE,
                    DATE_SITU	=	p_date_trai
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_VEHICULE;


Function ALIM_MKTQASRS_VEHICULE_AMT ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_VEHICULE_AMT';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_VEHICULE_AMT'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT 
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ACC_VEHICLE_PRICE_NET as sellerPriceIT,
                              ACC_EXCESS_MILEAGE_RATE as excessMileageRate,
                              ACC_UNDERMILEAGE_RATE as underMileageRate
                    FROM
                    MKTOV.MKTQT_ACCOUNT_MSTR AC
                    WHERE
                    AC.ACC_COUNTRY_CODE = P_CODE_PAYS;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_VEHICULE_AMT 
              (
TECH_ID ,
SELLERPRICEIT ,
EXCESSMILEAGERATE ,
UNDERMILEAGERATE ,
DATE_SITU ,
CODE_PAYS	
              )
        VALUES
              (
REC.TECH_ID	,
REC.SELLERPRICEIT ,
REC.EXCESSMILEAGERATE ,
REC.UNDERMILEAGERATE ,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_VEHICULE_AMT 
          Set     	
                    SELLERPRICEIT = REC.SELLERPRICEIT ,
                    EXCESSMILEAGERATE = REC.EXCESSMILEAGERATE ,
                    UNDERMILEAGERATE = REC.UNDERMILEAGERATE ,
                    DATE_SITU	=	p_date_trai
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_VEHICULE_AMT;


Function ALIM_MKTQASRS_VEH_ENDOFLIFE ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_VEH_ENDOFLIFE';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_VEHICULE_ENDOFLIFE'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              NULL as contactEndOfLifeDate	, /* a voir */
                              ACC_EARLY_TERMINATION_FLAG         as  earlyTerminationFlag	,
                              ASS_VEHRETAPPDT          as  dealerReturnDate	,
                              ASS_VEHRETAPPCONFDT          as  choiceCustomerReturnDate	,
                              ASS_VEHRETURNDATEACTUAL          as  realReturnDate	,
                              ASS_CONTACTVIAEMAIL          as  contactEmailCustomerFlag	,
                              ASS_DATEOFCONTACTVIAEMAIL          as  contactEmailCustomerDate	,
                              ASS_CONTACTVIAPHONE          as  contactPhoneCustomerFlag	,
                              ASS_DATEOFPHONECONTACT          as  contactPhoneCustomerDate	,
                              ASS_SALEPRICEDEALER          as  resaleDealerFlag	,
                              ASS_SALEPRICETOCUSTOMER          as  resaleCustomerFlag	,
                              ASS_TOTALMILEAGEACTUAL         as  mileageEndOfLIfe	,
                              NULL          as  refurbishment	, /* a voir */
                              ASS_RETURNDLRNAME          as  buyerDealerName	,
                              ASS_RETURNDLRCITY          as  buyerDealerCity		
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_ASSET_MSTR ASS
                    WHERE 
                    AC.ACC_ASSET_ID = ASS.ASS_ASSET_ID
                    AND AC.ACC_COUNTRY_CODE = ASS.ASS_COUNTRY_CODE
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_VEHICULE_ENDOFLIFE 
              (
TECH_ID	,
CONTACTENDOFLIFEDATE	,
EARLYTERMINATIONFLAG	,
DEALERRETURNDATE	,
CHOICECUSTOMERRETURNDATE	,
REALRETURNDATE	,
CONTACTEMAILCUSTOMERFLAG	,
CONTACTEMAILCUSTOMERDATE	,
CONTACTPHONECUSTOMERFLAG	,
CONTACTPHONECUSTOMERDATE	,
RESALEDEALERFLAG	,
RESALECUSTOMERFLAG	,
MILEAGEENDOFLIFE	,
REFURBISHMENT	,
BUYERDEALERNAME	,
BUYERDEALERCITY	,
DATE_SITU	,
CODE_PAYS		
              )
        VALUES
              (
REC.TECH_ID	,
REC.CONTACTENDOFLIFEDATE	,
REC.EARLYTERMINATIONFLAG	,
REC.DEALERRETURNDATE	,
REC.CHOICECUSTOMERRETURNDATE	,
REC.REALRETURNDATE	,
REC.CONTACTEMAILCUSTOMERFLAG	,
REC.CONTACTEMAILCUSTOMERDATE	,
REC.CONTACTPHONECUSTOMERFLAG	,
REC.CONTACTPHONECUSTOMERDATE	,
REC.RESALEDEALERFLAG	,
REC.RESALECUSTOMERFLAG	,
REC.MILEAGEENDOFLIFE	,
REC.REFURBISHMENT	,
REC.BUYERDEALERNAME	,
REC.BUYERDEALERCITY	,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_VEHICULE_ENDOFLIFE 
          Set     	
                    CONTACTENDOFLIFEDATE	=	REC.CONTACTENDOFLIFEDATE	,
                    EARLYTERMINATIONFLAG	=	REC.EARLYTERMINATIONFLAG	,
                    DEALERRETURNDATE	=	REC.DEALERRETURNDATE	,
                    CHOICECUSTOMERRETURNDATE	=	REC.CHOICECUSTOMERRETURNDATE	,
                    REALRETURNDATE	=	REC.REALRETURNDATE	,
                    CONTACTEMAILCUSTOMERFLAG	=	REC.CONTACTEMAILCUSTOMERFLAG	,
                    CONTACTEMAILCUSTOMERDATE	=	REC.CONTACTEMAILCUSTOMERDATE	,
                    CONTACTPHONECUSTOMERFLAG	=	REC.CONTACTPHONECUSTOMERFLAG	,
                    CONTACTPHONECUSTOMERDATE	=	REC.CONTACTPHONECUSTOMERDATE	,
                    RESALEDEALERFLAG	=	REC.RESALEDEALERFLAG	,
                    RESALECUSTOMERFLAG	=	REC.RESALECUSTOMERFLAG	,
                    MILEAGEENDOFLIFE	=	REC.MILEAGEENDOFLIFE	,
                    REFURBISHMENT	=	REC.REFURBISHMENT	,
                    BUYERDEALERNAME	=	REC.BUYERDEALERNAME	,
                    BUYERDEALERCITY	=	REC.BUYERDEALERCITY	,
                    DATE_SITU	=	p_date_trai	
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_VEH_ENDOFLIFE;

Function ALIM_MKTQASRS_SERVICES ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_SERVICES';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_SERVICES'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              VAP_CONTRACT_NUMBER as contractRef	,
                              VAP_VAP_PRODUCT_ID as serviceRef	,
                              VAP_VAP_POLICY_NUMBER as externalServiceId	,
                              VAP_LI_SERVICE_CODE as serviceCodeType	,
                              VAP_LI_PRODUCT_DESC as labelService	,
                              VAP_VAP_START_DATE  as dateStartService	,
                              VAP_VAP_END_DATE as dateEndService	,
                              VAP_LI_VAP_TERM  as durationService	,
                              VAP_VAP_CANCELLATION_DATE as dateResiliation	,
                              VAP_LI_FUTURE_INSTL_AMT as nextPaymentAmountET	,
                              VAP_LI_TOTAL_INS_AMT as totaltAmountET	,
                              VAP_VAP_CANCEL_REASON as reasonOfEndService	,
                              CASE WHEN LOWER(VAP_LI_PRODUCT_DESC) like '%flexcare%' THEN 'true' ELSE 'false' END flagCEM	,
                              ACC_TOTAL_VAP_INSTALLMENT_AMT as totalAmountService 	 			
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_VAP_MSTR VP
                    WHERE 
                    AC.ACC_ACCOUNT_NUMBER = VP.VAP_CONTRACT_NUMBER
                    AND AC.ACC_COUNTRY_CODE = VP.VAP_COUNTRY_CODE
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_SERVICES 
              (
TECH_ID	,
CONTRACTREF	,
SERVICEREF	,
EXTERNALSERVICEID	,
SERVICECODETYPE	,
LABELSERVICE	,
DATESTARTSERVICE	,
DATEENDSERVICE	,
DURATIONSERVICE	,
DATERESILIATION	,
NEXTPAYMENTAMOUNTET	,
TOTALTAMOUNTET	,
REASONOFENDSERVICE	,
FLAGCEM	,
TOTALAMOUNTSERVICE	,
DATE_SITU	,
CODE_PAYS			
              )
        VALUES
              (
REC.TECH_ID	,
REC.CONTRACTREF	,
REC.SERVICEREF	,
REC.EXTERNALSERVICEID	,
REC.SERVICECODETYPE	,
REC.LABELSERVICE	,
REC.DATESTARTSERVICE	,
REC.DATEENDSERVICE	,
REC.DURATIONSERVICE	,
REC.DATERESILIATION	,
REC.NEXTPAYMENTAMOUNTET	,
REC.TOTALTAMOUNTET	,
REC.REASONOFENDSERVICE	,
REC.FLAGCEM	,
REC.TOTALAMOUNTSERVICE	,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_SERVICES 
          Set     	
                    CONTRACTREF	=	REC.CONTRACTREF	,
                    SERVICEREF	=	REC.SERVICEREF	,
                    EXTERNALSERVICEID	=	REC.EXTERNALSERVICEID	,
                    SERVICECODETYPE	=	REC.SERVICECODETYPE	,
                    LABELSERVICE	=	REC.LABELSERVICE	,
                    DATESTARTSERVICE	=	REC.DATESTARTSERVICE	,
                    DATEENDSERVICE	=	REC.DATEENDSERVICE	,
                    DURATIONSERVICE	=	REC.DURATIONSERVICE	,
                    DATERESILIATION	=	REC.DATERESILIATION	,
                    NEXTPAYMENTAMOUNTET	=	REC.NEXTPAYMENTAMOUNTET	,
                    TOTALTAMOUNTET	=	REC.TOTALTAMOUNTET	,
                    REASONOFENDSERVICE	=	REC.REASONOFENDSERVICE	,
                    FLAGCEM	=	REC.FLAGCEM	,
                    TOTALAMOUNTSERVICE	=	REC.TOTALAMOUNTSERVICE	,
                    DATE_SITU	=	p_date_trai		
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_SERVICES;


Function ALIM_MKTQASRS_SCHEDULES ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_SCHEDULES';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_SCHEDULES'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,	 
                              ACC_ACCOUNT_NUMBER as contractRef,
                              REP_INSTALMENT_NO as numberOfMonthlyPayment	,
                              REP_DUE_DATE as invoiceDate	,
                              REP_DUE_DATE as dateStartOfPeriodPayment	,
                              REP_DUE_DATE as dateEndOfPeriodPayment	,
                              REP_INSTALMENT_NO as duration	,
                              REP_INTEREST_AMT as interestAmount	,
                              REP_BILLFLAG as unpaidFlag	
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_REPAYMENT_DETAILS_MSTR RD
                    WHERE 
                    AC.ACC_ACCOUNT_NUMBER = RD.REP_CONTRACT_NUMBER
                    AND AC.ACC_COUNTRY_CODE = RD.REP_COUNTRY_CODE
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_SCHEDULES 
              (
TECH_ID	,
CONTRACTREF	,
NUMBEROFMONTHLYPAYMENT	,
INVOICEDATE	,
DATESTARTOFPERIODPAYMENT	,
DATEENDOFPERIODPAYMENT	,
DURATION	,
INTERESTAMOUNT	,
UNPAIDFLAG	,
DATE_SITU	,
CODE_PAYS				
              )
        VALUES
              (
REC.TECH_ID	,
REC.CONTRACTREF	,
REC.NUMBEROFMONTHLYPAYMENT	,
REC.INVOICEDATE	,
REC.DATESTARTOFPERIODPAYMENT	,
REC.DATEENDOFPERIODPAYMENT	,
REC.DURATION	,
REC.INTERESTAMOUNT	,
REC.UNPAIDFLAG	,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_SCHEDULES 
          Set     	
                    CONTRACTREF	=	REC.CONTRACTREF	,
                    NUMBEROFMONTHLYPAYMENT	=	REC.NUMBEROFMONTHLYPAYMENT	,
                    INVOICEDATE	=	REC.INVOICEDATE	,
                    DATESTARTOFPERIODPAYMENT	=	REC.DATESTARTOFPERIODPAYMENT	,
                    DATEENDOFPERIODPAYMENT	=	REC.DATEENDOFPERIODPAYMENT	,
                    DURATION	=	REC.DURATION	,
                    INTERESTAMOUNT	=	REC.INTERESTAMOUNT	,
                    UNPAIDFLAG	=	REC.UNPAIDFLAG	,
                    DATE_SITU	=	p_date_trai		
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_SCHEDULES;


Function ALIM_MKTQASRS_STAKEHOLDER ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_STAKEHOLDER';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_STAKEHOLDER'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,	 
                              ACC_ACCOUNT_NUMBER as contractRef,
                              'CUSTOMER' as stakeholderRole	,
                              CASE WHEN CUS_COUNTRY_CODE = 'DE' THEN to_char(CUS_CUSTOMER_ID) 
                              WHEN CUS_COUNTRY_CODE = 'FR' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE = 'I' THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE = 'I' AND CUS_CUSTOMER_ID IS NULL THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              END srcPartyId	,
                              CUS_COUNTRY_CODE as srcJvCode	,
                              'SRS' as srcAppCode1	,
                              ACC_DEALER_CODE as srcDealershipId	,
                              'SRS' as srcAppCode2		
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    AC.ACC_CUSTOMER_ID = CU.CUS_CUSTOMER_ID
                    AND AC.ACC_COUNTRY_CODE = CU.CUS_COUNTRY_CODE
                    AND AC.ACC_ACCOUNT_NUMBER = CU.CUS_CONTRACT_NUMBER
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_STAKEHOLDER 
              (
TECH_ID	,
CONTRACTREF	,
STAKEHOLDERROLE	,
SRCPARTYID	,
SRCJVCODE	,
SRCAPPCODE1	,
SRCDEALERSHIPID	,
SRCAPPCODE2	,
DATE_SITU	,
CODE_PAYS				
              )
        VALUES
              (
REC.TECH_ID	,
REC.CONTRACTREF	,
REC.STAKEHOLDERROLE	,
REC.SRCPARTYID	,
REC.SRCJVCODE	,
REC.SRCAPPCODE1	,
REC.SRCDEALERSHIPID	,
REC.SRCAPPCODE2	,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_STAKEHOLDER 
          Set     	
                    CONTRACTREF	=	REC.CONTRACTREF	,
                    STAKEHOLDERROLE	=	REC.STAKEHOLDERROLE	,
                    SRCPARTYID	=	REC.SRCPARTYID	,
                    SRCJVCODE	=	REC.SRCJVCODE	,
                    SRCAPPCODE1	=	REC.SRCAPPCODE1	,
                    SRCDEALERSHIPID	=	REC.SRCDEALERSHIPID	,
                    SRCAPPCODE2	=	REC.SRCAPPCODE2	,
                    DATE_SITU	=	p_date_trai		
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_STAKEHOLDER;


Function ALIM_MKTQASRS_STAKEHOLDER_ADRS ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_STAKEHOLDER_ADRS';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_STAKEHOLDER_ADRS'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              CUS_CONTRACT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              CUS_CUSTOMER_STREET_ADDRESS as numberAndStreet	,
                              CUS_CUSTOMER_POST_CODE as zipCode	,
                              CUS_CUSTOMER_CITY as city	,
                              CUS_CUSTOMER_PROVINCE as department		
                    FROM 
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    CU.CUS_COUNTRY_CODE = P_CODE_PAYS ;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_STAKEHOLDER_ADRS 
              (
TECH_ID	,
NUMBERANDSTREET	,
ZIPCODE	,
CITY	,
DEPARTMENT	,
CODE_PAYS	,
DATE_SITU				
              )
        VALUES
              (
REC.TECH_ID	,
REC.NUMBERANDSTREET	,
REC.ZIPCODE	,
REC.CITY	,
REC.DEPARTMENT	,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_STAKEHOLDER_ADRS 
          Set     	
                    NUMBERANDSTREET	=	REC.NUMBERANDSTREET	,
                    ZIPCODE	=	REC.ZIPCODE	,
                    CITY	=	REC.CITY	,
                    DEPARTMENT	=	REC.DEPARTMENT	,	
                    DATE_SITU	=	P_DATE_TRAI			
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_STAKEHOLDER_ADRS;

Function ALIM_MKTQASRS_AMENDMENT ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_AMENDMENT';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_AMENDMENT'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,	 
                              ACC_EXTRACT_DT as tech_dateExtraction	,
                              EXT_EXTENSION_SEQ_NUMBER as amendementRef	,
                              'EXTENSION' as typeCode	,
                              EXT_NEXT_DUE_DATE as applicationDate		
                              FROM 
                              MKTOV.MKTQT_ACCOUNT_MSTR AC,
                              MKTOV.MKTQT_EXTENSION_DETAIL_MSTR DM
                    WHERE 
                    AC.ACC_ACCOUNT_NUMBER = DM.EXT_CONTRACT_NUMBER
                    AND AC.ACC_COUNTRY_CODE = DM.EXT_COUNTRY_CODE
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_AMENDMENT 
              (
TECH_ID	,
TECH_DATEEXTRACTION	,
AMENDEMENTREF	,
TYPECODE	,
APPLICATIONDATE	,
DATE_SITU	,
CODE_PAYS					
              )
        VALUES
              (
REC.TECH_ID	,
REC.TECH_DATEEXTRACTION	,
REC.AMENDEMENTREF	,
REC.TYPECODE	,
REC.APPLICATIONDATE	,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_AMENDMENT 
          Set     	
                    TECH_DATEEXTRACTION	=	REC.TECH_DATEEXTRACTION	,
                    AMENDEMENTREF	=	REC.AMENDEMENTREF	,
                    TYPECODE	=	REC.TYPECODE	,
                    APPLICATIONDATE	=	REC.APPLICATIONDATE	,
                    DATE_SITU	=	p_date_trai				
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_AMENDMENT;


Function ALIM_MKTQASRS_AMENDMENT_EXTENS ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_AMENDMENT_EXTENS';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_AMENDMENT_EXTENSION'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              EXT_CONTRACT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              EXT_EXTENSION_TYPE as typeCode	,
                              EXT_FLAG_AUTOMATIC_EXTENSION as automaticFlag	,
                              EXT_ORIGINAL_TERM as previousDuration	,
                              EXT_NEW_TERM as newDuration	,
                              EXT_ORIGINAL_MILEAGE as previousMileage	,
                              EXT_NEW_MILEAGE as newMileage	,
                              EXT_ORIGINAL_RV_AMOUNT as previousRvAmount	,
                              EXT_NEW_RV_AMOUNT as newRvAmount	,
                              EXT_ORIGINAL_INTEREST_RATE as previousRate	,
                              EXT_NEW_INTEREST_RATE as newRate	,
                              EXT_ORIGINAL_MONTHLY_INSLMENT as previousRent	,
                              EXT_NEW_MONTHLY_INSTALLMENT as newRent	,
                              EXT_ORIGINAL_VAP_AMOUNT as previousServicemount	,
                              EXT_NEW_VAP_AMOUNT as newServiceAmount	,
                              EXT_EOT_EXTENSION_FEES as newAmountFees	,
                              EXT_OSB_AT_FORBEARANCE as newTotalOustanding	
                    FROM 
                    MKTOV.MKTQT_EXTENSION_DETAIL_MSTR
                    WHERE EXT_COUNTRY_CODE = P_CODE_PAYS;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_AMENDMENT_EXTENSION 
              (
TECH_ID	,
TYPECODE	,
AUTOMATICFLAG	,
PREVIOUSDURATION	,
NEWDURATION	,
PREVIOUSMILEAGE	,
NEWMILEAGE	,
PREVIOUSRVAMOUNT	,
NEWRVAMOUNT	,
PREVIOUSRATE	,
NEWRATE	,
PREVIOUSRENT	,
NEWRENT	,
PREVIOUSSERVICEMOUNT	,
NEWSERVICEAMOUNT	,
NEWAMOUNTFEES	,
NEWTOTALOUSTANDING	,
DATE_SITU	,
CODE_PAYS					
              )
        VALUES
              (
REC.TECH_ID	,
REC.TYPECODE	,
REC.AUTOMATICFLAG	,
REC.PREVIOUSDURATION	,
REC.NEWDURATION	,
REC.PREVIOUSMILEAGE	,
REC.NEWMILEAGE	,
REC.PREVIOUSRVAMOUNT	,
REC.NEWRVAMOUNT	,
REC.PREVIOUSRATE	,
REC.NEWRATE	,
REC.PREVIOUSRENT	,
REC.NEWRENT	,
REC.PREVIOUSSERVICEMOUNT	,
REC.NEWSERVICEAMOUNT	,
REC.NEWAMOUNTFEES	,
REC.NEWTOTALOUSTANDING	,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_AMENDMENT_EXTENSION 
          Set     	
                    TYPECODE	=	REC.TYPECODE	,
                    AUTOMATICFLAG	=	REC.AUTOMATICFLAG	,
                    PREVIOUSDURATION	=	REC.PREVIOUSDURATION	,
                    NEWDURATION	=	REC.NEWDURATION	,
                    PREVIOUSMILEAGE	=	REC.PREVIOUSMILEAGE	,
                    NEWMILEAGE	=	REC.NEWMILEAGE	,
                    PREVIOUSRVAMOUNT	=	REC.PREVIOUSRVAMOUNT	,
                    NEWRVAMOUNT	=	REC.NEWRVAMOUNT	,
                    PREVIOUSRATE	=	REC.PREVIOUSRATE	,
                    NEWRATE	=	REC.NEWRATE	,
                    PREVIOUSRENT	=	REC.PREVIOUSRENT	,
                    NEWRENT	=	REC.NEWRENT	,
                    PREVIOUSSERVICEMOUNT	=	REC.PREVIOUSSERVICEMOUNT	,
                    NEWSERVICEAMOUNT	=	REC.NEWSERVICEAMOUNT	,
                    NEWAMOUNTFEES	=	REC.NEWAMOUNTFEES	,
                    NEWTOTALOUSTANDING	=	REC.NEWTOTALOUSTANDING	,
                    DATE_SITU	=	p_date_trai					
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_AMENDMENT_EXTENS;


Function ALIM_MKTQASRS_SIGNATORY ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_SIGNATORY';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_SIGNATORY'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              CUS_CONTRACT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              CUS_CUSTOMER_NAME as name,
                              CUS_CUSTOMER_EMAIL_ADDRESS as email
                    FROM 
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    CU.CUS_COUNTRY_CODE = P_CODE_PAYS ;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_SIGNATORY 
              (
TECH_ID	,
NAME	,
EMAIL	,
DATE_SITU	,
CODE_PAYS					
              )
        VALUES
              (
REC.TECH_ID	,
REC.NAME	,
REC.EMAIL	,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_SIGNATORY 
          Set     	
                    NAME = REC.NAME	,
                    EMAIL = REC.EMAIL	,
                    DATE_SITU	=	p_date_trai				
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_SIGNATORY;

---------------------------------------------------------------------------------------------------
--                              Agreement 
---------------------------------------------------------------------------------------------------  

Function ALIM_MKTQASRS_AGREEMENT ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_AGREEMENT';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_AGREEMENT'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              FEE_CONTRACT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              FEE_CHARGE_DATE as tech_dateExtraction,
                              FEE_COUNTRY_CODE as countryBranchCode
                    FROM 
                    MKTOV.MKTQT_FEES_CHARGES_MSTR FE
                    WHERE  FE.FEE_COUNTRY_CODE = P_CODE_PAYS;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_AGREEMENT 
              (
TECH_ID,
TECH_DATEEXTRACTION,
COUNTRYBRANCHCODE,
DATE_SITU,
CODE_PAYS					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION,
REC.COUNTRYBRANCHCODE,
p_date_trai,
P_CODE_PAYS
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_AGREEMENT 
          Set     	
                    TECH_DATEEXTRACTION  = REC.TECH_DATEEXTRACTION,
                    COUNTRYBRANCHCODE = REC.COUNTRYBRANCHCODE,
                    DATE_SITU	=	p_date_trai				
          Where   tech_id	=	REC.tech_id	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_AGREEMENT;


Function ALIM_MKTQASRS_AGREEMENT_REQEST ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_AGREEMENT_REQEST';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_AGREEMENT_REQUEST'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id    ,
                              ACC_MAPS_NUMBER as requestRef 
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC
                    WHERE AC.ACC_COUNTRY_CODE = P_CODE_PAYS;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_AGREEMENT_REQUEST 
              (
TECH_ID,
REQUESTREF,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.REQUESTREF,
P_CODE_PAYS,
p_date_trai

);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_AGREEMENT_REQUEST 
          Set     	
                    REQUESTREF  = REC.REQUESTREF,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_AGREEMENT_REQEST;


Function ALIM_MKTQASRS_AGREEMENT_CONTRA ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_AGREEMENT_CONTRA';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_AGREEMENT_CONTRACT'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              FEE_CONTRACT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              FEE_CONTRACT_NUMBER as contractRef,
                              'SRS' as backOfficeOrigin
                    FROM 
                    MKTOV.MKTQT_FEES_CHARGES_MSTR FE
                    WHERE  FE.FEE_COUNTRY_CODE = P_CODE_PAYS;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_AGREEMENT_CONTRACT 
              (
TECH_ID,
CONTRACTREF,
BACKOFFICEORIGIN,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.CONTRACTREF,
REC.BACKOFFICEORIGIN,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_AGREEMENT_CONTRACT 
          Set     	
                    CONTRACTREF  = REC.CONTRACTREF,
                    BACKOFFICEORIGIN = REC.BACKOFFICEORIGIN,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_AGREEMENT_CONTRA;

Function ALIM_MKTQASRS_AGREEMENT_FEES ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_AGREEMENT_FEES';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_AGREEMENT_FEES'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              FEE_CONTRACT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              FEE_CHARGE_TYPE as feeType,
                              FEE_CHARGE_DESCRIPTION as feelabel,
                              FEE_VAP_ID as feeCode,
                              FEE_CHARGE_AMOUNT as invoicingAmount,
                              FEE_CHARGE_TRANSACTION_ID as transactionIdBackOffice,
                              FEE_CHARGE_DATE as lastInvoicingDate,
                              'true' as spreadFlag
                    FROM 
                    MKTOV.MKTQT_FEES_CHARGES_MSTR FE
                    WHERE  FE.FEE_COUNTRY_CODE = P_CODE_PAYS;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_AGREEMENT_FEES 
              (
TECH_ID,
FEETYPE,
FEELABEL,
FEECODE,
INVOICINGAMOUNT,
TRANSACTIONIDBACKOFFICE,
LASTINVOICINGDATE,
SPREADFLAG,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.FEETYPE,
REC.FEELABEL,
REC.FEECODE,
REC.INVOICINGAMOUNT,
REC.TRANSACTIONIDBACKOFFICE,
REC.LASTINVOICINGDATE,
REC.SPREADFLAG,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_AGREEMENT_FEES 
          Set     	
                    FEETYPE = REC.FEETYPE,
                    FEELABEL = REC.FEELABEL,
                    FEECODE = REC.FEECODE,
                    INVOICINGAMOUNT = REC.INVOICINGAMOUNT,
                    TRANSACTIONIDBACKOFFICE = REC.TRANSACTIONIDBACKOFFICE,
                    LASTINVOICINGDATE = REC.LASTINVOICINGDATE,
                    SPREADFLAG = REC.SPREADFLAG,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_AGREEMENT_FEES;

---------------------------------------------------------------------------------------------------
--                              CustomerProfile 
---------------------------------------------------------------------------------------------------  


Function ALIM_MKTQASRS_CUSTOMER_PROFILE ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUSTOMER_PROFILE';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUSTOMER_PROFILE'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              CUS_CONTRACT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              CUS_COUNTRY_CODE as countryBranchCode,
                              CASE WHEN CUS_COUNTRY_CODE = 'DE' THEN to_char(CUS_CUSTOMER_ID) 
                              WHEN CUS_COUNTRY_CODE = 'FR' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE = 'I' THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE = 'I' AND CUS_CUSTOMER_ID IS NULL THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              END srcJvCode,
                              'SRS' as srcAppCode,
                              'true' as isLeasco,
                              'false' as isFinco
                    FROM 
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    CU.CUS_COUNTRY_CODE = P_CODE_PAYS ;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_CUSTOMER_PROFILE 
              (
TECH_ID,
COUNTRYBRANCHCODE,
SRCJVCODE,
SRCAPPCODE,
ISLEASCO,
ISFINCO,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.COUNTRYBRANCHCODE,
REC.SRCJVCODE,
REC.SRCAPPCODE,
REC.ISLEASCO,
REC.ISFINCO,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUSTOMER_PROFILE 
          Set     	
                    COUNTRYBRANCHCODE = REC.COUNTRYBRANCHCODE,
                    SRCJVCODE = REC.SRCJVCODE,
                    SRCAPPCODE = REC.SRCAPPCODE,
                    ISLEASCO = REC.ISLEASCO,
                    ISFINCO = REC.ISFINCO,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_CUSTOMER_PROFILE;



Function ALIM_MKTQASRS_CUSTOMER_PRF_CTT ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUSTOMER_PRF_CTT';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUSTOMER_PROFILE_CTT'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              'CLIE' as stakeholderRole,
                              ACC_ACCOUNT_NUMBER as contractRef,
                              ACC_NPA_STATUS as accountStatus,
                              ACC_DEALER_CODE as dealershipRef,
                              ASS_VEHICLE_VIN_NUMBER as vehSerialNumber,
                              'true' as isLeasco,
                              'false' as isFinco,
                              'SRS' as backOfficeOrigin	
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_ASSET_MSTR ASS
                    WHERE 
                    AC.ACC_ASSET_ID = ASS.ASS_ASSET_ID
                    AND AC.ACC_COUNTRY_CODE = ASS.ASS_COUNTRY_CODE
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_CUSTOMER_PROFILE_CTT 
              (
TECH_ID,
STAKEHOLDERROLE,
CONTRACTREF,
ACCOUNTSTATUS,
DEALERSHIPREF,
VEHSERIALNUMBER,
ISLEASCO,
ISFINCO,
backOfficeOrigin,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.STAKEHOLDERROLE,
REC.CONTRACTREF,
REC.ACCOUNTSTATUS,
REC.DEALERSHIPREF,
REC.VEHSERIALNUMBER,
REC.ISLEASCO,
REC.ISFINCO,
REC.backOfficeOrigin,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUSTOMER_PROFILE_CTT 
          Set     	
                    STAKEHOLDERROLE = REC.STAKEHOLDERROLE,
                    CONTRACTREF = REC.CONTRACTREF,
                    ACCOUNTSTATUS = REC.ACCOUNTSTATUS,
                    DEALERSHIPREF = REC.DEALERSHIPREF,
                    VEHSERIALNUMBER =  REC.VEHSERIALNUMBER,
                    ISLEASCO = REC.ISLEASCO,
                    ISFINCO = REC.ISFINCO,
                    backOfficeOrigin = REC.backOfficeOrigin,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_CUSTOMER_PRF_CTT;


---------------------------------------------------------------------------------------------------
--                              Asset Vehicule 
--------------------------------------------------------------------------------------------------- 


Function ALIM_MKTQASRS_ASSET ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_ASSET';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_ASSET'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ACC_EXTRACT_DT as tech_dateExtraction,
                              ASS_COUNTRY_CODE as countryBranchCode	
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_ASSET_MSTR ASS
                    WHERE 
                    AC.ACC_ASSET_ID = ASS.ASS_ASSET_ID
                    AND AC.ACC_COUNTRY_CODE = ASS.ASS_COUNTRY_CODE
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;


 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_ASSET 
              (
TECH_ID,
TECH_DATEEXTRACTION,
COUNTRYBRANCHCODE,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION,
REC.COUNTRYBRANCHCODE,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_ASSET 
          Set     	
                    TECH_DATEEXTRACTION = REC.TECH_DATEEXTRACTION,
                    COUNTRYBRANCHCODE =REC.COUNTRYBRANCHCODE,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_ASSET;


Function ALIM_MKTQASRS_ASSET_VEHICULE ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_ASSET_VEHICULE';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_ASSET_VEHICULE'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ACC_EXTRACT_DT as tech_dateExtraction,
                              ASS_COUNTRY_CODE as countryBranchCode,
                              ASS_VEHICLE_VIN_NUMBER as serialNumber,
                              ASS_VEHICLE_MANUFACTURER_DESC as brandCode,
                              ASS_VEHICLE_MAKE_DESC as brandLabel,
                              NULL AS deliveryDate,
                              NULL AS registrationNumber,
                              ASS_FISCAL_ENGINE as fiscalHorsePower,
                              ASS_ASSET_CATEGORY as kindCode,
                              NVL(ASS_VEHICLE_ENERGY,ASS_VEHICLE_FUEL_TYPE_DESC) energyCode,
                              ASS_VEHICLE_CURRENT_MILEAGE as currentMileage,
                              'true' as isLeasco,
                              'false' as isFinco,
                              ACC_ACCOUNT_NUMBER as contractRef
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_ASSET_MSTR ASS
                    WHERE 
                    AC.ACC_ASSET_ID = ASS.ASS_ASSET_ID
                    AND AC.ACC_COUNTRY_CODE = ASS.ASS_COUNTRY_CODE
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_ASSET_VEHICULE 
              (
TECH_ID,
TECH_DATEEXTRACTION	,
COUNTRYBRANCHCODE	,
SERIALNUMBER	,
BRANDCODE	,
BRANDLABEL	,
DELIVERYDATE	,
REGISTRATIONNUMBER	,
FISCALHORSEPOWER	,
KINDCODE	,
ENERGYCODE	,
CURRENTMILEAGE	,
ISLEASCO	,
ISFINCO	,
CONTRACTREF	,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION	,
REC.COUNTRYBRANCHCODE	,
REC.SERIALNUMBER	,
REC.BRANDCODE	,
REC.BRANDLABEL	,
REC.DELIVERYDATE	,
REC.REGISTRATIONNUMBER	,
REC.FISCALHORSEPOWER	,
REC.KINDCODE	,
REC.ENERGYCODE	,
REC.CURRENTMILEAGE	,
REC.ISLEASCO	,
REC.ISFINCO	,
REC.CONTRACTREF	,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_ASSET_VEHICULE 
          Set     	
                    TECH_DATEEXTRACTION	=	REC.TECH_DATEEXTRACTION	,
                    COUNTRYBRANCHCODE	=	REC.COUNTRYBRANCHCODE	,
                    SERIALNUMBER	=	REC.SERIALNUMBER	,
                    BRANDCODE	=	REC.BRANDCODE	,
                    BRANDLABEL	=	REC.BRANDLABEL	,
                    DELIVERYDATE	=	REC.DELIVERYDATE	,
                    REGISTRATIONNUMBER	=	REC.REGISTRATIONNUMBER	,
                    FISCALHORSEPOWER	=	REC.FISCALHORSEPOWER	,
                    KINDCODE	=	REC.KINDCODE	,
                    ENERGYCODE	=	REC.ENERGYCODE	,
                    CURRENTMILEAGE	=	REC.CURRENTMILEAGE	,
                    ISLEASCO	=	REC.ISLEASCO	,
                    ISFINCO	=	REC.ISFINCO	,
                    CONTRACTREF	=	REC.CONTRACTREF	,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_ASSET_VEHICULE;


Function ALIM_MKTQASRS_ASSET_VEH_LABELS ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_ASSET_VEH_LABELS';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_ASSET_VEHICULE_LABELS'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ASS_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ASS_COUNTRY_CODE as languageCode,
                              ASS_VEHICLE_MODEL_DESC as versionLabelShort,
                              ASS_VEHICLE_VARIANTS_DESC as versionLabelLong

                    FROM
                    MKTOV.MKTQT_ASSET_MSTR ASS
                    WHERE ASS.ASS_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_ASSET_VEHICULE_LABELS 
              (
TECH_ID,
LANGUAGECODE,
VERSIONLABELSHORT,
VERSIONLABELLONG,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.LANGUAGECODE,
REC.VERSIONLABELSHORT,
REC.VERSIONLABELLONG,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_ASSET_VEHICULE_LABELS 
          Set     	
                    LANGUAGECODE = REC.LANGUAGECODE,
                    VERSIONLABELSHORT = REC.VERSIONLABELSHORT,
                    VERSIONLABELLONG = REC.VERSIONLABELLONG,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_ASSET_VEH_LABELS;


Function ALIM_MKTQASRS_ASSET_VEH_PRICE ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_ASSET_VEH_PRICE';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_VEHICULE_PRICING'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ASS_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ASS_SALEPRICETOCUSTOMER as amountET,
                              ASS_DEALER_FITTED_OPTIONMOUNT as optionsTotalAmountET,
                              ASS_ACCESSORIES as accessoriesTotalAmountET,
                              ASS_ECO_BONUS_AMOUNT as environmentalBonus
                    FROM
                    MKTOV.MKTQT_ASSET_MSTR ASS
                    WHERE ASS.ASS_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_VEHICULE_PRICING 
              (
TECH_ID,
AMOUNTET,
OPTIONSTOTALAMOUNTET,
ACCESSORIESTOTALAMOUNTET,
ENVIRONMENTALBONUS,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.AMOUNTET,
REC.OPTIONSTOTALAMOUNTET,
REC.ACCESSORIESTOTALAMOUNTET,
REC.ENVIRONMENTALBONUS,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_VEHICULE_PRICING 
          Set     	
                    AMOUNTET = REC.AMOUNTET,
                    OPTIONSTOTALAMOUNTET = REC.OPTIONSTOTALAMOUNTET,
                    ACCESSORIESTOTALAMOUNTET = REC.ACCESSORIESTOTALAMOUNTET,
                    ENVIRONMENTALBONUS = REC.ENVIRONMENTALBONUS,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_ASSET_VEH_PRICE;

Function ALIM_MKTQASRS_ASSET_VEH_BASEPR ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_ASSET_VEH_BASEPR';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_VEHICULE_BASEPRICE'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ASS_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ASS_VEHICLE_BASIC_PRICE as amountET,
                              ASS_VEHICLE_VAT_AMT as vatAmount

                    FROM
                    MKTOV.MKTQT_ASSET_MSTR ASS
                    WHERE ASS.ASS_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_VEHICULE_BASEPRICE 
              (
TECH_ID,
AMOUNTET,
VATAMOUNT,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.AMOUNTET,
REC.VATAMOUNT,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_VEHICULE_BASEPRICE 
          Set     	
                    AMOUNTET = REC.AMOUNTET,
                    VATAMOUNT = REC.VATAMOUNT,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_ASSET_VEH_BASEPR;

Function ALIM_MKTQASRS_ASSET_VEH_PR_DST ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_ASSET_VEH_PR_DST';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_VEHICULE_PRICE_DISCOUNT'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ASS_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              CASE WHEN NVL(ASS_SALES_CODE_DISCOUNT, '0') <> '0' THEN 'BRAND_DISCOUNT' END typeCode,
                              CASE WHEN NVL(ASS_SALES_CODE_DISCOUNT, '0') <> '0' THEN 'BRAND' END sourceCode,
                              ASS_SALES_CODE_DISCOUNT as amountET
                    FROM
                    MKTOV.MKTQT_ASSET_MSTR ASS
                    WHERE ASS.ASS_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_VEHICULE_PRICE_DISCOUNT 
              (
TECH_ID,
TYPECODE,
SOURCECODE,
AMOUNTET,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TYPECODE,
REC.SOURCECODE,
REC.AMOUNTET,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_VEHICULE_PRICE_DISCOUNT 
          Set     	
                    TYPECODE = REC.TYPECODE,
                    SOURCECODE = REC.SOURCECODE,
                    AMOUNTET = REC.AMOUNTET,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_ASSET_VEH_PR_DST;

Function ALIM_MKTQASRS_ASSET_VEH_LIFECY ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_ASSET_VEH_LIFECY';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_VEHICULE_LIFECYCLE'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ACC_EXTRACT_DT as tech_dateExtraction,
                              ASS_COUNTRY_CODE as countryBranchCode,
                              CASE WHEN NVL(ASS_VEHICLE_REGISTRATIONMBER,'O') <> '0'   THEN 'LEGAL' 
                              WHEN NVL(ASS_VEHICLE_CURRENT_MILEAGE,'0') <> '0' THEN 'MILEAGE' 
                              ELSE NULL END modificationType,
                              ASS_VEHICLE_VIN_NUMBER as serialNumber,
                              ASS_VEHICLE_REGISTRATIONMBER as registrationNumber,
                              ASS_VEHICLE_REGISTRATION_DT as dateRegistration,
                              ASS_VEHICLE_CURRENT_MILEAGE as currentMileage
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_ASSET_MSTR ASS
                    WHERE 
                    AC.ACC_ASSET_ID = ASS.ASS_ASSET_ID
                    AND AC.ACC_COUNTRY_CODE = ASS.ASS_COUNTRY_CODE
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_VEHICULE_LIFECYCLE 
              (
TECH_ID,
TECH_DATEEXTRACTION,
COUNTRYBRANCHCODE,
MODIFICATIONTYPE,
SERIALNUMBER,
REGISTRATIONNUMBER,
DATEREGISTRATION,
CURRENTMILEAGE,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION,
REC.COUNTRYBRANCHCODE,
REC.MODIFICATIONTYPE,
REC.SERIALNUMBER,
REC.REGISTRATIONNUMBER,
REC.DATEREGISTRATION,
REC.CURRENTMILEAGE,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_VEHICULE_LIFECYCLE 
          Set     	
                    TECH_DATEEXTRACTION = REC.TECH_DATEEXTRACTION,
                    COUNTRYBRANCHCODE = REC.COUNTRYBRANCHCODE,
                    MODIFICATIONTYPE = REC.MODIFICATIONTYPE,
                    SERIALNUMBER = REC.SERIALNUMBER,
                    REGISTRATIONNUMBER = REC.REGISTRATIONNUMBER,
                    DATEREGISTRATION = REC.DATEREGISTRATION,
                    CURRENTMILEAGE = REC.CURRENTMILEAGE,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_ASSET_VEH_LIFECY;

Function ALIM_MKTQASRS_ASSET_VEH_DOMREF ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_ASSET_VEH_DOMREF';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_VEHICULE_DOMAINREFS'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     NUMBER := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' as     tech_id,
                              ACC_EXTRACT_DT as tech_dateExtraction,
                              ASS_COUNTRY_CODE as countryBranchCode,
                              ASS_VEHICLE_VIN_NUMBER as serialNumber,
                              ASS_ACCOUNT_NUMBER as contractRef,
                              'SRS' as backOfficeOrigin,
                              CASE WHEN CUS_COUNTRY_CODE = 'DE' THEN to_char(CUS_CUSTOMER_ID) 
                              WHEN CUS_COUNTRY_CODE = 'FR' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE = 'I' THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE = 'I' AND CUS_CUSTOMER_ID IS NULL THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              END srcPartyId,
                              ASS_COUNTRY_CODE as srcJvCode,
                              'SRS' as srcAppCode,
                              ACC_CONTRACT_STATUS as stateCode
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_ASSET_MSTR ASS ,
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    AC.ACC_ASSET_ID = ASS.ASS_ASSET_ID
                    AND AC.ACC_COUNTRY_CODE = ASS.ASS_COUNTRY_CODE
                    AND AC.ACC_CUSTOMER_ID = CU.CUS_CUSTOMER_ID
                    AND AC.ACC_COUNTRY_CODE = CU.CUS_COUNTRY_CODE
                    AND AC.ACC_ACCOUNT_NUMBER = CU.CUS_CONTRACT_NUMBER
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS
                    AND ASS.ASS_VEHICLE_VIN_NUMBER is not null;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

        INSERT INTO MKTOV.MKTQT_VEHICULE_DOMAINREFS 
              (
TECH_ID,
TECH_DATEEXTRACTION,
COUNTRYBRANCHCODE,
SERIALNUMBER,
CONTRACTREF,
BACKOFFICEORIGIN,
SRCPARTYID,
SRCJVCODE,
SRCAPPCODE,
STATECODE,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION,
REC.COUNTRYBRANCHCODE,
REC.SERIALNUMBER,
REC.CONTRACTREF,
REC.BACKOFFICEORIGIN,
REC.SRCPARTYID,
REC.SRCJVCODE,
REC.SRCAPPCODE,
REC.STATECODE,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_VEHICULE_DOMAINREFS 
          Set     	
                    TECH_DATEEXTRACTION = REC.TECH_DATEEXTRACTION,
                    COUNTRYBRANCHCODE = REC.COUNTRYBRANCHCODE,
                    SERIALNUMBER = REC.SERIALNUMBER,
                    CONTRACTREF = REC.CONTRACTREF,
                    BACKOFFICEORIGIN = REC.BACKOFFICEORIGIN,
                    SRCPARTYID = REC.SRCPARTYID,
                    SRCJVCODE = REC.SRCJVCODE,
                    SRCAPPCODE = REC.SRCAPPCODE,
                    STATECODE = REC.STATECODE,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   End;
End ALIM_MKTQASRS_ASSET_VEH_DOMREF;


---------------------------------------------------------------------------------------------------
--                              Customer 
--------------------------------------------------------------------------------------------------- 


Function ALIM_MKTQASRS_CUSTOMER ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUSTOMER';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUSTOMER'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     number := 0;
  V_ISVATELIGIBLE VARCHAR2(10);

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' AS     TECH_ID,
                              ACC_EXTRACT_DT AS TECH_DATEEXTRACTION,
                              CUS_COUNTRY_CODE AS  COUNTRYBRANCHCODE,
                              CASE WHEN CUS_COUNTRY_CODE = 'DE' THEN TO_CHAR(CUS_CUSTOMER_ID) 
                              WHEN CUS_COUNTRY_CODE = 'FR' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE = 'I' THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE = 'I' AND CUS_CUSTOMER_ID IS NULL THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              END SRCPARTYID	,
                              CUS_COUNTRY_CODE AS  SRCJVCODE,
                              'SRS' AS  SRCAPPCODE,
                              CUS_COMPANY_SEGMENT AS  CUSTOMERTYPECODE,
                              CUS_CUSTOMER_LAST_UPDATE_DATE AS  LASTUPDATEPARTYDATE,
                              CUS_CUSTOMER_NAME AS  FULLNAME,
                              CUS_CUSTOMER_TYPE AS  LEGALENTITYIDENTIFIER,
                              CUS_CUSTOMER_TITLE AS  CIVILITYCODE,
                              CUS_CUSTOMER_FIRST_NAME AS  FIRSTNAME,
                              CUS_CUSTOMER_LAST_NAME AS  USAGENAME,
                              CUS_COUNTRY_CODE AS  FISCCOUNTRYCODE,
                              CUS_CUSTOMER_EMPLOYMENT_ITION AS  OCCUPATIONLABEL,
                              CUS_CUSTOMER_EMPLOYMENT_E_CODE AS  OCCUPATIONTYPECODE,
                              CUS_CUSTOMER_EMPLOYER AS  OCCUPATIONCOMPANYNAME,
                              CUS_GM_EMPLOYEE_FLAG AS  ISGROUPEMPLOYEE,
                              CUS_OCCUPATION_ENTITY AS  BUSINESSNAME, /* A VOIR */
                              CUS_OCCUPATION_ENTITY AS  COMPANYNAME,
                              CUS_INDUSTRY_GROUP AS  NACELABEL,
                              CUS_NUMBER_OF_EMPLOYEES AS  NBEMPLOYEES,
                              CUS_TOTAL_ASSETS AS  TOTALFLEET,
                              NULL AS  ISDEALER,  
                              --AS  ISVATELIGIBLE, IF SRCPARTYID IS NOT NULL THEN TRUE ELSE FALSE
                              ACC_AUTHORIZED_METHOD_OFILING AS  FLAGDEMATERIALIZATION,
                              'true' as  ISLEASCO,
                              'false' AS  ISFINCO
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    AC.ACC_CUSTOMER_ID = CU.CUS_CUSTOMER_ID
                    AND AC.ACC_COUNTRY_CODE = CU.CUS_COUNTRY_CODE
                    AND AC.ACC_ACCOUNT_NUMBER = CU.CUS_CONTRACT_NUMBER
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS;




 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;

         
        if REC.SRCPARTYID is not null then V_ISVATELIGIBLE := 'true'; else V_ISVATELIGIBLE := 'false'; end if;  
          

        INSERT INTO MKTOV.MKTQT_CUSTOMER 
              (
TECH_ID,
TECH_DATEEXTRACTION	,
COUNTRYBRANCHCODE	,
SRCPARTYID	,
SRCJVCODE	,
SRCAPPCODE	,
CUSTOMERTYPECODE	,
LASTUPDATEPARTYDATE	,
FULLNAME	,
LEGALENTITYIDENTIFIER	,
CIVILITYCODE	,
FIRSTNAME	,
USAGENAME	,
FISCCOUNTRYCODE	,
OCCUPATIONLABEL	,
OCCUPATIONTYPECODE	,
OCCUPATIONCOMPANYNAME	,
ISGROUPEMPLOYEE	,
BUSINESSNAME	,
COMPANYNAME	,
NACELABEL	,
NBEMPLOYEES	,
TOTALFLEET	,
ISDEALER	,
FLAGDEMATERIALIZATION	,
ISVATELIGIBLE ,
ISLEASCO	,
ISFINCO	,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION	,
REC.COUNTRYBRANCHCODE	,
REC.SRCPARTYID	,
REC.SRCJVCODE	,
REC.SRCAPPCODE	,
REC.CUSTOMERTYPECODE	,
REC.LASTUPDATEPARTYDATE	,
REC.FULLNAME	,
REC.LEGALENTITYIDENTIFIER	,
REC.CIVILITYCODE	,
REC.FIRSTNAME	,
REC.USAGENAME	,
REC.FISCCOUNTRYCODE	,
REC.OCCUPATIONLABEL	,
REC.OCCUPATIONTYPECODE	,
REC.OCCUPATIONCOMPANYNAME	,
REC.ISGROUPEMPLOYEE	,
REC.BUSINESSNAME	,
REC.COMPANYNAME	,
REC.NACELABEL	,
REC.NBEMPLOYEES	,
REC.TOTALFLEET	,
REC.ISDEALER	,
REC.FLAGDEMATERIALIZATION	,
V_ISVATELIGIBLE ,
REC.ISLEASCO	,
REC.ISFINCO	,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUSTOMER 
          Set     	
                    TECH_DATEEXTRACTION	=	REC.TECH_DATEEXTRACTION	,
                    COUNTRYBRANCHCODE	=	REC.COUNTRYBRANCHCODE	,
                    SRCPARTYID	=	REC.SRCPARTYID	,
                    SRCJVCODE	=	REC.SRCJVCODE	,
                    SRCAPPCODE	=	REC.SRCAPPCODE	,
                    CUSTOMERTYPECODE	=	REC.CUSTOMERTYPECODE	,
                    LASTUPDATEPARTYDATE	=	REC.LASTUPDATEPARTYDATE	,
                    FULLNAME	=	REC.FULLNAME	,
                    LEGALENTITYIDENTIFIER	=	REC.LEGALENTITYIDENTIFIER	,
                    CIVILITYCODE	=	REC.CIVILITYCODE	,
                    FIRSTNAME	=	REC.FIRSTNAME	,
                    USAGENAME	=	REC.USAGENAME	,
                    FISCCOUNTRYCODE	=	REC.FISCCOUNTRYCODE	,
                    OCCUPATIONLABEL	=	REC.OCCUPATIONLABEL	,
                    OCCUPATIONTYPECODE	=	REC.OCCUPATIONTYPECODE	,
                    OCCUPATIONCOMPANYNAME	=	REC.OCCUPATIONCOMPANYNAME	,
                    ISGROUPEMPLOYEE	=	REC.ISGROUPEMPLOYEE	,
                    BUSINESSNAME	=	REC.BUSINESSNAME	,
                    COMPANYNAME	=	REC.COMPANYNAME	,
                    NACELABEL	=	REC.NACELABEL	,
                    NBEMPLOYEES	=	REC.NBEMPLOYEES	,
                    TOTALFLEET	=	REC.TOTALFLEET	,
                    ISDEALER	=	REC.ISDEALER	,
                    FLAGDEMATERIALIZATION	=	REC.FLAGDEMATERIALIZATION	,
                    ISVATELIGIBLE = V_ISVATELIGIBLE ,
                    ISLEASCO	=	REC.ISLEASCO	,
                    ISFINCO	=	REC.ISFINCO	,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   END;
End ALIM_MKTQASRS_CUSTOMER;

Function ALIM_MKTQASRS_CUS_AGREEMENT ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUS_AGREEMENT';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUS_AGREEMENT'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     number := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' AS     TECH_ID,
                              ACC_EXTRACT_DT AS TECH_DATEEXTRACTION,
                              CUS_COUNTRY_CODE AS  COUNTRYBRANCHCODE,
                              CASE WHEN CUS_COUNTRY_CODE = 'DE' THEN TO_CHAR(CUS_CUSTOMER_ID) 
                              WHEN CUS_COUNTRY_CODE = 'FR' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE = 'I' THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE = 'I' AND CUS_CUSTOMER_ID IS NULL THEN CUS_FISCAL_CD
                              when CUS_COUNTRY_CODE in ('UK','GB') and CUS_CUSTOMER_TYPE <> 'I' then CUS_VAT_ACCOUNT_NUMBER
                              end SRCPARTYID,
                              CUS_COUNTRY_CODE as SRCJVCODE,
                              'SRS' as SRCAPPCODE,
                              CASE WHEN CUS_MARKETING_CONSENSUS = 'true' and decode(CUS_OPTIN_PHONE, 'N' ,'false' ,'Y','true' ,CUS_OPTIN_PHONE) = 'true' THEN 'true' ELSE 'false' END OPTOUTFLAG,
                              case when CUS_MARKETING_CONSENSUS = 'true' and DECODE(CUS_OPTIN_EMAIL, 'N' ,'false' ,'Y','true' ,CUS_OPTIN_EMAIL) = 'true' THEN 'true' ELSE 'false' END OPTINFLAG,
                              case when CUS_MARKETING_CONSENSUS = 'true' and DECODE(CUS_OPTIN_EMAIL, 'N' ,'false' ,'Y','true' ,CUS_TP_OPTIN_SMS) = 'true' THEN 'true' ELSE 'false' END OPTINCUSTOMERSMS,
                              CASE WHEN CUS_MARKETING_CONSENSUS = 'true' and decode(CUS_OPTIN_MAIL, 'N' ,'false' ,'Y','true' ,CUS_OPTIN_EMAIL) = 'true' THEN 'true' ELSE 'false' END OPTINCUSTOMERPAPER
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    AC.ACC_CUSTOMER_ID = CU.CUS_CUSTOMER_ID
                    AND AC.ACC_COUNTRY_CODE = CU.CUS_COUNTRY_CODE
                    and AC.ACC_ACCOUNT_NUMBER = CU.CUS_CONTRACT_NUMBER
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS;




 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;  
          

        INSERT INTO MKTOV.MKTQT_CUS_AGREEMENT 
              (
TECH_ID,
TECH_DATEEXTRACTION	,
COUNTRYBRANCHCODE	,
SRCPARTYID	,
SRCJVCODE	,
SRCAPPCODE	,
OPTOUTFLAG	,
OPTINFLAG	,
OPTINCUSTOMERSMS	,
OPTINCUSTOMERPAPER	,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION	,
REC.COUNTRYBRANCHCODE	,
REC.SRCPARTYID	,
REC.SRCJVCODE	,
REC.SRCAPPCODE	,
REC.OPTOUTFLAG	,
REC.OPTINFLAG	,
REC.OPTINCUSTOMERSMS	,
REC.OPTINCUSTOMERPAPER	,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUS_AGREEMENT 
          set     	
                    TECH_DATEEXTRACTION = REC.TECH_DATEEXTRACTION	,
                    COUNTRYBRANCHCODE = REC.COUNTRYBRANCHCODE	,
                    SRCPARTYID = REC.SRCPARTYID	,
                    SRCJVCODE = REC.SRCJVCODE	,
                    SRCAPPCODE = REC.SRCAPPCODE	,
                    OPTOUTFLAG = REC.OPTOUTFLAG	,
                    OPTINFLAG = REC.OPTINFLAG	,
                    OPTINCUSTOMERSMS = REC.OPTINCUSTOMERSMS	,
                    OPTINCUSTOMERPAPER = REC.OPTINCUSTOMERPAPER	,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   end;
End ALIM_MKTQASRS_CUS_AGREEMENT;

Function ALIM_MKTQASRS_CUS_PERS_CONTACT ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUS_PERS_CONTACT';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUS_PERSONCONTACTS'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     number := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' AS     TECH_ID,
                              ACC_EXTRACT_DT AS TECH_DATEEXTRACTION,
                              CASE WHEN CUS_COUNTRY_CODE = 'DE' THEN TO_CHAR(CUS_CUSTOMER_ID) 
                              WHEN CUS_COUNTRY_CODE = 'FR' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE = 'I' THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE = 'I' AND CUS_CUSTOMER_ID IS NULL THEN CUS_FISCAL_CD
                              when CUS_COUNTRY_CODE in ('UK','GB') and CUS_CUSTOMER_TYPE <> 'I' then CUS_VAT_ACCOUNT_NUMBER
                              end SRCPARTYID,
                              CUS_COUNTRY_CODE as SRCJVCODE,
                              'SRS' as SRCAPPCODE,
                              CUS_CUSTOMER_NAME as CONTACTNAME,
                              CUS_CUSTOMER_FIRST_NAME as CONTACTFIRSTNAME,
                              NULL as contactCivility /* a voir */
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    AC.ACC_CUSTOMER_ID = CU.CUS_CUSTOMER_ID
                    AND AC.ACC_COUNTRY_CODE = CU.CUS_COUNTRY_CODE
                    and AC.ACC_ACCOUNT_NUMBER = CU.CUS_CONTRACT_NUMBER
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;  
          

        INSERT INTO MKTOV.MKTQT_CUS_PERSONCONTACTS 
              (
TECH_ID,
TECH_DATEEXTRACTION ,
SRCPARTYID ,
SRCJVCODE ,
SRCAPPCODE ,
CONTACTNAME ,
CONTACTFIRSTNAME ,
CONTACTCIVILITY ,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION ,
REC.SRCPARTYID ,
REC.SRCJVCODE ,
REC.SRCAPPCODE ,
REC.CONTACTNAME ,
REC.CONTACTFIRSTNAME ,
REC.CONTACTCIVILITY ,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUS_PERSONCONTACTS 
          set     	
                    TECH_DATEEXTRACTION = REC.TECH_DATEEXTRACTION ,
                    SRCPARTYID = REC.SRCPARTYID ,
                    SRCJVCODE = REC.SRCJVCODE ,
                    SRCAPPCODE = REC.SRCAPPCODE ,
                    CONTACTNAME = REC.CONTACTNAME ,
                    CONTACTFIRSTNAME = REC.CONTACTFIRSTNAME ,
                    CONTACTCIVILITY = REC.CONTACTCIVILITY ,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   end;
end ALIM_MKTQASRS_CUS_PERS_CONTACT;

Function ALIM_MKTQASRS_CUS_ROLEBANKINGS ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUS_ROLEBANKINGS';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUS_ROLEBANKINGS'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     number := 0;

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' AS     TECH_ID,
                              ACC_EXTRACT_DT AS TECH_DATEEXTRACTION,
                              CASE WHEN CUS_COUNTRY_CODE = 'DE' THEN TO_CHAR(CUS_CUSTOMER_ID) 
                              WHEN CUS_COUNTRY_CODE = 'FR' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE = 'I' THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE = 'I' AND CUS_CUSTOMER_ID IS NULL THEN CUS_FISCAL_CD
                              when CUS_COUNTRY_CODE in ('UK','GB') and CUS_CUSTOMER_TYPE <> 'I' then CUS_VAT_ACCOUNT_NUMBER
                              end SRCPARTYID,
                              CUS_COUNTRY_CODE as SRCJVCODE,
                              'SRS' as SRCAPPCODE,
                              'CUSTOMER' as ROLEBANKINGCODE
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    AC.ACC_CUSTOMER_ID = CU.CUS_CUSTOMER_ID
                    AND AC.ACC_COUNTRY_CODE = CU.CUS_COUNTRY_CODE
                    and AC.ACC_ACCOUNT_NUMBER = CU.CUS_CONTRACT_NUMBER
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;  
          

        INSERT INTO MKTOV.MKTQT_CUS_ROLEBANKINGS 
              (
TECH_ID,
TECH_DATEEXTRACTION ,
SRCPARTYID ,
SRCJVCODE ,
SRCAPPCODE ,
ROLEBANKINGCODE,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION ,
REC.SRCPARTYID ,
REC.SRCJVCODE ,
REC.SRCAPPCODE ,
REC.ROLEBANKINGCODE,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUS_ROLEBANKINGS 
          set     	
                    TECH_DATEEXTRACTION = REC.TECH_DATEEXTRACTION ,
                    SRCPARTYID = REC.SRCPARTYID ,
                    SRCJVCODE = REC.SRCJVCODE ,
                    SRCAPPCODE = REC.SRCAPPCODE ,
                    ROLEBANKINGCODE = REC.ROLEBANKINGCODE,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   end;
end ALIM_MKTQASRS_CUS_ROLEBANKINGS;

Function ALIM_MKTQASRS_CUS_NATIONALID ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUS_NATIONALID';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUS_NATIONALIDENTIFIERS'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     number := 0;
  V_NATIONALIDENTIFIER VARCHAR2(30);

  Cursor c_mkt Is
                    SELECT
                              CUS_CONTRACT_NUMBER||P_CODE_PAYS||'SRS' AS     TECH_ID,
                              CASE WHEN CUS_COUNTRY_CODE = 'DE' THEN TO_CHAR(CUS_CUSTOMER_ID) 
                              WHEN CUS_COUNTRY_CODE = 'FR' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE = 'I' THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE = 'I' AND CUS_CUSTOMER_ID IS NULL THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              END SRCPARTYID,
                              CUS_COUNTRY_CODE as SRCJVCODE,
                              'SRS' as SRCAPPCODE,
                              --CASE WHEN CUS_CUSTOMER_TYPE = 'I' THEN CUS_VAT_ACCOUNT_NUMBER ELSE SRCPARTYID END NATIONALIDENTIFIER,
                              CUS_CUSTOMER_TYPE,
                              CUS_VAT_ACCOUNT_NUMBER,
                              CUS_COUNTRY_CODE||'_VAT_CD' as nationalIdentifierTypeCode
                    FROM 
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    CU.CUS_COUNTRY_CODE = P_CODE_PAYS;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;  
         
        IF  REC.CUS_CUSTOMER_TYPE = 'I' THEN V_NATIONALIDENTIFIER := REC.CUS_VAT_ACCOUNT_NUMBER; ELSE  V_NATIONALIDENTIFIER := REC.SRCPARTYID ; END IF;

        INSERT INTO MKTOV.MKTQT_CUS_NATIONALIDENTIFIERS 
              (
TECH_ID,
SRCPARTYID,
SRCJVCODE,
SRCAPPCODE,
NATIONALIDENTIFIERTYPECODE,
NATIONALIDENTIFIER,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.SRCPARTYID,
REC.SRCJVCODE,
REC.SRCAPPCODE,
REC.NATIONALIDENTIFIERTYPECODE,
V_NATIONALIDENTIFIER,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUS_NATIONALIDENTIFIERS 
          set     	
                    SRCPARTYID = REC.SRCPARTYID,
                    SRCJVCODE = REC.SRCJVCODE,
                    SRCAPPCODE = REC.SRCAPPCODE,
                    NATIONALIDENTIFIERTYPECODE = REC.NATIONALIDENTIFIERTYPECODE,
                    NATIONALIDENTIFIER = V_NATIONALIDENTIFIER,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   end;
end ALIM_MKTQASRS_CUS_NATIONALID;

Function ALIM_MKTQASRS_CUS_CONTACTMEAN ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUS_CONTACTMEAN';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUS_CONTACTMEAN'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     number := 0;
  V_NATIONALIDENTIFIER VARCHAR2(30);

  Cursor c_mkt Is
                    SELECT
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' AS     TECH_ID,
                              ACC_EXTRACT_DT as TECH_DATEEXTRACTION,
                              CUS_COUNTRY_CODE as COUNTRYBRANCHCODE ,
                              CASE WHEN CUS_COUNTRY_CODE = 'DE' THEN TO_CHAR(CUS_CUSTOMER_ID) 
                              WHEN CUS_COUNTRY_CODE = 'FR' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE = 'I' THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE = 'I' AND CUS_CUSTOMER_ID IS NULL THEN CUS_FISCAL_CD
                              when CUS_COUNTRY_CODE in ('UK','GB') and CUS_CUSTOMER_TYPE <> 'I' then CUS_VAT_ACCOUNT_NUMBER
                              end SRCPARTYID,
                              CUS_COUNTRY_CODE as SRCJVCODE,
                              'SRS' as SRCAPPCODE
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    AC.ACC_CUSTOMER_ID = CU.CUS_CUSTOMER_ID
                    AND AC.ACC_COUNTRY_CODE = CU.CUS_COUNTRY_CODE
                    and AC.ACC_ACCOUNT_NUMBER = CU.CUS_CONTRACT_NUMBER
                    AND AC.ACC_COUNTRY_CODE = P_CODE_PAYS;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;  
         
         
        INSERT INTO MKTOV.MKTQT_CUS_CONTACTMEAN 
              (
TECH_ID,
TECH_DATEEXTRACTION,
COUNTRYBRANCHCODE,
SRCPARTYID,
SRCJVCODE,
SRCAPPCODE,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION,
REC.COUNTRYBRANCHCODE,
REC.SRCPARTYID,
REC.SRCJVCODE,
REC.SRCAPPCODE,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUS_CONTACTMEAN 
          set     	
                    TECH_DATEEXTRACTION = REC.TECH_DATEEXTRACTION,
                    COUNTRYBRANCHCODE = REC.COUNTRYBRANCHCODE,
                    SRCPARTYID = REC.SRCPARTYID,
                    SRCJVCODE = REC.SRCJVCODE,
                    SRCAPPCODE = REC.SRCAPPCODE,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   end;
end ALIM_MKTQASRS_CUS_CONTACTMEAN;

Function ALIM_MKTQASRS_CUS_CTMEAN_ADRS ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUS_CTMEAN_ADRS';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUS_CONTACTMEAN_ADRS'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     number := 0;
  V_NATIONALIDENTIFIER VARCHAR2(30);

  Cursor c_mkt Is
                    select
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' AS     TECH_ID,
                              ACC_EXTRACT_DT as TECH_DATEEXTRACTION,
                              CUS_CUSTOMER_ADDRESS_TYPE as TYPEUSECODE,
                              CUS_CUSTOMER_STREET_ADDRESS as NUMBERANDSTREET,
                              CUS_CUSTOMER_ADDRESS2 as COMPLEMENT,
                              CUS_CUSTOMER_POST_CODE as ZIPCODE,
                              null as LOCALITY,
                              CUS_CUSTOMER_CITY as CITY,
                              CUS_ISO_CODE as COUNTRYCODE,
                              CUS_ISO_DESC as COUNTRYISO2,
                              'true' as ISLEASCO,
                              'false' as isFinco
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    AC.ACC_CUSTOMER_ID = CU.CUS_CUSTOMER_ID
                    AND AC.ACC_COUNTRY_CODE = CU.CUS_COUNTRY_CODE
                    and AC.ACC_ACCOUNT_NUMBER = CU.CUS_CONTRACT_NUMBER
                    and AC.ACC_COUNTRY_CODE = P_CODE_PAYS;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;  
         
         
        INSERT INTO MKTOV.MKTQT_CUS_CONTACTMEAN_ADRS 
              (
TECH_ID,
TECH_DATEEXTRACTION,
TYPEUSECODE,
NUMBERANDSTREET,
COMPLEMENT,
ZIPCODE,
LOCALITY,
CITY,
COUNTRYCODE,
COUNTRYISO2,
ISLEASCO,
ISFINCO,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION,
REC.TYPEUSECODE,
REC.NUMBERANDSTREET,
REC.COMPLEMENT,
REC.ZIPCODE,
REC.LOCALITY,
REC.CITY,
REC.COUNTRYCODE,
REC.COUNTRYISO2,
REC.ISLEASCO,
REC.ISFINCO,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUS_CONTACTMEAN_ADRS 
          set     	
                    TECH_DATEEXTRACTION = REC.TECH_DATEEXTRACTION,
                    TYPEUSECODE = REC.TYPEUSECODE,
                    NUMBERANDSTREET = REC.NUMBERANDSTREET,
                    COMPLEMENT = REC.COMPLEMENT,
                    ZIPCODE = REC.ZIPCODE,
                    LOCALITY = REC.LOCALITY,
                    CITY = REC.CITY,
                    COUNTRYCODE = REC.COUNTRYCODE,
                    COUNTRYISO2 = REC.COUNTRYISO2,
                    ISLEASCO = REC.ISLEASCO,
                    ISFINCO = REC.ISFINCO,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   end;
end ALIM_MKTQASRS_CUS_CTMEAN_ADRS;


Function ALIM_MKTQASRS_CUS_CTMEAN_PHONE ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUS_CTMEAN_PHONE';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUS_CONTACTMEAN_PHONES'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     number := 0;
  V_isBusinessUse VARCHAR2(30);

  Cursor c_mkt Is
                    select
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' AS     TECH_ID,
                              ACC_EXTRACT_DT as TECH_DATEEXTRACTION,
                              case when CUS_CUSTOMER_PHONE_LOCATION is not null then 'PER' 
                              when CUS_CUSTOMER_OFFICE_PHONE is not null then 'PRO'
                              end ASSIGNMENTCODE,
                              null as VALIDITYDATE,
                              NVL(CUS_CUSTOMER_PHONE_LOCATION,CUS_CUSTOMER_OFFICE_PHONE) as phoneNumber,
                              'true' as ISLEASCO,
                              'false' as isFinco
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    AC.ACC_CUSTOMER_ID = CU.CUS_CUSTOMER_ID
                    AND AC.ACC_COUNTRY_CODE = CU.CUS_COUNTRY_CODE
                    and AC.ACC_ACCOUNT_NUMBER = CU.CUS_CONTRACT_NUMBER
                    and AC.ACC_COUNTRY_CODE = P_CODE_PAYS;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;  
         
   IF rec.assignmentcode = 'PRO' then v_isBusinessUse := 'true'; end if;
         
        INSERT INTO MKTOV.MKTQT_CUS_CONTACTMEAN_PHONES 
              (
TECH_ID,
TECH_DATEEXTRACTION,
ASSIGNMENTCODE,
VALIDITYDATE,
PHONENUMBER,
ISBUSINESSUSE,
ISLEASCO,
ISFINCO,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION,
REC.ASSIGNMENTCODE,
REC.VALIDITYDATE,
REC.PHONENUMBER,
V_ISBUSINESSUSE,
REC.ISLEASCO,
REC.ISFINCO,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUS_CONTACTMEAN_PHONES 
          set     	
                    TECH_DATEEXTRACTION = REC.TECH_DATEEXTRACTION,
                    ASSIGNMENTCODE = REC.ASSIGNMENTCODE,
                    VALIDITYDATE = REC.VALIDITYDATE,
                    PHONENUMBER = REC.PHONENUMBER,
                    ISBUSINESSUSE = V_ISBUSINESSUSE,
                    ISLEASCO = REC.ISLEASCO,
                    ISFINCO = REC.ISFINCO,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   end;
end ALIM_MKTQASRS_CUS_CTMEAN_PHONE;

Function ALIM_MKTQASRS_CUS_CTMEAN_EMAIL ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUS_CTMEAN_EMAIL';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUS_CONTACTMEAN_EMAILS'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     number := 0;

  Cursor c_mkt Is
                    select
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' AS     TECH_ID,
                              ACC_EXTRACT_DT as TECH_DATEEXTRACTION,
                              null as VALIDITYDATE,
                              CUS_CUSTOMER_EMAIL_ADDRESS as email,
                              'true' as ISLEASCO,
                              'false' as isFinco
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    AC.ACC_CUSTOMER_ID = CU.CUS_CUSTOMER_ID
                    AND AC.ACC_COUNTRY_CODE = CU.CUS_COUNTRY_CODE
                    and AC.ACC_ACCOUNT_NUMBER = CU.CUS_CONTRACT_NUMBER
                    and AC.ACC_COUNTRY_CODE = P_CODE_PAYS;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;  
         
         
        INSERT INTO MKTOV.MKTQT_CUS_CONTACTMEAN_EMAILS 
              (
TECH_ID,
TECH_DATEEXTRACTION,
VALIDITYDATE,
EMAIL,
ISLEASCO,
ISFINCO,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION,
REC.VALIDITYDATE,
REC.EMAIL,
REC.ISLEASCO,
REC.ISFINCO,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUS_CONTACTMEAN_EMAILS 
          set     	
                    TECH_DATEEXTRACTION = REC.TECH_DATEEXTRACTION,
                    VALIDITYDATE = REC.VALIDITYDATE,
                    EMAIL = REC.EMAIL,
                    ISLEASCO = REC.ISLEASCO,
                    ISFINCO = REC.ISFINCO,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   end;
end ALIM_MKTQASRS_CUS_CTMEAN_EMAIL;

Function ALIM_MKTQASRS_CUS_CTMEAN_BKINF ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUS_CTMEAN_BKINF';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUS_CONTACTMEAN_BANKINFO'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     number := 0;

  Cursor c_mkt Is
                    select
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' AS     TECH_ID,
                              ACC_EXTRACT_DT as TECH_DATEEXTRACTION,
                              CASE WHEN CUS_COUNTRY_CODE = 'DE' THEN TO_CHAR(CUS_CUSTOMER_ID) 
                              WHEN CUS_COUNTRY_CODE = 'FR' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE = 'I' THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE = 'I' AND CUS_CUSTOMER_ID IS NULL THEN CUS_FISCAL_CD
                              when CUS_COUNTRY_CODE in ('UK','GB') and CUS_CUSTOMER_TYPE <> 'I' then CUS_VAT_ACCOUNT_NUMBER
                              end SRCPARTYID,
                              CUS_COUNTRY_CODE as SRCJVCODE,
                              'SRS' as SRCAPPCODE,
                              CUS_CUSTOMER_BANK_ACCOUNUMBER as BANKACCOUNTNUMBER,
                              CUS_CUSTOMER_BANK_BRANCHMBER as BANKNUMBER,
                              CUS_CUSTOMER_BANK_NAME as BANKNAME,
                              ACC_COSIF as sepaIban
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    AC.ACC_CUSTOMER_ID = CU.CUS_CUSTOMER_ID
                    AND AC.ACC_COUNTRY_CODE = CU.CUS_COUNTRY_CODE
                    and AC.ACC_ACCOUNT_NUMBER = CU.CUS_CONTRACT_NUMBER
                    and AC.ACC_COUNTRY_CODE = P_CODE_PAYS;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;  
         
         
        INSERT INTO MKTOV.MKTQT_CUS_CONTACTMEAN_BANKINFO 
              (
TECH_ID,
TECH_DATEEXTRACTION,
SRCPARTYID,
SRCJVCODE,
SRCAPPCODE,
BANKACCOUNTNUMBER,
BANKNUMBER,
BANKNAME,
SEPAIBAN,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION,
REC.SRCPARTYID,
REC.SRCJVCODE,
REC.SRCAPPCODE,
REC.BANKACCOUNTNUMBER,
REC.BANKNUMBER,
REC.BANKNAME,
REC.SEPAIBAN,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUS_CONTACTMEAN_BANKINFO 
          set     	
                    TECH_DATEEXTRACTION = REC.TECH_DATEEXTRACTION,
                    SRCPARTYID = REC.SRCPARTYID,
                    SRCJVCODE = REC.SRCJVCODE,
                    SRCAPPCODE = REC.SRCAPPCODE,
                    BANKACCOUNTNUMBER = REC.BANKACCOUNTNUMBER,
                    BANKNUMBER = REC.BANKNUMBER,
                    BANKNAME = REC.BANKNAME,
                    SEPAIBAN = REC.SEPAIBAN,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   end;
end ALIM_MKTQASRS_CUS_CTMEAN_BKINF;


Function ALIM_MKTQASRS_CUS_CTMEAN_CRREF ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUS_CTMEAN_CRREF';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUS_CONTACTMEAN_CROSSREF'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     number := 0;

  Cursor c_mkt Is
                    select
                              ACC_ACCOUNT_NUMBER||P_CODE_PAYS||'SRS' AS     TECH_ID,
                              ACC_EXTRACT_DT as TECH_DATEEXTRACTION,
                              CASE WHEN CUS_COUNTRY_CODE = 'DE' THEN TO_CHAR(CUS_CUSTOMER_ID) 
                              WHEN CUS_COUNTRY_CODE = 'FR' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE = 'I' THEN CUS_FISCAL_CD
                              WHEN CUS_COUNTRY_CODE = 'IT' AND CUS_CUSTOMER_TYPE <> 'I' THEN CUS_VAT_ACCOUNT_NUMBER
                              WHEN CUS_COUNTRY_CODE IN ('UK','GB') AND CUS_CUSTOMER_TYPE = 'I' AND CUS_CUSTOMER_ID IS NULL THEN CUS_FISCAL_CD
                              when CUS_COUNTRY_CODE in ('UK','GB') and CUS_CUSTOMER_TYPE <> 'I' then CUS_VAT_ACCOUNT_NUMBER
                              end SRCPARTYID,
                              CUS_COUNTRY_CODE as SRCJVCODE,
                              'SRS' as SRCAPPCODE
                    FROM 
                    MKTOV.MKTQT_ACCOUNT_MSTR AC,
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    WHERE 
                    AC.ACC_CUSTOMER_ID = CU.CUS_CUSTOMER_ID
                    AND AC.ACC_COUNTRY_CODE = CU.CUS_COUNTRY_CODE
                    and AC.ACC_ACCOUNT_NUMBER = CU.CUS_CONTRACT_NUMBER
                    and AC.ACC_COUNTRY_CODE = P_CODE_PAYS;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;  
         
         
        INSERT INTO MKTOV.MKTQT_CUS_CONTACTMEAN_CROSSREF 
              (
TECH_ID,
TECH_DATEEXTRACTION,
SRCPARTYID,
SRCJVCODE,
SRCAPPCODE,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.TECH_DATEEXTRACTION,
REC.SRCPARTYID,
REC.SRCJVCODE,
REC.SRCAPPCODE,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUS_CONTACTMEAN_CROSSREF 
          set     	
                    TECH_DATEEXTRACTION = REC.TECH_DATEEXTRACTION,
                    SRCPARTYID = REC.SRCPARTYID,
                    SRCJVCODE = REC.SRCJVCODE,
                    SRCAPPCODE = REC.SRCAPPCODE,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   end;
end ALIM_MKTQASRS_CUS_CTMEAN_CRREF;

Function ALIM_MKTQASRS_CUS_CTMEAN_EXREF ( Nomlog      Varchar2,
                            P_DATE_TRAI DATE ,
                            p_code_pays varchar2) Return Number IS

BEGIN
  DECLARE

  V_ERR   NUMBER := 0;
  V_INS   NUMBER := 0;
  V_UPD   NUMBER := 0;
  V_UPD_2 NUMBER := 0;
  V_FUNC VARCHAR2(30) := 'ALIM_MKTQASRS_CUS_CTMEAN_EXREF';    
  V_TAB1 VARCHAR2(40) := 'MKTOV.MKTQT_CUS_CONTACTMEAN_EXTREFS'; 
  V_TAB2 VARCHAR2(30) := 'SRS'; 
  FILE_ID UTL_FILE.FILE_TYPE;
  RES     number := 0;

  Cursor c_mkt Is
                    select
                              CUS_CONTRACT_NUMBER||P_CODE_PAYS||'SRS' as     TECH_ID,
                              'SRS' as APPLICATIONEXTCODE,
                              'OV SRS' as APPLICATIONEXTLABEL,
                              CUS_CUSTOMER_ID as  partyRefExt  
                    FROM 
                    MKTOV.MKTQT_CUSTOMER_MSTR CU
                    where 
                    CU.CUS_COUNTRY_CODE = P_CODE_PAYS;



 /*******************************************************************************/
  BEGIN

	File_Id := Mkt.Mktqaut.F_Open(Nomlog);
  Res := Mkt.Mktqaut.F_Write(File_Id, V_FUNC,'## Alimentation de la table '||V_TAB1||' ##');
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC,'## Flux '||V_TAB2||' ##');

  FOR REC IN c_mkt
  LOOP

       /*************************************************************************/
        BEGIN

        IF V_ERR=1 THEN EXIT;
        END IF;

        IF MOD(V_UPD + V_INS, 100)=0 THEN COMMIT;
        END IF;  
         
         
        INSERT INTO MKTOV.MKTQT_CUS_CONTACTMEAN_EXTREFS 
              (
TECH_ID,
APPLICATIONEXTCODE,
APPLICATIONEXTLABEL,
PARTYREFEXT,
CODE_PAYS,
DATE_SITU					
              )
        VALUES
              (
REC.TECH_ID,
REC.APPLICATIONEXTCODE,
REC.APPLICATIONEXTLABEL,
REC.PARTYREFEXT,
P_CODE_PAYS,
p_date_trai
);

        V_INS := V_INS + 1;

        EXCEPTION
          When Dup_Val_On_Index Then
          Update  MKTOV.MKTQT_CUS_CONTACTMEAN_EXTREFS 
          set     	
                    APPLICATIONEXTCODE = REC.APPLICATIONEXTCODE,
                    APPLICATIONEXTLABEL = REC.APPLICATIONEXTLABEL,
                    PARTYREFEXT = REC.PARTYREFEXT,
                    DATE_SITU	=	p_date_trai				
          Where   TECH_ID	=	REC.TECH_ID	
          AND     CODE_PAYS	=	P_CODE_PAYS;


                                        
          			V_UPD := V_UPD + 1;
        WHEN OTHERS THEN
				COMMIT;
				V_ERR := 1;
				Res := Mkt.Mktqaut.F_Write(File_Id,V_FUNC,'Message Erreur pl/sql :'||Sqlerrm);
      
        RETURN V_ERR;
        END;
   END LOOP;

   COMMIT;
   
   RES := MKT.MKTQAUT.F_WRITE(FILE_ID, V_FUNC ,'Nombre de mises a jour : '||TO_CHAR(V_UPD)||', d''insertions : '||TO_CHAR(V_INS));
   UTL_FILE.FCLOSE(FILE_ID);
   RETURN V_ERR;
   end;
end ALIM_MKTQASRS_CUS_CTMEAN_EXREF;


FUNCTION EXPORT_CONTRACT_JSON (NOMLOG varchar2,P_DATE_TRAI date, P_PATH VARCHAR2, P_CODE_PAYS VARCHAR2, P_FILENAME_CONTRAT VARCHAR2) return number IS
    V_ERR       number:=0;
    N_SAUV      NUMBER := 0;
    FILE_ID     UTL_FILE.FILE_TYPE;
    FILE_ID_CVS UTL_FILE.FILE_TYPE;
    V_LIGNE     VARCHAR2(4000);
    RES         NUMBER := 0;
    file_name   VARCHAR2(30);
    V_NB_ENREG  NUMBER(10) := 0;  
    V_NB_ENREG_TRAITE NUMBER(10) := 0;
    V_NB_FINANCING  NUMBER(10) := 0;
    V_NB_FINANCING_TRAITE  NUMBER(10) := 0;
    V_NB_SECURITIZATION NUMBER(10) := 0;
    V_NB_SECURITIZATION_TRAITE NUMBER(10) := 0;
    V_NB_ACCOUNT NUMBER(10) := 0;
    V_NB_ACCOUNT_TRAITE NUMBER(10) := 0;
    V_NB_PAYMEANACTIF NUMBER(10) := 0;
    V_NB_PAYMEANACTIF_TRAITE NUMBER(10) := 0;
    V_NB_VEHICULE NUMBER(10) := 0;
    V_NB_VEHICULE_TRAITE NUMBER(10) := 0;
    
    V_NB_AMOUNT NUMBER(10) := 0;
    V_NB_AMOUNT_TRAITE NUMBER(10) := 0;
    V_NB_ENDOFLIFE NUMBER(10) := 0;
    V_NB_ENDOFLIFE_TRAITE NUMBER(10) := 0;
    
    V_NB_SERVICES NUMBER(10) := 0;
    V_NB_SERVICES_TRAITE NUMBER(10) := 0;
    
    V_NB_SCHEDULES NUMBER(10) := 0;
    V_NB_SCHEDULES_TRAITE NUMBER(10) := 0;  
    
    V_NB_STAKEHOLDERS NUMBER(10) := 0;
    V_NB_STAKEHOLDERS_TRAITE NUMBER(10) := 0;
    
    V_NB_STAKEHOLDERS_ADRS NUMBER(10) := 0;
    V_NB_STAKEHOLDERS_ADRS_TRAITE NUMBER(10) := 0;
    
    V_NB_AMENDMENT NUMBER(10) := 0;
    V_NB_AMENDMENT_TRAITE NUMBER(10) := 0;
        
    V_NB_AMENDMENT_EXTEN NUMBER(10) := 0;
    V_NB_AMENDMENT_EXTEN_TRAITE NUMBER(10) := 0;
     
    V_NB_SIGNATORY NUMBER(10) := 0;
    V_NB_SIGNATORY_TRAITE NUMBER(10) := 0;  
   
   
   
    
CURSOR C_MKTQT_CONTRACT IS
SELECT 
TECH_ID AS TECH_ID,
TO_CHAR(TECH_DATEEXTRACTION,'YYYY-MM-DD') AS TECH_DATEEXTRACTION,
COUNTRYBRANCHCODE AS COUNTRYBRANCHCODE,
CONTRACTREF AS CONTRACTREF,
BACKOFFICEORIGIN AS BACKOFFICEORIGIN,
CONTRACTSTATUS AS CONTRACTSTATUS,
ACCOUNTSTATUS AS ACCOUNTSTATUS,
TO_CHAR(ACCOUNTSTATUSCHANGEDATE,'YYYY-MM-DD') AS ACCOUNTSTATUSCHANGEDATE,
TO_CHAR(ACTIVATIONDATE,'YYYY-MM-DD') AS ACTIVATIONDATE,
DURATIONCONTRACTINIT AS DURATIONCONTRACTINIT,
DURATIONCONTRACT AS DURATIONCONTRACT,
TO_CHAR(DATEENDCONTRACT,'YYYY-MM-DD') AS DATEENDCONTRACT,
TO_CHAR(REALDATEENDCONTRACT,'YYYY-MM-DD') AS REALDATEENDCONTRACT,
---ENDCONTRACTCODE AS ENDCONTRACTCODE,
---PRODUCTCATEGORYLABEL AS PRODUCTCATEGORYLABEL,
PRODUCTCATEGORYCODE AS PRODUCTCATEGORYCODE,
SELLERAGENCY AS SELLERAGENCY,
SALESMANFULLNAME AS SALESMANFULLNAME,
SALESMANCODE AS SALESMANCODE,
PRODUCTCODE AS PRODUCTCODE,
PRODUCTSUBCODE AS PRODUCTSUBCODE,
COMMERCIALPRODUCTCODE AS COMMERCIALPRODUCTCODE,
---FINANCIALPRODUCTLABEL AS FINANCIALPRODUCTLABEL,
---FINANCIALPRODUCTCODE AS FINANCIALPRODUCTCODE,
---OFFERREF AS OFFERREF,
---OFFERVERSION AS OFFERVERSION,
---STATECODE AS STATECODE,
TO_CHAR(DATEENDCONTRACTWHENRETURNED,'YYYY-MM-DD') AS DATEENDCONTRACTWHENRETURNED,
----STATUSCODEOFCASEFINALIZED AS STATUSCODEOFCASEFINALIZED,
----EARLYSETTLEMENTPOSSIBLEFLAG AS EARLYSETTLEMENTPOSSIBLEFLAG,
ISBUYBACKMAKE AS ISBUYBACKMAKE,
BUYBACKTYPE AS BUYBACKTYPE,
ISLEASCO AS ISLEASCO,
ISFINCO AS ISFINCO
FROM MKTOV.MKTQT_CONTRACT
WHERE COUNTRYBRANCHCODE = P_CODE_PAYS
;


CURSOR C_FINANCING (P_TECH_ID VARCHAR2) IS 
SELECT DISTINCT
----TECH_ID AS TECH_ID,
CONTRACTREF AS CONTRACTREF,
TOTALFINANCEDAMOUNTET AS TOTALFINANCEDAMOUNTET,
INITIALTOTALFINANCEDAMOUNTET AS INITIALTOTALFINANCEDAMOUNTET,
FIXEDASSETAMOUNTET AS FIXEDASSETAMOUNTET,
RESIDUALVALUEAMOUNTET AS RESIDUALVALUEAMOUNTET,
RESIDUALVALUEDEALERAMOUNTET AS RESIDUALVALUEDEALERAMOUNTET,
TO_CHAR(DATESTARTCONTRACT, 'YYYY-MM-DD') AS DATESTARTCONTRACT,
AMOUNTDEPOSIT AS AMOUNTDEPOSIT,
NUMBERUNPAID AS NUMBERUNPAID,
AMOUNTREMAININGCAPITAL AS AMOUNTREMAININGCAPITAL,
TO_CHAR(STARTDATEOFDUEDATE, 'YYYY-MM-DD') AS STARTDATEOFDUEDATE,
TO_CHAR(ENDDATEOFDUEDATE, 'YYYY-MM-DD') AS ENDDATEOFDUEDATE,
NOMINALRATE AS NOMINALRATE,
RATETYPE AS RATETYPE,
TAEGRATE AS TAEGRATE,
(CASE WHEN SUBSTR(TO_CHAR(COSTADDITIONALMILEAGE),1,1) = ',' THEN  REPLACE(TO_CHAR(COSTADDITIONALMILEAGE),',','0,') ELSE TO_CHAR(COSTADDITIONALMILEAGE) END)  AS COSTADDITIONALMILEAGE,
---Ltrim(rtrim(to_char(COSTADDITIONALMILEAGE, '9999999999990D999'),0),' ') AS COSTADDITIONALMILEAGE,
FIN_AMT_INIT_INTERST_OUTSERV AS FIN_AMT_INIT_INTERST_OUTSERV,
DATE_SITU AS DATE_SITU,
CODE_PAYS AS CODE_PAYS

FROM MKTOV.MKTQT_FINANCING
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_SECURITIZATION (P_TECH_ID VARCHAR2) IS 
SELECT DISTINCT
CONTRACTREF  AS CONTRACTREF,
DATESTART AS DATESTART,
ID AS ID,
ISSECURIZED AS ISSECURIZED

FROM  MKTOV.MKTQT_SECURITIZATION 
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_ACCOUNT (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
CONTRACTREF	AS CONTRACTREF	,
BALLOONVALUEAMOUNT	AS BALLOONVALUEAMOUNT	,
TO_CHAR(NEXTDUEDATE,'YYYY-MM-DD')	AS NEXTDUEDATE	,
NEXTRENTAMOUNTET	AS NEXTRENTAMOUNTET	,
NBPAYMENTNOTBILLED	AS NBPAYMENTNOTBILLED	,
LASTPAIDAMOUNTET	AS LASTPAIDAMOUNTET	,
AMOUNTFINANCIALINITRENTET	AS AMOUNTFINANCIALINITRENTET	,
AMOUNTFINANCIALRENTET	AS AMOUNTFINANCIALRENTET	,
AMOUNTFINANCIALRENTWITHSERVIT	AS AMOUNTFINANCIALRENTWITHSERVIT	,
DAYOFPAYMENT	AS DAYOFPAYMENT	,
PERIODICITY	AS PERIODICITY	,
(CASE WHEN SUBSTR(TO_CHAR(CHARGEAMOUNTET),1,1) = ',' THEN REPLACE(TO_CHAR(CHARGEAMOUNTET),',','0,') ELSE TO_CHAR(CHARGEAMOUNTET)  END)	AS CHARGEAMOUNTET	

FROM MKTOV.MKTQT_ACCOUNT 
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_PAYMEANACTIF (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TECH_ID  AS TECH_ID ,
CONTRACTREF  AS CONTRACTREF ,
PAYMENTTYPECODE  AS PAYMENTTYPECODE ,
BANKAGENCY  AS BANKAGENCY ,
BANKACCOUNTNUMBER  AS BANKACCOUNTNUMBER ,
BANKACCOUNTKEY  AS BANKACCOUNTKEY ,
BANKNUMBER  AS BANKNUMBER ,
BANKNAME  AS BANKNAME ,
SEPAIBAN  AS SEPAIBAN 

FROM MKTOV.MKTQT_CPAYMEANACTIF 
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_VEHICULE (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION,'YYYY-MM-DD')	AS TECH_DATEEXTRACTION	,
CONTRACTREF	AS CONTRACTREF	,
SERIALNUMBER	AS SERIALNUMBER	,
DELIVERYDATE	AS DELIVERYDATE	,
TO_CHAR(EXPECTEDRETURNDATE,'YYYY-MM-DD')	AS EXPECTEDRETURNDATE	,
STATECODE	AS STATECODE	,
USAGECODE	AS USAGECODE	,
CONTACTUALMILEAGE	AS CONTACTUALMILEAGE	

FROM MKTOV.MKTQT_CVEHICULE
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_VEHICULE_AMT (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
SELLERPRICEIT AS SELLERPRICEIT,
(CASE WHEN SUBSTR(TO_CHAR(EXCESSMILEAGERATE),1,1)=',' THEN  REPLACE(TO_CHAR(EXCESSMILEAGERATE),',','0,') ELSE  TO_CHAR(EXCESSMILEAGERATE) END) AS EXCESSMILEAGERATE,
(CASE WHEN SUBSTR(TO_CHAR(UNDERMILEAGERATE),1,1)=',' THEN  REPLACE(TO_CHAR(UNDERMILEAGERATE),',','0,') ELSE  TO_CHAR(UNDERMILEAGERATE) END) AS UNDERMILEAGERATE

FROM MKTOV.MKTQT_VEHICULE_AMT 
WHERE TECH_ID = P_TECH_ID
;



CURSOR C_VEHICULE_ENDOFLIFE (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
CONTACTENDOFLIFEDATE	AS CONTACTENDOFLIFEDATE	,
(CASE WHEN EARLYTERMINATIONFLAG = 'Y' THEN 'true' WHEN EARLYTERMINATIONFLAG = 'N' THEN 'false' ELSE NULL END) AS EARLYTERMINATIONFLAG	,
DEALERRETURNDATE	AS DEALERRETURNDATE	,
CHOICECUSTOMERRETURNDATE	AS CHOICECUSTOMERRETURNDATE	,
REALRETURNDATE	AS REALRETURNDATE	,
CONTACTEMAILCUSTOMERFLAG	AS CONTACTEMAILCUSTOMERFLAG	,
CONTACTEMAILCUSTOMERDATE	AS CONTACTEMAILCUSTOMERDATE	,
CONTACTPHONECUSTOMERFLAG	AS CONTACTPHONECUSTOMERFLAG	,
CONTACTPHONECUSTOMERDATE	AS CONTACTPHONECUSTOMERDATE	,
RESALEDEALERFLAG	AS RESALEDEALERFLAG	,
RESALECUSTOMERFLAG	AS RESALECUSTOMERFLAG	,
MILEAGEENDOFLIFE	AS MILEAGEENDOFLIFE	,
REFURBISHMENT	AS REFURBISHMENT	,
BUYERDEALERNAME	AS BUYERDEALERNAME	,
BUYERDEALERCITY	AS BUYERDEALERCITY	

FROM  MKTOV.MKTQT_VEHICULE_ENDOFLIFE
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_SERVICES (P_TECH_ID VARCHAR2)   IS
SELECT DISTINCT
CONTRACTREF	AS CONTRACTREF	,
SERVICEREF	AS SERVICEREF	,
EXTERNALSERVICEID	AS EXTERNALSERVICEID	,
SERVICECODETYPE	AS SERVICECODETYPE	,
LABELSERVICE	AS LABELSERVICE	,
TO_CHAR(DATESTARTSERVICE, 'YYYY-MM-DD')	AS DATESTARTSERVICE	,
TO_CHAR(DATEENDSERVICE, 'YYYY-MM-DD')	AS DATEENDSERVICE	,
DURATIONSERVICE	AS DURATIONSERVICE	,
DATERESILIATION	AS DATERESILIATION	,
NEXTPAYMENTAMOUNTET	AS NEXTPAYMENTAMOUNTET	,
TOTALTAMOUNTET	AS TOTALTAMOUNTET	,
REASONOFENDSERVICE	AS REASONOFENDSERVICE	,
FLAGCEM	AS FLAGCEM	,
TOTALAMOUNTSERVICE	AS TOTALAMOUNTSERVICE	

FROM MKTOV.MKTQT_SERVICES
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_SCHEDULES (P_TECH_ID VARCHAR2)   IS
SELECT DISTINCT
CONTRACTREF	AS CONTRACTREF	,
NUMBEROFMONTHLYPAYMENT	AS NUMBEROFMONTHLYPAYMENT	,
TO_CHAR(INVOICEDATE, 'YYYY-MM-DD')	AS INVOICEDATE	,
TO_CHAR(DATESTARTOFPERIODPAYMENT, 'YYYY-MM-DD')  AS DATESTARTOFPERIODPAYMENT	,
TO_CHAR(DATEENDOFPERIODPAYMENT, 'YYYY-MM-DD')	AS DATEENDOFPERIODPAYMENT	,
DURATION	AS DURATION	,
INTERESTAMOUNT	AS INTERESTAMOUNT	,
(CASE WHEN UNPAIDFLAG = 'Y' THEN 'true' WHEN  UNPAIDFLAG = 'N' THEN 'false' ELSE NULL END)	AS UNPAIDFLAG	

FROM MKTOV.MKTQT_SCHEDULES
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_STAKEHOLDERS (P_TECH_ID VARCHAR2)   IS
SELECT DISTINCT
CONTRACTREF	AS CONTRACTREF	,
STAKEHOLDERROLE	AS STAKEHOLDERROLE	,
SRCPARTYID	AS SRCPARTYID	,
SRCJVCODE	AS SRCJVCODE	,
SRCAPPCODE1	AS SRCAPPCODE1	,
SRCDEALERSHIPID	AS SRCDEALERSHIPID	,
SRCAPPCODE2	AS SRCAPPCODE2	

FROM MKTOV.MKTQT_STAKEHOLDERS
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_STAKEHOLDERS_ADRS (P_TECH_ID VARCHAR2)   IS
SELECT DISTINCT
NUMBERANDSTREET AS NUMBERANDSTREET	,
ZIPCODE	AS ZIPCODE	,
CITY	AS CITY	,
DEPARTMENT	AS DEPARTMENT	

FROM MKTOV.MKTQT_STAKEHOLDER_ADRS
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_AMENDMENT (P_TECH_ID VARCHAR2)   IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION, 'YYYY-MM-DD')	AS TECH_DATEEXTRACTION	,
AMENDEMENTREF	AS AMENDEMENTREF	,
TYPECODE	AS TYPECODE	,
TO_CHAR(APPLICATIONDATE,'YYYY-MM-DD')	AS APPLICATIONDATE	

FROM MKTOV.MKTQT_AMENDMENT
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_AMENDMENT_EXTEN (P_TECH_ID VARCHAR2)   IS
SELECT DISTINCT
TYPECODE	AS TYPECODE	,
(CASE WHEN AUTOMATICFLAG = 'Y' THEN 'true' WHEN AUTOMATICFLAG = 'N' THEN 'false' ELSE AUTOMATICFLAG END) AS AUTOMATICFLAG	,
PREVIOUSDURATION	AS PREVIOUSDURATION	,
NEWDURATION	AS NEWDURATION	,
PREVIOUSMILEAGE	AS PREVIOUSMILEAGE	,
NEWMILEAGE	AS NEWMILEAGE	,
PREVIOUSRVAMOUNT	AS PREVIOUSRVAMOUNT	,
NEWRVAMOUNT	AS NEWRVAMOUNT	,

(CASE WHEN SUBSTR(TO_CHAR(PREVIOUSRATE),1,1)=',' THEN  REPLACE(REPLACE(TO_CHAR(PREVIOUSRATE),',','0,'),',','.') ELSE  REPLACE(TO_CHAR(PREVIOUSRATE),',','.') END) AS PREVIOUSRATE,
(CASE WHEN SUBSTR(TO_CHAR(NEWRATE),1,1)=',' THEN  REPLACE(TO_CHAR(NEWRATE),',','0,') ELSE  REPLACE(TO_CHAR(NEWRATE),',','.') END) AS NEWRATE,
---PREVIOUSRATE	AS PREVIOUSRATE	,
---NEWRATE	AS NEWRATE	,

PREVIOUSRENT	AS PREVIOUSRENT	,
NEWRENT	AS NEWRENT	,

(CASE WHEN SUBSTR(TO_CHAR(PREVIOUSSERVICEMOUNT),1,1)=',' THEN  REPLACE(REPLACE(TO_CHAR(PREVIOUSSERVICEMOUNT),',','0,'),',','.') ELSE  REPLACE(TO_CHAR(PREVIOUSSERVICEMOUNT),',','.') END) AS PREVIOUSSERVICEMOUNT,
(CASE WHEN SUBSTR(TO_CHAR(NEWSERVICEAMOUNT),1,1)=',' THEN  REPLACE(REPLACE(TO_CHAR(NEWSERVICEAMOUNT),',','0,'),',','.') ELSE  REPLACE(TO_CHAR(NEWSERVICEAMOUNT),',','.') END) AS NEWSERVICEAMOUNT,
---PREVIOUSSERVICEMOUNT	AS PREVIOUSSERVICEMOUNT	,
---NEWSERVICEAMOUNT	AS NEWSERVICEAMOUNT	,

NEWAMOUNTFEES	AS NEWAMOUNTFEES	,
NEWTOTALOUSTANDING	AS NEWTOTALOUSTANDING	

FROM MKTOV.MKTQT_AMENDMENT_EXTENSION
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_SIGNATORY (P_TECH_ID VARCHAR2)   IS
SELECT DISTINCT
NAME AS NAME,
EMAIL AS EMAIL
FROM MKTOV.MKTQT_SIGNATORY
WHERE TECH_ID = P_TECH_ID
;



BEGIN
  file_name := P_FILENAME_CONTRAT;
  FILE_ID := MKT.MKTQAUT.F_OPEN(NOMLOG);
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, 'EXPORT_CONTRACT_JSON', ' ## EXPORT CONTRACT JSON' ||  ' ##');
  file_id_cvs:= MKT.MKTQAUT.F_OPEN_CVS_UTF8(p_path,file_name);


  BEGIN 
       SELECT COUNT(*)
       INTO   V_NB_ENREG
       FROM   MKTOV.MKTQT_CONTRACT
       WHERE  COUNTRYBRANCHCODE = P_CODE_PAYS;
  EXCEPTION WHEN OTHERS THEN
       V_NB_ENREG := 0;
  END;

      V_LIGNE := '[';
      res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
      
      FOR S_MKTQT_CONTRACT IN C_MKTQT_CONTRACT LOOP
       
      BEGIN
         V_NB_ENREG_TRAITE := V_NB_ENREG_TRAITE +1;
        V_NB_FINANCING_TRAITE   := 0;
        V_NB_SECURITIZATION_TRAITE  := 0;
        V_NB_ACCOUNT_TRAITE  := 0; 
        V_NB_PAYMEANACTIF_TRAITE  := 0;
        V_NB_VEHICULE_TRAITE  := 0;
        --V_NB_AMOUNT_TRAITE  := 0;
        --V_NB_ENDOFLIFE_TRAITE  := 0;
        V_NB_SERVICES_TRAITE  := 0;
        V_NB_SCHEDULES_TRAITE  := 0;  
        V_NB_STAKEHOLDERS_TRAITE  := 0;  
        --V_NB_STAKEHOLDERS_ADRS_TRAITE  := 0;    
        V_NB_AMENDMENT_TRAITE  := 0;  
        --V_NB_AMENDMENT_EXTEN_TRAITE  := 0;
        --V_NB_SIGNATORY_TRAITE  := 0;  
                
         
              V_LIGNE := '{
"tech_id":"' || S_MKTQT_CONTRACT.TECH_ID  || '",
"tech_dateExtraction":"' || S_MKTQT_CONTRACT.TECH_DATEEXTRACTION  || '",
"countryBranchCode":"' || S_MKTQT_CONTRACT.COUNTRYBRANCHCODE  || '",
"contractRef":"' || S_MKTQT_CONTRACT.CONTRACTREF  || '",
"backOfficeOrigin":"' || S_MKTQT_CONTRACT.BACKOFFICEORIGIN  || '",
"contractStatus":"' || S_MKTQT_CONTRACT.CONTRACTSTATUS  || '",
"accountStatus":"' || S_MKTQT_CONTRACT.ACCOUNTSTATUS  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

IF S_MKTQT_CONTRACT.ACCOUNTSTATUSCHANGEDATE IS NOT NULL THEN
V_LIGNE := '"accountStatusChangeDate":"' || S_MKTQT_CONTRACT.ACCOUNTSTATUSCHANGEDATE  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

V_LIGNE := '"activationDate":"' || S_MKTQT_CONTRACT.ACTIVATIONDATE  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

IF INSTR(S_MKTQT_CONTRACT.DURATIONCONTRACTINIT,'.') = 0  THEN
V_LIGNE := '"durationContractInit":' || REPLACE(S_MKTQT_CONTRACT.DURATIONCONTRACTINIT,',','.')  || ',';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;


V_LIGNE := '"durationContract":' || REPLACE(S_MKTQT_CONTRACT.DURATIONCONTRACT,',','.')  || ',
"dateEndContract":"' || S_MKTQT_CONTRACT.DATEENDCONTRACT  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

IF S_MKTQT_CONTRACT.REALDATEENDCONTRACT IS NOT NULL THEN
V_LIGNE := '"realDateEndContract":"' || S_MKTQT_CONTRACT.REALDATEENDCONTRACT  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

/*IF S_MKTQT_CONTRACT.ENDCONTRACTCODE IS NOT NULL THEN
V_LIGNE := '"ENDCONTRACTCODE":"' || S_MKTQT_CONTRACT.ENDCONTRACTCODE  || '",';
'"PRODUCTCATEGORYLABEL":"' || S_MKTQT_CONTRACT.PRODUCTCATEGORYLABEL  || '",
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;*/

V_LIGNE := '"productCategoryCode":"' || S_MKTQT_CONTRACT.PRODUCTCATEGORYCODE  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

IF S_MKTQT_CONTRACT.SELLERAGENCY IS NOT NULL  THEN
V_LIGNE := '"sellerAgency":"' || S_MKTQT_CONTRACT.SELLERAGENCY  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

IF S_MKTQT_CONTRACT.SALESMANFULLNAME IS NOT NULL THEN
V_LIGNE := '"salesmanFullName":"' || REPLACE(S_MKTQT_CONTRACT.SALESMANFULLNAME,'"','')  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

IF S_MKTQT_CONTRACT.SALESMANCODE IS NOT NULL THEN
V_LIGNE := '"salesmanCode":"' || S_MKTQT_CONTRACT.SALESMANCODE  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;


V_LIGNE := '"productCode":"' || S_MKTQT_CONTRACT.PRODUCTCODE  || '",
"productSubCode":"' || S_MKTQT_CONTRACT.PRODUCTSUBCODE  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

IF S_MKTQT_CONTRACT.COMMERCIALPRODUCTCODE IS NOT NULL THEN
V_LIGNE := '"commercialProductLabel":"' || S_MKTQT_CONTRACT.COMMERCIALPRODUCTCODE  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

/*V_LIGNE := '"FINANCIALPRODUCTLABEL":"' || S_MKTQT_CONTRACT.FINANCIALPRODUCTLABEL  || '",
"FINANCIALPRODUCTCODE":"' || S_MKTQT_CONTRACT.FINANCIALPRODUCTCODE  || '",
"OFFERREF":"' || S_MKTQT_CONTRACT.OFFERREF  || '",
"OFFERVERSION":"' || S_MKTQT_CONTRACT.OFFERVERSION  || '",
"STATECODE":"' || S_MKTQT_CONTRACT.STATECODE  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);*/

IF S_MKTQT_CONTRACT.DATEENDCONTRACTWHENRETURNED IS NOT NULL THEN
V_LIGNE := '"dateEndContractWhenReturned":"' || S_MKTQT_CONTRACT.DATEENDCONTRACTWHENRETURNED  || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

/*
IF S_MKTQT_CONTRACT.STATUSCODEOFCASEFINALIZED IS NOT NULL THEN
V_LIGNE := '"STATUSCODEOFCASEFINALIZED":"' || S_MKTQT_CONTRACT.STATUSCODEOFCASEFINALIZED  || '",';
"EARLYSETTLEMENTPOSSIBLEFLAG":' || S_MKTQT_CONTRACT.EARLYSETTLEMENTPOSSIBLEFLAG  || ',
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;*/


V_LIGNE := '"isBuyBackMake":' || S_MKTQT_CONTRACT.ISBUYBACKMAKE  || ',
"buyBackType":"' || S_MKTQT_CONTRACT.BUYBACKTYPE  || '",
"isLeasco":' || S_MKTQT_CONTRACT.ISLEASCO  || ',
"isFinco":' || S_MKTQT_CONTRACT.ISFINCO  || ',';    ---- 

res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

    -----------------------------------FINANCING-----------------------------

    BEGIN
         SELECT COUNT(*)
         INTO V_NB_FINANCING
         FROM MKTOV.MKTQT_FINANCING
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_FINANCING := NULL;
    END;

     FOR S_FINANCING IN C_FINANCING (S_MKTQT_CONTRACT.TECH_ID) LOOP
            V_NB_FINANCING_TRAITE := V_NB_FINANCING_TRAITE+1;   ---- A REVOIR 
            
            
            V_LIGNE := '"financing":{
                "contractRef":"' || S_FINANCING.CONTRACTREF || '",
                "totalFinancedAmountET":' || REPLACE(S_FINANCING.TOTALFINANCEDAMOUNTET,',','.') || ',
                "initialTotalFinancedAmountET":' || REPLACE(S_FINANCING.INITIALTOTALFINANCEDAMOUNTET,',','.') || ',';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
             
                IF S_FINANCING.FIXEDASSETAMOUNTET IS NOT NULL THEN     
V_LIGNE := '                "fixedAssetAmountET":' || REPLACE(S_FINANCING.FIXEDASSETAMOUNTET,',','.') || ',';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;
                
                IF S_FINANCING.RESIDUALVALUEAMOUNTET IS NOT NULL THEN
V_LIGNE := '                "residualValueAmountET":' || REPLACE(S_FINANCING.RESIDUALVALUEAMOUNTET,',','.') || ',';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;
                
               IF S_FINANCING.RESIDUALVALUEDEALERAMOUNTET IS NOT NULL THEN
V_LIGNE := '                "residualValueDealerAmountET":' || REPLACE(S_FINANCING.RESIDUALVALUEDEALERAMOUNTET,',','.') || ',';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;
                
V_LIGNE := '                "dateStartContract":"' || S_FINANCING.DATESTARTCONTRACT || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
               
                
                IF S_FINANCING.AMOUNTDEPOSIT IS NOT NULL THEN 
V_LIGNE := '                "amountDeposit":' || REPLACE(S_FINANCING.AMOUNTDEPOSIT,',','.') || ',';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;              
                
                
V_LIGNE := '                "numberUnpaid":' || REPLACE(S_FINANCING.NUMBERUNPAID,',','.') || ',
                "amountRemainingCapital":' || REPLACE(S_FINANCING.AMOUNTREMAININGCAPITAL,',','.') || ',
                "startDateOfDueDate":"' || S_FINANCING.STARTDATEOFDUEDATE || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                
                IF S_FINANCING.ENDDATEOFDUEDATE IS NOT NULL THEN
V_LIGNE := '                "endDateOfDueDate":"' || S_FINANCING.ENDDATEOFDUEDATE || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;               
                
                IF S_FINANCING.NOMINALRATE IS NOT NULL THEN
V_LIGNE := '                "nominalRate":' || REPLACE(S_FINANCING.NOMINALRATE,',','.') || ',';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;

                IF S_FINANCING.RATETYPE IS NOT NULL THEN
V_LIGNE := '                "rateType":' || REPLACE(S_FINANCING.RATETYPE,',','.') || ',';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);     
                END IF;
                
V_LIGNE := '                "taegRate":' || REPLACE(S_FINANCING.TAEGRATE,',','.') || ',
                "costAdditionalMileage":' || REPLACE(S_FINANCING.COSTADDITIONALMILEAGE,',','.') || ',
                "financedAmountInitWithInterestWithoutService":' || REPLACE(S_FINANCING.FIN_AMT_INIT_INTERST_OUTSERV,',','.') || '';


                if V_NB_FINANCING_TRAITE = V_NB_FINANCING THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
         
       END LOOP;
    V_LIGNE := '';  -------- null

    -----------------------------------SECURITIZATION-----------------------------
  
    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_SECURITIZATION
         FROM  MKTOV.MKTQT_SECURITIZATION 
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_SECURITIZATION := NULL;
    END;

    IF NVL(V_NB_SECURITIZATION, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee 
    
       V_LIGNE := '"securitization": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       
       FOR S_SECURITIZATION IN C_SECURITIZATION (S_MKTQT_CONTRACT.TECH_ID) LOOP
            V_NB_SECURITIZATION_TRAITE := V_NB_SECURITIZATION_TRAITE+1;  
            
            V_LIGNE := '        {
                "contractRef":"' || S_SECURITIZATION.CONTRACTREF || '"';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                
                
                IF S_SECURITIZATION.ISSECURIZED IS NOT NULL THEN
V_LIGNE := '                ,"isSecurized":' || S_SECURITIZATION.ISSECURIZED || '';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;
                
                IF S_SECURITIZATION.DATESTART IS NOT NULL THEN
V_LIGNE := '                ,"dateStart":"' || S_SECURITIZATION.DATESTART || '"';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;
                
                IF S_SECURITIZATION.ID IS NOT NULL THEN              
V_LIGNE := '                ,"id":"' || S_SECURITIZATION.ID || '"';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;



                if V_NB_SECURITIZATION_TRAITE = V_NB_SECURITIZATION THEN V_LIGNE := '}';
                else V_LIGNE := '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            

       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null
 -----------------------------------ACCOUNT -----------------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_ACCOUNT 
         FROM  MKTOV.MKTQT_ACCOUNT 
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_ACCOUNT  := NULL;
    END;

    IF NVL(V_NB_ACCOUNT, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
      --- V_LIGNE := '"account": [';
      --- res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_ACCOUNT IN C_ACCOUNT (S_MKTQT_CONTRACT.TECH_ID)LOOP
            V_NB_ACCOUNT_TRAITE := V_NB_ACCOUNT_TRAITE+1;   ---- 
            
            
            V_LIGNE := '"account":{
                "contractRef":"' || S_ACCOUNT.CONTRACTREF	 || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                
            IF S_ACCOUNT.BALLOONVALUEAMOUNT IS NOT NULL THEN   
V_LIGNE :='                 "balloonValueAmount":' || REPLACE(S_ACCOUNT.BALLOONVALUEAMOUNT,',','.')	 || ',';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF;
                
           IF S_ACCOUNT.NEXTDUEDATE IS NOT NULL THEN     
V_LIGNE :='                 "nextDueDate":"' || S_ACCOUNT.NEXTDUEDATE	 || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF;



V_LIGNE :='                "nextRentAmountET":' || REPLACE(S_ACCOUNT.NEXTRENTAMOUNTET,',','.')	 || ',
                "nbPaymentNotBilled":' || REPLACE(S_ACCOUNT.NBPAYMENTNOTBILLED,',','.')	 || ',
                "lastPaidAmountET":' || REPLACE(S_ACCOUNT.LASTPAIDAMOUNTET,',','.')	 || ',
                "amountFinancialInitRentET":' || REPLACE(S_ACCOUNT.AMOUNTFINANCIALINITRENTET,',','.')	 || ',
                "amountFinancialRentET":' || REPLACE(S_ACCOUNT.AMOUNTFINANCIALRENTET,',','.')	 || ',
                "amountFinancialRentWithServIT":' || REPLACE(S_ACCOUNT.AMOUNTFINANCIALRENTWITHSERVIT,',','.')	 || ',
                "dayOfPayment":' || REPLACE(S_ACCOUNT.DAYOFPAYMENT,',','.')	 || ',
                "periodicity":"' || S_ACCOUNT.PERIODICITY	 || '",
                "chargeAmountET":' || REPLACE(S_ACCOUNT.CHARGEAMOUNTET,',','.')	 || '';

                if V_NB_ACCOUNT_TRAITE = V_NB_ACCOUNT THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       ---V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       ----res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null

 -----------------------------------PAYMEANACTIF -----------------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_PAYMEANACTIF 
         FROM  MKTOV.MKTQT_CPAYMEANACTIF
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_PAYMEANACTIF  := NULL;
    END;

    IF NVL(V_NB_PAYMEANACTIF, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
      --- V_LIGNE := '"account": [';
      --- res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_PAYMEANACTIF IN C_PAYMEANACTIF (S_MKTQT_CONTRACT.TECH_ID)LOOP
            V_NB_PAYMEANACTIF_TRAITE := V_NB_PAYMEANACTIF_TRAITE+1;   ---- 
            
            
            V_LIGNE := '"payMeanActif":{
                "contractRef":"' || S_PAYMEANACTIF.CONTRACTREF  || '",
                "paymentTypeCode":"' || S_PAYMEANACTIF.PAYMENTTYPECODE  || '",
                "bankAgency":"' || S_PAYMEANACTIF.BANKAGENCY  || '",
                "bankAccountNumber":"' || S_PAYMEANACTIF.BANKACCOUNTNUMBER  || '",
                "bankAccountKey":"' || S_PAYMEANACTIF.BANKACCOUNTKEY  || '",
                "bankNumber":"' || S_PAYMEANACTIF.BANKNUMBER  || '",
                "bankName":"' || S_PAYMEANACTIF.BANKNAME  || '",
                "sepaIban":"' || S_PAYMEANACTIF.SEPAIBAN  || '"';


                if V_NB_PAYMEANACTIF_TRAITE = V_NB_PAYMEANACTIF THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       ---V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       ----res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null

 -----------------------------------VEHICULE -----------------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_VEHICULE 
         FROM  MKTOV.MKTQT_CVEHICULE
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_VEHICULE  := NULL;
    END;

    IF NVL(V_NB_VEHICULE, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
      --- V_LIGNE := '"vehicule": [';
      --- res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_VEHICULE IN C_VEHICULE (S_MKTQT_CONTRACT.TECH_ID)LOOP
            V_NB_VEHICULE_TRAITE := V_NB_VEHICULE_TRAITE+1;    
                V_NB_AMOUNT_TRAITE  := 0;
                V_NB_ENDOFLIFE_TRAITE  := 0;
            
            V_LIGNE := '"vehicule ":{
                "tech_dateExtraction":"' || S_VEHICULE.TECH_DATEEXTRACTION	 || '",
                "contractRef":"' || S_VEHICULE.CONTRACTREF	 || '",
                "serialNumber":"' || S_VEHICULE.SERIALNUMBER	 || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                
            IF S_VEHICULE.DELIVERYDATE IS NOT NULL THEN    
V_LIGNE := '                "deliveryDate":"' || S_VEHICULE.DELIVERYDATE	 || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF;    
            
                
V_LIGNE := '                "expectedReturnDate":"' || S_VEHICULE.EXPECTEDRETURNDATE	 || '",
                "stateCode":"' || S_VEHICULE.STATECODE	 || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                
                IF S_VEHICULE.USAGECODE IS NOT NULL THEN
V_LIGNE := '                "usageCode":"' || S_VEHICULE.USAGECODE	 || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;
                
V_LIGNE := '                "contactualMileage":' || REPLACE(S_VEHICULE.CONTACTUALMILEAGE,',','.')	 || '';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);



 -----------------------------------VEHICULE AMOUNT DEBUT-----------------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_AMOUNT 
         FROM  MKTOV.MKTQT_VEHICULE_AMT
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_AMOUNT  := NULL;
    END;

    IF NVL(V_NB_AMOUNT, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
      --- V_LIGNE := '"account": [';
      --- res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_VEHICULE_AMT IN C_VEHICULE_AMT (S_MKTQT_CONTRACT.TECH_ID)LOOP
            V_NB_AMOUNT_TRAITE := V_NB_AMOUNT_TRAITE+1;   ---- 
            
            
            V_LIGNE := '            "amount":{';
            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            V_LIGNE := '';
            
            IF S_VEHICULE_AMT.SELLERPRICEIT IS NOT NULL THEN
V_LIGNE :=  '"sellerPriceIT":' || REPLACE(S_VEHICULE_AMT.SELLERPRICEIT,',','.')  || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF;  
                       
V_LIGNE := '"excessMileageRate":' || REPLACE(S_VEHICULE_AMT.EXCESSMILEAGERATE,',','.')  || '';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            IF S_VEHICULE_AMT.UNDERMILEAGERATE IS NOT NULL THEN
V_LIGNE := ',"underMileageRate":' || REPLACE(S_VEHICULE_AMT.UNDERMILEAGERATE,',','.')  || '';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF;

                if V_NB_AMOUNT_TRAITE = V_NB_AMOUNT THEN V_LIGNE :=   '}';
                else V_LIGNE := '}';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       ---V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       ----res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null

-----------------------------------VEHICULE AMOUNT FIN-----------------------------

-----------------------------------VEHICULE ENDOFLIFE DEBUT-----------------------------


    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_ENDOFLIFE 
         FROM  MKTOV.MKTQT_VEHICULE_ENDOFLIFE 
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_ENDOFLIFE  := NULL;
    END;

    IF NVL(V_NB_ENDOFLIFE, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
      --- V_LIGNE := '"account": [';
      --- res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_VEHICULE_ENDOFLIFE IN C_VEHICULE_ENDOFLIFE (S_MKTQT_CONTRACT.TECH_ID)LOOP
            V_NB_ENDOFLIFE_TRAITE := V_NB_ENDOFLIFE_TRAITE+1;   ---- 
            
            
            V_LIGNE := '            "endOfLife":{';
            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            V_LIGNE :='';
            
            IF S_VEHICULE_ENDOFLIFE.CONTACTENDOFLIFEDATE IS NOT NULL THEN
V_LIGNE := '                        "contactEndOfLifeDate":"' || S_VEHICULE_ENDOFLIFE.CONTACTENDOFLIFEDATE || '"';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF;           
                        
 
                IF V_LIGNE != '' THEN res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, ','); END IF;
V_LIGNE := '                        "earlyTerminationFlag":' || S_VEHICULE_ENDOFLIFE.EARLYTERMINATIONFLAG || '';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
 


            IF S_VEHICULE_ENDOFLIFE.DEALERRETURNDATE IS NOT NULL THEN 
V_LIGNE := '                        ,"dealerReturnDate":"' || S_VEHICULE_ENDOFLIFE.DEALERRETURNDATE || '"';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF; 
                                    
            IF S_VEHICULE_ENDOFLIFE.CHOICECUSTOMERRETURNDATE IS NOT NULL THEN 
V_LIGNE :=  '                        ,"choiceCustomerReturnDate":"' || S_VEHICULE_ENDOFLIFE.CHOICECUSTOMERRETURNDATE || '"';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF; 
                                    
            IF S_VEHICULE_ENDOFLIFE.REALRETURNDATE IS NOT NULL THEN 
V_LIGNE := '                        ,"realReturnDate":"' || S_VEHICULE_ENDOFLIFE.REALRETURNDATE || '"';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF; 
                                    
            IF S_VEHICULE_ENDOFLIFE.CONTACTEMAILCUSTOMERFLAG IS NOT NULL THEN       
V_LIGNE := '                        ,"contactEmailCustomerFlag":' || S_VEHICULE_ENDOFLIFE.CONTACTEMAILCUSTOMERFLAG || '';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF; 
                                    
            IF S_VEHICULE_ENDOFLIFE.CONTACTEMAILCUSTOMERDATE IS NOT NULL THEN       
V_LIGNE := '                        ,"contactEmailCustomerDate":"' || S_VEHICULE_ENDOFLIFE.CONTACTEMAILCUSTOMERDATE || '"';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF; 
                                    
            IF S_VEHICULE_ENDOFLIFE.CONTACTPHONECUSTOMERFLAG IS NOT NULL THEN           
V_LIGNE := '                        ,"contactPhoneCustomerFlag":' || S_VEHICULE_ENDOFLIFE.CONTACTPHONECUSTOMERFLAG || '';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF; 
                                    
            IF S_VEHICULE_ENDOFLIFE.CONTACTPHONECUSTOMERDATE IS NOT NULL THEN    
V_LIGNE := '                        ,"contactPhoneCustomerDate":"' || S_VEHICULE_ENDOFLIFE.CONTACTPHONECUSTOMERDATE || '"';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF; 
                                    
            IF S_VEHICULE_ENDOFLIFE.RESALEDEALERFLAG IS NOT NULL THEN  
V_LIGNE := '                        ,"resaleDealerFlag":' || S_VEHICULE_ENDOFLIFE.RESALEDEALERFLAG || '';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF; 
                                    
                        
            IF S_VEHICULE_ENDOFLIFE.RESALECUSTOMERFLAG IS NOT NULL THEN   
V_LIGNE := '                        ,"resaleCustomerFlag":' || S_VEHICULE_ENDOFLIFE.RESALECUSTOMERFLAG || '';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF; 
            
            IF S_VEHICULE_ENDOFLIFE.MILEAGEENDOFLIFE IS NOT NULL THEN   
V_LIGNE := '                        ,"mileageEndOfLIfe":' || REPLACE(S_VEHICULE_ENDOFLIFE.MILEAGEENDOFLIFE,',','.') || '';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

            END IF; 
                                    
            IF S_VEHICULE_ENDOFLIFE.REFURBISHMENT IS NOT NULL THEN    
V_LIGNE := '                        ,"refurbishment":' || REPLACE(S_VEHICULE_ENDOFLIFE.REFURBISHMENT,',','.') || '';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF; 
                                    
            IF S_VEHICULE_ENDOFLIFE.BUYERDEALERNAME IS NOT NULL THEN        
V_LIGNE := '                        ,"buyerDealerName":"' || S_VEHICULE_ENDOFLIFE.BUYERDEALERNAME || '"';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF; 
                                    
                        
            IF S_VEHICULE_ENDOFLIFE.BUYERDEALERCITY IS NOT NULL THEN    
V_LIGNE := '                        ,"buyerDealerCity":"' || S_VEHICULE_ENDOFLIFE.BUYERDEALERCITY || '"';res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF; 
                                    
                        

                if V_NB_ENDOFLIFE_TRAITE = V_NB_ENDOFLIFE THEN V_LIGNE := '}';
                else V_LIGNE := '}';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       ---V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       ----res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null
    
-----------------------------------VEHICULE ENDOFLIFE FIN-----------------------------

                if V_NB_VEHICULE_TRAITE = V_NB_VEHICULE THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       ---V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       ----res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null





 -----------------------------------SERVICES-----------------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_SERVICES
         FROM  MKTOV.MKTQT_SERVICES
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_SERVICES  := NULL;
    END;

    IF NVL(V_NB_SERVICES, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"services": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_SERVICES IN C_SERVICES (S_MKTQT_CONTRACT.TECH_ID)LOOP
            V_NB_SERVICES_TRAITE := V_NB_SERVICES_TRAITE+1;   ---- 
            
            
            V_LIGNE := '                {
                "contractRef":"' || S_SERVICES.CONTRACTREF	 || '",
                "serviceRef":"' || S_SERVICES.SERVICEREF	 || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                
                
                IF S_SERVICES.EXTERNALSERVICEID IS NOT NULL THEN
V_LIGNE := '                "externalServiceId":"' || S_SERVICES.EXTERNALSERVICEID	 || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;
                
                IF S_SERVICES.SERVICECODETYPE IS NOT NULL THEN
V_LIGNE := '                "serviceCodeType":"' || S_SERVICES.SERVICECODETYPE	 || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;
               
V_LIGNE := '                "labelService":"' || REPLACE(S_SERVICES.LABELSERVICE,',','.')	 || '",
                "dateStartService":"' || S_SERVICES.DATESTARTSERVICE	 || '",
                "dateEndService":"' || S_SERVICES.DATEENDSERVICE	 || '",
                "durationService":' || REPLACE(S_SERVICES.DURATIONSERVICE,',','.')	 || ',';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                
                IF S_SERVICES.DATERESILIATION IS NOT NULL THEN
V_LIGNE := '                "dateResiliation":"' || S_SERVICES.DATERESILIATION	 || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;
                
V_LIGNE := '                "nextPaymentAmountET":' || REPLACE(S_SERVICES.NEXTPAYMENTAMOUNTET,',','.')	 || ',
                "totaltAmountET":' || REPLACE(S_SERVICES.TOTALTAMOUNTET,',','.')	 || ',';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                
                IF S_SERVICES.REASONOFENDSERVICE IS NOT NULL THEN
V_LIGNE := '                "reasonOfEndService":"' || S_SERVICES.REASONOFENDSERVICE	 || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                END IF;
                
V_LIGNE := '                "flagCEM":' || S_SERVICES.FLAGCEM	 || ',
                "totalAmountService ":' || REPLACE(S_SERVICES.TOTALAMOUNTSERVICE,',','.')	 || '';


                if V_NB_SERVICES_TRAITE = V_NB_SERVICES THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null
---------------------------------------



 -----------------------------------SCHEDULES-----------------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_SCHEDULES
         FROM  MKTOV.MKTQT_SCHEDULES
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_SCHEDULES  := NULL;
    END;

    IF NVL(V_NB_SCHEDULES, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"schedules": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       
       FOR S_SCHEDULES IN C_SCHEDULES (S_MKTQT_CONTRACT.TECH_ID)LOOP
            V_NB_SCHEDULES_TRAITE := V_NB_SCHEDULES_TRAITE+1;   ---- 
            
            
            V_LIGNE := '                {
                "contractRef":"' || S_SCHEDULES.CONTRACTREF	 || '",
                "numberOfMonthlyPayment":' || REPLACE(S_SCHEDULES.NUMBEROFMONTHLYPAYMENT,',','.')	 || ',
                "invoiceDate":"' || S_SCHEDULES.INVOICEDATE	 || '",
                "dateStartOfPeriodPayment":"' || S_SCHEDULES.DATESTARTOFPERIODPAYMENT	 || '",
                "dateEndOfPeriodPayment":"' || S_SCHEDULES.DATEENDOFPERIODPAYMENT	 || '",
                "duration":' || REPLACE(S_SCHEDULES.DURATION,',','.')	 || ',
                "interestAmount":' || REPLACE(S_SCHEDULES.INTERESTAMOUNT,',','.')	 || ',
                "unpaidFlag":' || S_SCHEDULES.UNPAIDFLAG	 || '';
               


                if V_NB_SCHEDULES_TRAITE = V_NB_SCHEDULES THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;


            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null
    
    
-----------------------------------STAKEHOLDERS-----------------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_STAKEHOLDERS
         FROM  MKTOV.MKTQT_STAKEHOLDERS
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_STAKEHOLDERS  := NULL;
    END;

    IF NVL(V_NB_STAKEHOLDERS, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"stakeholders": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_STAKEHOLDERS IN C_STAKEHOLDERS (S_MKTQT_CONTRACT.TECH_ID)LOOP
            V_NB_STAKEHOLDERS_TRAITE := V_NB_STAKEHOLDERS_TRAITE+1;   ---- 
            V_NB_STAKEHOLDERS_ADRS_TRAITE  := 0; 
            
            V_LIGNE := '                {
                "contractRef":"' || S_STAKEHOLDERS.CONTRACTREF	 || '",
                "stakeholderRole":"' || S_STAKEHOLDERS.STAKEHOLDERROLE	 || '",
                "srcPartyId":"' || S_STAKEHOLDERS.SRCPARTYID	 || '",
                "srcJvCode":"' || S_STAKEHOLDERS.SRCJVCODE	 || '",
                "srcAppCode":"' || S_STAKEHOLDERS.SRCAPPCODE1	 || '",
                "srcDealershipId":"' || S_STAKEHOLDERS.SRCDEALERSHIPID	 || '",
                "srcAppCode":"' || S_STAKEHOLDERS.SRCAPPCODE2	 || '"';
            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                    ---------------------STAKEHOLDERS_ADRS DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_STAKEHOLDERS_ADRS
         FROM  MKTOV.MKTQT_STAKEHOLDER_ADRS
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_STAKEHOLDERS_ADRS  := NULL;
    END;

    IF NVL(V_NB_STAKEHOLDERS_ADRS, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
      --- V_LIGNE := '"account": [';
      --- res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_STAKEHOLDERS_ADRS IN C_STAKEHOLDERS_ADRS (S_MKTQT_CONTRACT.TECH_ID)LOOP
            V_NB_STAKEHOLDERS_ADRS_TRAITE := V_NB_STAKEHOLDERS_ADRS_TRAITE+1;   ---- 
            
            
            V_LIGNE := '"principalAddress":{
                        "numberAndStreet":"' || S_STAKEHOLDERS_ADRS.NUMBERANDSTREET	 || '",
                        "zipCode":"' || S_STAKEHOLDERS_ADRS.ZIPCODE	 || '",
                        "city":"' || S_STAKEHOLDERS_ADRS.CITY	 || '",
                        "department":"' || S_STAKEHOLDERS_ADRS.DEPARTMENT	 || '"';               
               

                if V_NB_STAKEHOLDERS_ADRS_TRAITE = V_NB_STAKEHOLDERS_ADRS THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       ---V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       ----res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null
                ---------------------STAKEHOLDERS_ADRS FIN----------------------


                if V_NB_STAKEHOLDERS_TRAITE = V_NB_STAKEHOLDERS THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null
    
       
                    ---------------------AMENDMENT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_AMENDMENT
         FROM  MKTOV.MKTQT_AMENDMENT
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_AMENDMENT  := NULL;
    END;

    IF NVL(V_NB_AMENDMENT, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"amendment": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_AMENDMENT IN C_AMENDMENT (S_MKTQT_CONTRACT.TECH_ID)LOOP
            V_NB_AMENDMENT_TRAITE := V_NB_AMENDMENT_TRAITE+1;   ---- 
                V_NB_AMENDMENT_EXTEN_TRAITE  := 0;
                V_NB_SIGNATORY_TRAITE  := 0;
            
            V_LIGNE := '                {
                "tech_dateExtraction":"' || S_AMENDMENT.TECH_DATEEXTRACTION	 || '",
                "amendementRef":"' || S_AMENDMENT.AMENDEMENTREF	 || '",
                "typeCode":"' || S_AMENDMENT.TYPECODE	 || '"';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                
            IF S_AMENDMENT.APPLICATIONDATE IS NOT NULL THEN
V_LIGNE := ',                "applicationDate":"' || S_AMENDMENT.APPLICATIONDATE	 || '"'; 
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF;
            
            ------------------------------AMENDMENT_EXTEN DEBUT------------------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_AMENDMENT_EXTEN
         FROM  MKTOV.MKTQT_AMENDMENT_EXTENSION
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_AMENDMENT_EXTEN  := NULL;
    END;

    IF NVL(V_NB_AMENDMENT_EXTEN, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
      --- V_LIGNE := '"account": [';
      --- res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_AMENDMENT_EXTEN IN C_AMENDMENT_EXTEN (S_MKTQT_CONTRACT.TECH_ID)LOOP
            V_NB_AMENDMENT_EXTEN_TRAITE := V_NB_AMENDMENT_EXTEN_TRAITE+1;   ---- 
            
            
            V_LIGNE := '"extension":{
                        "typeCode":"' || S_AMENDMENT_EXTEN.TYPECODE	 || '",';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                        
           IF S_AMENDMENT_EXTEN.AUTOMATICFLAG IS NOT NULL THEN             
V_LIGNE := '                        "automaticFlag":' || S_AMENDMENT_EXTEN.AUTOMATICFLAG	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
           END IF;  
           
            IF S_AMENDMENT_EXTEN.PREVIOUSDURATION IS NOT NULL THEN         
V_LIGNE := '                        "previousDuration":' || REPLACE(S_AMENDMENT_EXTEN.PREVIOUSDURATION,',','.')	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF;
            IF S_AMENDMENT_EXTEN.NEWDURATION IS NOT NULL THEN
V_LIGNE := '                        "newDuration":' || REPLACE(S_AMENDMENT_EXTEN.NEWDURATION,',','.')	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
             END IF;
             IF S_AMENDMENT_EXTEN.PREVIOUSMILEAGE IS NOT NULL THEN           
V_LIGNE := '                        "previousMileage":' || REPLACE(S_AMENDMENT_EXTEN.PREVIOUSMILEAGE,',','.')	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
             END IF;
             IF  S_AMENDMENT_EXTEN.NEWMILEAGE IS NOT NULL THEN           
V_LIGNE := '                        "newMileage":' || REPLACE(S_AMENDMENT_EXTEN.NEWMILEAGE,',','.')	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
              END IF;          
             IF S_AMENDMENT_EXTEN.PREVIOUSRVAMOUNT IS NOT NULL THEN           
V_LIGNE := '                        "previousRvAmount":' || REPLACE(S_AMENDMENT_EXTEN.PREVIOUSRVAMOUNT,',','.')	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
              END IF;          
              IF S_AMENDMENT_EXTEN.NEWRVAMOUNT IS NOT NULL THEN          
V_LIGNE := '                        "newRvAmount":' || REPLACE(S_AMENDMENT_EXTEN.NEWRVAMOUNT,',','.')	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
               END IF;         
             IF  S_AMENDMENT_EXTEN.PREVIOUSRATE	 IS NOT NULL THEN           
V_LIGNE := '                        "previousRate":' || REPLACE(S_AMENDMENT_EXTEN.PREVIOUSRATE,',','.')	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
              END IF;          
             IF S_AMENDMENT_EXTEN.NEWRATE IS NOT NULL THEN           
V_LIGNE := '                        "newRate":' || REPLACE(S_AMENDMENT_EXTEN.NEWRATE,',','.')	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
              END IF;          
             IF S_AMENDMENT_EXTEN.PREVIOUSRENT IS NOT NULL THEN           
V_LIGNE := '                        "previousRent":' || REPLACE(S_AMENDMENT_EXTEN.PREVIOUSRENT,',','.')	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
             END IF;           
             IF S_AMENDMENT_EXTEN.NEWRENT IS NOT NULL THEN           
V_LIGNE := '                        "newRent":' || REPLACE(S_AMENDMENT_EXTEN.NEWRENT,',','.')	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
              END IF;          
                        
                        
             IF S_AMENDMENT_EXTEN.PREVIOUSSERVICEMOUNT IS NOT NULL THEN                         
V_LIGNE := '                        "previousServicemount":' || REPLACE(S_AMENDMENT_EXTEN.PREVIOUSSERVICEMOUNT,',','.')	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
              END IF;
             IF S_AMENDMENT_EXTEN.NEWSERVICEAMOUNT IS NOT NULL THEN  
V_LIGNE := '                        "newServiceAmount":' || REPLACE(S_AMENDMENT_EXTEN.NEWSERVICEAMOUNT,',','.')	 || ',';
                        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
              END IF;                        
          
V_LIGNE := '                        "newAmountFees":' || REPLACE(S_AMENDMENT_EXTEN.NEWAMOUNTFEES,',','.')	 || '';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
                     IF S_AMENDMENT_EXTEN.NEWTOTALOUSTANDING IS NOT NULL THEN 
V_LIGNE := ',                        "newTotalOustanding":' || REPLACE(S_AMENDMENT_EXTEN.NEWTOTALOUSTANDING,',','.')	 || '';                              
               res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
                    END IF;
                    
                   
                if V_NB_AMENDMENT_EXTEN_TRAITE = V_NB_AMENDMENT_EXTEN THEN V_LIGNE :=   '}';
                else V_LIGNE :='}';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       ---V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       ----res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null
            ------------------------------AMENDMENT_EXTEN FIN------------------------------


                   --------------------- SIGNATORY DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_SIGNATORY
         FROM  MKTOV.MKTQT_SIGNATORY
         WHERE TECH_ID = S_MKTQT_CONTRACT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_SIGNATORY := NULL;
    END;

    IF NVL(V_NB_SIGNATORY, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
      --- V_LIGNE := '"account": [';
      --- res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_SIGNATORY IN C_SIGNATORY (S_MKTQT_CONTRACT.TECH_ID)LOOP
            V_NB_SIGNATORY_TRAITE := V_NB_SIGNATORY_TRAITE+1;   ---- 
            
            
            V_LIGNE := '"signatory":{
                        "name":"' || S_SIGNATORY.NAME	 || '",
                        "email":"' || S_SIGNATORY.EMAIL	 || '"';
                           
               

                if V_NB_SIGNATORY_TRAITE = V_NB_SIGNATORY THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       ---V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       ----res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- SIGNATORY FIN----------------------
------------------------------------------------------------

                if V_NB_AMENDMENT_TRAITE = V_NB_AMENDMENT THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '}';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null   

     --------DERNIERE PARTIE      

    if V_NB_ENREG_TRAITE = V_NB_ENREG THEN V_LIGNE := V_LIGNE || '}';   
    else V_LIGNE := V_LIGNE || '},';    ------------------------------ ajout fin balise
    end if;  
    res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

    N_SAUV := N_SAUV +1;
           
    EXCEPTION WHEN OTHERS THEN COMMIT;
                V_ERR  := 1;
                RES   := MKT.MKTQAUT.F_WRITE(FILE_ID,'EXPORT_CONTRACT_JSON ','MESSAGE ERREUR PL/SQL : ' ||SQLERRM || S_MKTQT_CONTRACT.TECH_ID);
                --RETURN V_ERR;
                RETURN V_ERR;
    END;
  END LOOP;
   V_LIGNE := ']';
   res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
   UTL_FILE.FCLOSE(file_id_cvs);
  res := MKT.MKTQAUT.F_WRITE(file_id,
                               'EXPORT_CONTRACT_JSON',
                               'Nombre de sauvegarde :' || N_SAUV);
    res := MKT.MKTQAUT.F_WRITE(file_id, '', '');
    UTL_FILE.FCLOSE(file_id);

  --RETURN V_ERR;
  RETURN V_ERR;
EXCEPTION WHEN OTHERS THEN COMMIT;
          V_ERR  := 1;
          RES     := MKT.MKTQAUT.F_WRITE(FILE_ID,'EXPORT_CONTRACT_JSON ','MESSAGE ERREUR PL/SQL : ' ||SQLERRM);
          --RETURN V_ERR;
          RETURN V_ERR;
END EXPORT_CONTRACT_JSON;













FUNCTION EXPORT_AGREEMENT_JSON (NOMLOG varchar2,P_DATE_TRAI date, P_PATH VARCHAR2, P_CODE_PAYS VARCHAR2, P_FILENAME_AGREEMENT VARCHAR2) return number IS
    V_ERR       number:=0;
    N_SAUV      NUMBER := 0;
    FILE_ID     UTL_FILE.FILE_TYPE;
    FILE_ID_CVS UTL_FILE.FILE_TYPE;
    V_LIGNE     VARCHAR2(4000);
    RES         NUMBER := 0;
    file_name   VARCHAR2(30);
    V_NB_ENREG  NUMBER(10) := 0;  
    V_NB_ENREG_TRAITE NUMBER(10) := 0;

    V_NB_REQUEST  NUMBER(10) := 0;  
    V_NB_REQUEST_TRAITE NUMBER(10) := 0;

    V_NB_CONTRACT  NUMBER(10) := 0;  
    V_NB_CONTRACT_TRAITE NUMBER(10) := 0;
    
    V_NB_FEES  NUMBER(10) := 0;  
    V_NB_FEES_TRAITE NUMBER(10) := 0;



CURSOR C_MKTQT_AGREEMENT IS
SELECT 
TECH_ID AS TECH_ID,
TO_CHAR(TECH_DATEEXTRACTION,'YYYY-MM-DD') AS TECH_DATEEXTRACTION,
COUNTRYBRANCHCODE AS COUNTRYBRANCHCODE
FROM MKTOV.MKTQT_AGREEMENT
WHERE  COUNTRYBRANCHCODE = P_CODE_PAYS
;

CURSOR C_MKTQT_REQUEST (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
REQUESTREF AS REQUESTREF
FROM MKTOV.MKTQT_AGREEMENT_REQUEST
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_MKTQT_CONTRACT (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
CONTRACTREF AS CONTRACTREF,
BACKOFFICEORIGIN AS BACKOFFICEORIGIN

FROM MKTOV.MKTQT_AGREEMENT_CONTRACT
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_MKTQT_FEES (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
FEETYPE AS FEETYPE,
FEELABEL AS FEELABEL,
FEECODE AS FEECODE,
(CASE WHEN SUBSTR(TO_CHAR(INVOICINGAMOUNT),1,1) = ',' THEN  REPLACE(REPLACE(TO_CHAR(INVOICINGAMOUNT),',','0,'),',','.') ELSE REPLACE(TO_CHAR(INVOICINGAMOUNT),',','.') END)  AS INVOICINGAMOUNT,
--REPLACE(INVOICINGAMOUNT,',','.') AS INVOICINGAMOUNT,--
TRANSACTIONIDBACKOFFICE AS TRANSACTIONIDBACKOFFICE,
TO_CHAR(LASTINVOICINGDATE,'YYYY-MM-DD') AS LASTINVOICINGDATE,
SPREADFLAG AS SPREADFLAG

FROM MKTOV.MKTQT_AGREEMENT_FEES
WHERE TECH_ID = P_TECH_ID
;





BEGIN
  file_name := P_FILENAME_AGREEMENT;
  FILE_ID := MKT.MKTQAUT.F_OPEN(NOMLOG);
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, 'EXPORT_AGREEMENT_JSON', ' ##  EXPORT AGREEMENT JSON' ||  ' ##');
  file_id_cvs:= MKT.MKTQAUT.F_OPEN_CVS_UTF8(p_path,file_name);


  BEGIN 
       SELECT COUNT(*)
       INTO   V_NB_ENREG
       FROM   MKTOV.MKTQT_AGREEMENT
       WHERE  COUNTRYBRANCHCODE = P_CODE_PAYS;
  EXCEPTION WHEN OTHERS THEN
       V_NB_ENREG := 0;
  END;

      V_LIGNE := '[';
      res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
      
      FOR S_MKTQT_AGREEMENT IN C_MKTQT_AGREEMENT LOOP
      BEGIN
         V_NB_ENREG_TRAITE := V_NB_ENREG_TRAITE +1;
         V_NB_REQUEST_TRAITE  := 0;
         V_NB_CONTRACT_TRAITE  := 0;
         V_NB_FEES_TRAITE  := 0;
         
         
              V_LIGNE := '{
"tech_id":"' || S_MKTQT_AGREEMENT.TECH_ID  || '",
"tech_dateExtraction":"' || S_MKTQT_AGREEMENT.TECH_DATEEXTRACTION  || '",
"countryBranchCode":"' || S_MKTQT_AGREEMENT.COUNTRYBRANCHCODE  || '"';

res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);


                   --------------------- REQUEST DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_REQUEST
         FROM  MKTOV.MKTQT_AGREEMENT_REQUEST
         WHERE TECH_ID = S_MKTQT_AGREEMENT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_REQUEST := NULL;
    END;

    IF NVL(V_NB_REQUEST, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
      --- V_LIGNE := '"account": [';
      --- res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_REQUEST IN C_MKTQT_REQUEST (S_MKTQT_AGREEMENT.TECH_ID)LOOP
            V_NB_REQUEST_TRAITE := V_NB_REQUEST_TRAITE+1;   ---- 
            
            
            V_LIGNE := '"request":{
            "requestRef":"' || S_MKTQT_REQUEST.REQUESTREF	 || '"';                           
               

                if V_NB_REQUEST_TRAITE = V_NB_REQUEST THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '}';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       ---V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       ----res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- REQUEST FIN----------------------


                   --------------------- CONTRACT DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_CONTRACT
         FROM  MKTOV.MKTQT_AGREEMENT_CONTRACT
         WHERE TECH_ID = S_MKTQT_AGREEMENT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_CONTRACT := NULL;
    END;

    IF NVL(V_NB_CONTRACT, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
      --- V_LIGNE := '"account": [';
      --- res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_CONTRACT IN C_MKTQT_CONTRACT (S_MKTQT_AGREEMENT.TECH_ID)LOOP
            V_NB_CONTRACT_TRAITE := V_NB_CONTRACT_TRAITE+1;   ---- 
            
            
            V_LIGNE := '"contract":{
            "contractRef":"' || S_MKTQT_CONTRACT.CONTRACTREF	 || '",                           
            "backOfficeOrigin":"' || S_MKTQT_CONTRACT.BACKOFFICEORIGIN	 || '"'; 

                if V_NB_CONTRACT_TRAITE = V_NB_CONTRACT THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '}';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       ---V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       ----res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- CONTRACT FIN----------------------

                  --------------------- FEES DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_FEES
         FROM  MKTOV.MKTQT_AGREEMENT_FEES
         WHERE TECH_ID = S_MKTQT_AGREEMENT.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_FEES := NULL;
    END;

    IF NVL(V_NB_FEES, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"fees": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_FEES IN C_MKTQT_FEES (S_MKTQT_AGREEMENT.TECH_ID)LOOP
            V_NB_FEES_TRAITE := V_NB_FEES_TRAITE+1;   ---- 
            
            
            V_LIGNE := '            {
            "feeType":"' || S_MKTQT_FEES.FEETYPE || '",
            "feelabel":"' || S_MKTQT_FEES.FEELABEL || '",
            "feeCode":"' || S_MKTQT_FEES.FEECODE || '",
            "invoicingAmount":' || S_MKTQT_FEES.INVOICINGAMOUNT || ',
            "transactionIdBackOffice":"' || S_MKTQT_FEES.TRANSACTIONIDBACKOFFICE || '",
            "lastInvoicingDate":"' || S_MKTQT_FEES.LASTINVOICINGDATE || '",
            "spreadFlag":' || S_MKTQT_FEES.SPREADFLAG || '';                  
               

                if V_NB_FEES_TRAITE = V_NB_FEES THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- FEES FIN----------------------






V_LIGNE:='';
    if V_NB_ENREG_TRAITE = V_NB_ENREG THEN V_LIGNE := V_LIGNE || '}';   
    else V_LIGNE := V_LIGNE || '},';    ------------------------------ ajout fin balise
    end if;  
    res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

    N_SAUV := N_SAUV +1;
           
    EXCEPTION WHEN OTHERS THEN COMMIT;
                V_ERR  := 1;
                RES   := MKT.MKTQAUT.F_WRITE(FILE_ID,'EXPORT_AGREEMENT_JSON ','MESSAGE ERREUR PL/SQL : ' ||SQLERRM || S_MKTQT_AGREEMENT.TECH_ID);
                --RETURN V_ERR;
                RETURN V_ERR;
    END;
  END LOOP;
   V_LIGNE := ']';
   res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
   UTL_FILE.FCLOSE(file_id_cvs);
  res := MKT.MKTQAUT.F_WRITE(file_id,
                               'EXPORT_AGREEMENT_JSON',
                               'Nombre de sauvegarde :' || N_SAUV);
    res := MKT.MKTQAUT.F_WRITE(file_id, '', '');
    UTL_FILE.FCLOSE(file_id);

  --RETURN V_ERR;
  RETURN V_ERR;
EXCEPTION WHEN OTHERS THEN COMMIT;
          V_ERR  := 1;
          RES     := MKT.MKTQAUT.F_WRITE(FILE_ID,'EXPORT_AGREEMENT_JSON ','MESSAGE ERREUR PL/SQL : ' ||SQLERRM);
          --RETURN V_ERR;
          RETURN V_ERR;
END EXPORT_AGREEMENT_JSON;




FUNCTION EXPORT_ASSET_JSON (NOMLOG varchar2,P_DATE_TRAI date, P_PATH VARCHAR2, P_CODE_PAYS VARCHAR2, P_FILENAME_ASSET VARCHAR2) return number IS
    V_ERR       number:=0;
    N_SAUV      NUMBER := 0;
    FILE_ID     UTL_FILE.FILE_TYPE;
    FILE_ID_CVS UTL_FILE.FILE_TYPE;
    V_LIGNE     VARCHAR2(4000);
    RES         NUMBER := 0;
    file_name   VARCHAR2(30);
    V_NB_ENREG  NUMBER(10) := 0;  
    V_NB_ENREG_TRAITE NUMBER(10) := 0;

    V_NB_VEHICLE  NUMBER(10) := 0;  
    V_NB_VEHICLE_TRAITE NUMBER(10) := 0;
    V_NB_LABELS  NUMBER(10) := 0;  
    V_NB_LABELS_TRAITE NUMBER(10) := 0;
    V_NB_PRICING  NUMBER(10) := 0;  
    V_NB_PRICING_TRAITE NUMBER(10) := 0;

    V_NB_BASEPRICE  NUMBER(10) := 0;  
    V_NB_BASEPRICE_TRAITE NUMBER(10) := 0;
    V_NB_DISCOUNTS  NUMBER(10) := 0;  
    V_NB_DISCOUNTS_TRAITE NUMBER(10) := 0;
    
    V_NB_LIFECYCLE  NUMBER(10) := 0;  
    V_NB_LIFECYCLE_TRAITE NUMBER(10) := 0;
    
    V_NB_DOMAINREFS  NUMBER(10) := 0;  
    V_NB_DOMAINREFS_TRAITE NUMBER(10) := 0;
    

CURSOR C_MKTQT_ASSET IS
SELECT 
TECH_ID AS TECH_ID,
TO_CHAR(TECH_DATEEXTRACTION,'YYYY-MM-DD') AS TECH_DATEEXTRACTION,
COUNTRYBRANCHCODE AS COUNTRYBRANCHCODE
FROM MKTOV.MKTQT_ASSET
WHERE  COUNTRYBRANCHCODE = P_CODE_PAYS
;

CURSOR C_MKTQT_VEHICLE (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION,'YYYY-MM-DD') AS TECH_DATEEXTRACTION,
COUNTRYBRANCHCODE	AS COUNTRYBRANCHCODE	,
SERIALNUMBER	AS SERIALNUMBER	,
BRANDCODE	AS BRANDCODE	,
BRANDLABEL	AS BRANDLABEL	,
DELIVERYDATE	AS DELIVERYDATE	,
REGISTRATIONNUMBER	AS REGISTRATIONNUMBER	,
REPLACE(FISCALHORSEPOWER,',','.')	AS FISCALHORSEPOWER	,
KINDCODE	AS KINDCODE	,
ENERGYCODE	AS ENERGYCODE	,
REPLACE(CURRENTMILEAGE,',','.')	AS CURRENTMILEAGE	,
ISLEASCO	AS ISLEASCO	,
ISFINCO	AS ISFINCO	,
CONTRACTREF	AS CONTRACTREF	

FROM MKTOV.MKTQT_ASSET_VEHICULE
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_MKTQT_LABELS (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
LANGUAGECODE AS LANGUAGECODE,
VERSIONLABELSHORT AS VERSIONLABELSHORT,
VERSIONLABELLONG AS VERSIONLABELLONG

FROM MKTOV.MKTQT_ASSET_VEHICULE_LABELS
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_MKTQT_PRICING (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
REPLACE(AMOUNTET,',','.') AS AMOUNTET,
REPLACE(OPTIONSTOTALAMOUNTET,',','.') AS OPTIONSTOTALAMOUNTET,
REPLACE(ACCESSORIESTOTALAMOUNTET,',','.') AS ACCESSORIESTOTALAMOUNTET,
ENVIRONMENTALBONUS AS ENVIRONMENTALBONUS

FROM MKTOV.MKTQT_VEHICULE_PRICING
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_MKTQT_BASEPRICE (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
REPLACE(AMOUNTET,',','.') AS AMOUNTET,
REPLACE(VATAMOUNT,',','.') AS VATAMOUNT

FROM MKTOV.MKTQT_VEHICULE_BASEPRICE
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_MKTQT_DISCOUNTS (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TYPECODE AS TYPECODE,
SOURCECODE AS SOURCECODE,
REPLACE(AMOUNTET,',','.') AS AMOUNTET

FROM MKTOV.MKTQT_VEHICULE_PRICE_DISCOUNT
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_MKTQT_LIFECYCLE (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION,'YYYY-MM-DD') AS TECH_DATEEXTRACTION,
COUNTRYBRANCHCODE AS COUNTRYBRANCHCODE,
MODIFICATIONTYPE AS MODIFICATIONTYPE,
SERIALNUMBER AS SERIALNUMBER,
REGISTRATIONNUMBER AS REGISTRATIONNUMBER,
TO_CHAR(DATEREGISTRATION,'YYYY-MM-DD') AS DATEREGISTRATION,
REPLACE(CURRENTMILEAGE,',','.') AS CURRENTMILEAGE

FROM MKTOV.MKTQT_VEHICULE_LIFECYCLE
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_MKTQT_DOMAINREFS (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION,'YYYY-MM-DD') AS TECH_DATEEXTRACTION,
COUNTRYBRANCHCODE AS COUNTRYBRANCHCODE,
SERIALNUMBER AS SERIALNUMBER,
CONTRACTREF AS CONTRACTREF,
BACKOFFICEORIGIN AS BACKOFFICEORIGIN,
SRCPARTYID AS SRCPARTYID,
SRCJVCODE AS SRCJVCODE,
SRCAPPCODE AS SRCAPPCODE,
STATECODE AS STATECODE

FROM MKTOV.MKTQT_VEHICULE_DOMAINREFS
WHERE TECH_ID = P_TECH_ID
;



BEGIN
  file_name := P_FILENAME_ASSET;
  FILE_ID := MKT.MKTQAUT.F_OPEN(NOMLOG);
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, 'EXPORT_ASSET_JSON', ' ##  EXPORT ASSET JSON' ||  ' ##');
  file_id_cvs:= MKT.MKTQAUT.F_OPEN_CVS_UTF8(p_path,file_name);


  BEGIN 
       SELECT COUNT(*)
       INTO   V_NB_ENREG
       FROM   MKTOV.MKTQT_ASSET
       WHERE  COUNTRYBRANCHCODE = P_CODE_PAYS;
  EXCEPTION WHEN OTHERS THEN
       V_NB_ENREG := 0;
  END;

      V_LIGNE := '[';
      res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
      
      FOR S_MKTQT_ASSET IN C_MKTQT_ASSET LOOP
      BEGIN
         V_NB_ENREG_TRAITE := V_NB_ENREG_TRAITE +1;
         V_NB_VEHICLE_TRAITE := 0;
         
         
              V_LIGNE := '{
"tech_id":"' || S_MKTQT_ASSET.TECH_ID  || '",
"tech_dateExtraction":"' || S_MKTQT_ASSET.TECH_DATEEXTRACTION  || '",
"countryBranchCode":"' || S_MKTQT_ASSET.COUNTRYBRANCHCODE  || '"';

res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);


                  --------------------- VEHICLE DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_VEHICLE
         FROM  MKTOV.MKTQT_ASSET_VEHICULE
         WHERE TECH_ID = S_MKTQT_ASSET.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_VEHICLE := NULL;
    END;

    IF NVL(V_NB_VEHICLE, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       --V_LIGNE := '"vehicle":[';
       ---res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_VEHICLE IN C_MKTQT_VEHICLE (S_MKTQT_ASSET.TECH_ID)LOOP
            V_NB_VEHICLE_TRAITE := V_NB_VEHICLE_TRAITE+1;   ---- 
            V_NB_LABELS_TRAITE := 0;
            V_NB_PRICING_TRAITE := 0;
            V_NB_LIFECYCLE_TRAITE :=0;
            V_NB_DOMAINREFS_TRAITE :=0;
            
            V_LIGNE := '"vehicle":{
"tech_dateExtraction":"' || S_MKTQT_VEHICLE.TECH_DATEEXTRACTION	 || '",
"countryBranchCode":"' || S_MKTQT_VEHICLE.COUNTRYBRANCHCODE	 || '",
"serialNumber":"' || S_MKTQT_VEHICLE.SERIALNUMBER	 || '",
"brandCode":"' || S_MKTQT_VEHICLE.BRANDCODE	 || '",
"brandLabel":"' || S_MKTQT_VEHICLE.BRANDLABEL	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); 

IF S_MKTQT_VEHICLE.DELIVERYDATE IS NOT NULL THEN
V_LIGNE := '"deliveryDate":"' || S_MKTQT_VEHICLE.DELIVERYDATE	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); 
END IF;

IF S_MKTQT_VEHICLE.REGISTRATIONNUMBER IS NOT NULL THEN
V_LIGNE := '"registrationNumber":"' || S_MKTQT_VEHICLE.REGISTRATIONNUMBER	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); 
END IF;


V_LIGNE := '"fiscalHorsePower":' || S_MKTQT_VEHICLE.FISCALHORSEPOWER	 || ',
"kindCode":"' || S_MKTQT_VEHICLE.KINDCODE	 || '",
"energyCode":"' || S_MKTQT_VEHICLE.ENERGYCODE	 || '",
"currentMileage":' || S_MKTQT_VEHICLE.CURRENTMILEAGE	 || ',
"isLeasco":' || S_MKTQT_VEHICLE.ISLEASCO	 || ',
"isFinco":' || S_MKTQT_VEHICLE.ISFINCO	 || ',
"contractRef":"' || S_MKTQT_VEHICLE.CONTRACTREF	 || '"';                 
               
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            

                  --------------------- LABELS DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_LABELS
         FROM  MKTOV.MKTQT_ASSET_VEHICULE_LABELS
         WHERE TECH_ID = S_MKTQT_ASSET.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_LABELS := NULL;
    END;

    IF NVL(V_NB_LABELS, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"labels": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_LABELS IN C_MKTQT_LABELS (S_MKTQT_ASSET.TECH_ID)LOOP
            V_NB_LABELS_TRAITE := V_NB_LABELS_TRAITE+1;   ---- 
            
            
            V_LIGNE := '            {
            "languageCode":"' || S_MKTQT_LABELS.LANGUAGECODE || '",
            "versionLabelShort":"' || S_MKTQT_LABELS.VERSIONLABELSHORT || '",
            "versionLabelLong":"' || S_MKTQT_LABELS.VERSIONLABELLONG || '"';                  
               

                if V_NB_LABELS_TRAITE = V_NB_LABELS THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- LABELS FIN----------------------


                  --------------------- PRICING DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_PRICING
         FROM  MKTOV.MKTQT_VEHICULE_PRICING
         WHERE TECH_ID = S_MKTQT_ASSET.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_PRICING := NULL;
    END;

    IF NVL(V_NB_PRICING, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       --V_LIGNE := '"labels": [';
       --res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_PRICING IN C_MKTQT_PRICING (S_MKTQT_ASSET.TECH_ID)LOOP
            V_NB_PRICING_TRAITE := V_NB_PRICING_TRAITE+1;   ---- 
            V_NB_BASEPRICE_TRAITE := 0;
            V_NB_DISCOUNTS_TRAITE := 0;
            
            
            V_LIGNE := '            "pricing":{';
            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
            IF S_MKTQT_PRICING.AMOUNTET IS NOT NULL THEN
V_LIGNE := '                        "amountET":' || S_MKTQT_PRICING.AMOUNTET || ',';
            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF;
            
            IF S_MKTQT_PRICING.OPTIONSTOTALAMOUNTET IS NOT NULL THEN
V_LIGNE := '                        "optionsTotalAmountET":' || S_MKTQT_PRICING.OPTIONSTOTALAMOUNTET || ',';
            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF;
            
            
V_LIGNE := '                        "accessoriesTotalAmountET":' || S_MKTQT_PRICING.ACCESSORIESTOTALAMOUNTET || ',
                        "environmentalBonus":"' || S_MKTQT_PRICING.ENVIRONMENTALBONUS || '"';                  
            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
              
                                ---------------------  PRICING: BASEPRICE  DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_BASEPRICE
         FROM  MKTOV.MKTQT_VEHICULE_BASEPRICE
         WHERE TECH_ID = S_MKTQT_ASSET.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_BASEPRICE := NULL;
    END;

    IF NVL(V_NB_BASEPRICE, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       --V_LIGNE := '"basePrice": [';
       --res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_BASEPRICE IN C_MKTQT_BASEPRICE (S_MKTQT_ASSET.TECH_ID)LOOP
            V_NB_BASEPRICE_TRAITE := V_NB_BASEPRICE_TRAITE+1;   ---- 
            
            
            V_LIGNE := '            "basePrice":{';
            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            IF S_MKTQT_BASEPRICE.AMOUNTET IS NOT NULL THEN
V_LIGNE := '                        "amountET":' || S_MKTQT_BASEPRICE.AMOUNTET || ',';
                    res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF;        
            
V_LIGNE := '                        "vatAmount":' || S_MKTQT_BASEPRICE.VATAMOUNT || '';                

                if V_NB_BASEPRICE_TRAITE = V_NB_BASEPRICE THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '}';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       --V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       --res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- PRICING: BASEPRICE  FIN----------------------
              
                                ---------------------  PRICING: DISCOUNT  DEBUT----------------------
/*
    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_DISCOUNTS
         FROM  MKTOV.MKTQT_VEHICULE_PRICE_DISCOUNT
         WHERE TECH_ID = S_MKTQT_ASSET.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_DISCOUNTS := NULL;
    END;

    IF NVL(V_NB_DISCOUNTS, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '                "discounts": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_DISCOUNTS IN C_MKTQT_DISCOUNTS (S_MKTQT_ASSET.TECH_ID)LOOP
            V_NB_DISCOUNTS_TRAITE := V_NB_DISCOUNTS_TRAITE+1;   ---- 
            
            
            V_LIGNE := '                {
                    "typeCode":"' || S_MKTQT_DISCOUNTS.TYPECODE || '",
                    "sourceCode":"' || S_MKTQT_DISCOUNTS.SOURCECODE || '",
                    "amountET":' || S_MKTQT_DISCOUNTS.AMOUNTET || '';
                 
               

                if V_NB_DISCOUNTS_TRAITE = V_NB_DISCOUNTS THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null

*/
            ---------------------  PRICING:  DISCOUNT  FIN----------------------              
           

                if V_NB_PRICING_TRAITE = V_NB_PRICING THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '}';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       --V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       --res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- PRICING FIN----------------------
               
                                --------------------- LIFECYCLE  DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_LIFECYCLE
         FROM  MKTOV.MKTQT_VEHICULE_LIFECYCLE
         WHERE TECH_ID = S_MKTQT_ASSET.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_LIFECYCLE := NULL;
    END;

    IF NVL(V_NB_LIFECYCLE, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"lifecycle": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_LIFECYCLE IN C_MKTQT_LIFECYCLE (S_MKTQT_ASSET.TECH_ID)LOOP
            V_NB_LIFECYCLE_TRAITE := V_NB_LIFECYCLE_TRAITE+1;   ---- 
            
            
            V_LIGNE := '                {
                "tech_dateExtraction":"' || S_MKTQT_LIFECYCLE.TECH_DATEEXTRACTION || '",
                "countryBranchCode":"' || S_MKTQT_LIFECYCLE.COUNTRYBRANCHCODE || '",
                "modificationType":"' || S_MKTQT_LIFECYCLE.MODIFICATIONTYPE || '",
                "serialNumber":"' || S_MKTQT_LIFECYCLE.SERIALNUMBER || '",
                "registrationNumber":"' || S_MKTQT_LIFECYCLE.REGISTRATIONNUMBER || '",
                "dateRegistration":"' || S_MKTQT_LIFECYCLE.DATEREGISTRATION || '",
                "currentMileage":' || S_MKTQT_LIFECYCLE.CURRENTMILEAGE || '';
                 
               

                if V_NB_LIFECYCLE_TRAITE = V_NB_LIFECYCLE THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- LIFECYCLE FIN----------------------              
              
                
                              --------------------- DOMAINREFS  DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_DOMAINREFS
         FROM  MKTOV.MKTQT_VEHICULE_DOMAINREFS
         WHERE TECH_ID = S_MKTQT_ASSET.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_DOMAINREFS := NULL;
    END;

    IF NVL(V_NB_DOMAINREFS, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"domainRefs": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_DOMAINREFS IN C_MKTQT_DOMAINREFS (S_MKTQT_ASSET.TECH_ID)LOOP
            V_NB_DOMAINREFS_TRAITE := V_NB_DOMAINREFS_TRAITE+1;   ---- 
            
            
            V_LIGNE := '                {
                "tech_dateExtraction":"' || S_MKTQT_DOMAINREFS.TECH_DATEEXTRACTION || '",
                "countryBranchCode":"' || S_MKTQT_DOMAINREFS.COUNTRYBRANCHCODE || '",
                "serialNumber":"' || S_MKTQT_DOMAINREFS.SERIALNUMBER || '",
                "contractRef":"' || S_MKTQT_DOMAINREFS.CONTRACTREF || '",
                "backOfficeOrigin":"' || S_MKTQT_DOMAINREFS.BACKOFFICEORIGIN || '",
                "srcPartyId":"' || S_MKTQT_DOMAINREFS.SRCPARTYID || '",
                "srcJvCode":"' || S_MKTQT_DOMAINREFS.SRCJVCODE || '",
                "srcAppCode":"' || S_MKTQT_DOMAINREFS.SRCAPPCODE || '",
                "stateCode":"' || S_MKTQT_DOMAINREFS.STATECODE || '"';
                 
               

                if V_NB_DOMAINREFS_TRAITE = V_NB_DOMAINREFS THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '},';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- DOMAINREFS FIN----------------------            
         
         
         
         
               
               

                if V_NB_VEHICLE_TRAITE = V_NB_VEHICLE THEN V_LIGNE := V_LIGNE || '}';
                else V_LIGNE := V_LIGNE || '}';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       --V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       -- res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- VEHICLE FIN----------------------






V_LIGNE:='';
    if V_NB_ENREG_TRAITE = V_NB_ENREG THEN V_LIGNE := V_LIGNE || '}';   
    else V_LIGNE := V_LIGNE || '},';    ------------------------------ ajout fin balise
    end if;  
    res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

    N_SAUV := N_SAUV +1;
           
    EXCEPTION WHEN OTHERS THEN COMMIT;
                V_ERR  := 1;
                RES   := MKT.MKTQAUT.F_WRITE(FILE_ID,'EXPORT_ASSET_JSON ','MESSAGE ERREUR PL/SQL : ' ||SQLERRM || S_MKTQT_ASSET.TECH_ID);
                --RETURN V_ERR;
                RETURN V_ERR;
    END;
  END LOOP;
   V_LIGNE := ']';
   res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
   UTL_FILE.FCLOSE(file_id_cvs);
  res := MKT.MKTQAUT.F_WRITE(file_id,
                               'EXPORT_ASSET_JSON',
                               'Nombre de sauvegarde :' || N_SAUV);
    res := MKT.MKTQAUT.F_WRITE(file_id, '', '');
    UTL_FILE.FCLOSE(file_id);

  --RETURN V_ERR;
  RETURN V_ERR;
EXCEPTION WHEN OTHERS THEN COMMIT;
          V_ERR  := 1;
          RES     := MKT.MKTQAUT.F_WRITE(FILE_ID,'EXPORT_ASSET_JSON ','MESSAGE ERREUR PL/SQL : ' ||SQLERRM);
          --RETURN V_ERR;
          RETURN V_ERR;
          
END EXPORT_ASSET_JSON;




FUNCTION EXPORT_PROFIL_JSON (NOMLOG varchar2,P_DATE_TRAI date, P_PATH VARCHAR2, P_CODE_PAYS VARCHAR2, P_FILENAME_PROFIL VARCHAR2) return number IS
    V_ERR       number:=0;
    N_SAUV      NUMBER := 0;
    FILE_ID     UTL_FILE.FILE_TYPE;
    FILE_ID_CVS UTL_FILE.FILE_TYPE;
    V_LIGNE     VARCHAR2(4000);
    RES         NUMBER := 0;
    file_name   VARCHAR2(30);
    V_NB_ENREG  NUMBER(10) := 0;  
    V_NB_ENREG_TRAITE NUMBER(10) := 0;

    V_NB_CONTRACTS  NUMBER(10) := 0;  
    V_NB_CONTRACTS_TRAITE NUMBER(10) := 0;





CURSOR C_MKTQT_CUSTOMER IS
SELECT 
TECH_ID AS TECH_ID,
COUNTRYBRANCHCODE AS COUNTRYBRANCHCODE,
SRCJVCODE AS SRCJVCODE,
SRCAPPCODE AS SRCAPPCODE,
ISLEASCO AS ISLEASCO,
ISFINCO AS ISFINCO

FROM MKTOV.MKTQT_CUSTOMER_PROFILE
WHERE  COUNTRYBRANCHCODE = P_CODE_PAYS
;

CURSOR C_MKTQT_CONTRACTS (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
STAKEHOLDERROLE AS STAKEHOLDERROLE,
CONTRACTREF AS CONTRACTREF,
ACCOUNTSTATUS AS ACCOUNTSTATUS,
DEALERSHIPREF AS DEALERSHIPREF,
VEHSERIALNUMBER AS VEHSERIALNUMBER,
ISLEASCO AS ISLEASCO,
ISFINCO AS ISFINCO,
BACKOFFICEORIGIN AS BACKOFFICEORIGIN

FROM MKTOV.MKTQT_CUSTOMER_PROFILE_CTT
WHERE TECH_ID = P_TECH_ID
;






BEGIN
  file_name := P_FILENAME_PROFIL;
  FILE_ID := MKT.MKTQAUT.F_OPEN(NOMLOG);
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, 'EXPORT_PROFIL_JSON', ' ##  EXPORT PROFIL JSON' ||  ' ##');
  file_id_cvs:= MKT.MKTQAUT.F_OPEN_CVS_UTF8(p_path,file_name);


  BEGIN 
       SELECT COUNT(*)
       INTO   V_NB_ENREG
       FROM   MKTOV.MKTQT_CUSTOMER_PROFILE
       WHERE  COUNTRYBRANCHCODE = P_CODE_PAYS;
  EXCEPTION WHEN OTHERS THEN
       V_NB_ENREG := 0;
  END;

      V_LIGNE := '[';
      res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
      
      FOR S_MKTQT_CUSTOMER IN C_MKTQT_CUSTOMER LOOP
      BEGIN
         V_NB_ENREG_TRAITE := V_NB_ENREG_TRAITE +1;
         V_NB_CONTRACTS_TRAITE  := 0;

         
         
              V_LIGNE := '{
"tech_id":"' || S_MKTQT_CUSTOMER.TECH_ID || '",
"countryBranchCode":"' || S_MKTQT_CUSTOMER.COUNTRYBRANCHCODE || '",
"srcJvCode":"' || S_MKTQT_CUSTOMER.SRCJVCODE || '",
"srcAppCode":"' || S_MKTQT_CUSTOMER.SRCAPPCODE || '",
"isLeasco":' || S_MKTQT_CUSTOMER.ISLEASCO || ',
"isFinco":' || S_MKTQT_CUSTOMER.ISFINCO || '';

res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);


                   --------------------- CONTRACTS DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_CONTRACTS
         FROM  MKTOV.MKTQT_CUSTOMER_PROFILE_CTT
         WHERE TECH_ID = S_MKTQT_CUSTOMER.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_CONTRACTS := NULL;
    END;

    IF NVL(V_NB_CONTRACTS, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"contracts": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_CONTRACTS IN C_MKTQT_CONTRACTS (S_MKTQT_CUSTOMER.TECH_ID)LOOP
            V_NB_CONTRACTS_TRAITE := V_NB_CONTRACTS_TRAITE+1;   ---- 
            
            
            V_LIGNE := '            {
            "stakeholderRole":"' || S_MKTQT_CONTRACTS.STAKEHOLDERROLE || '",
            "contractRef":"' || S_MKTQT_CONTRACTS.CONTRACTREF || '",
            "accountStatus":"' || S_MKTQT_CONTRACTS.ACCOUNTSTATUS || '",
            "dealershipRef":"' || S_MKTQT_CONTRACTS.DEALERSHIPREF || '",
            "vehSerialNumber":"' || S_MKTQT_CONTRACTS.VEHSERIALNUMBER || '",
            "isLeasco":' || S_MKTQT_CONTRACTS.ISLEASCO || ',
            "isFinco":' || S_MKTQT_CONTRACTS.ISFINCO || '';
            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
            
            IF S_MKTQT_CONTRACTS.BACKOFFICEORIGIN IS NOT NULL THEN
V_LIGNE := '            ,"backOfficeOrigin":"' || S_MKTQT_CONTRACTS.BACKOFFICEORIGIN || '"';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            END IF;   

                if V_NB_CONTRACTS_TRAITE = V_NB_CONTRACTS THEN V_LIGNE :=  '            }';
                else V_LIGNE :=  '            },';
                end if;

            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- CONTRACTS FIN----------------------


    




V_LIGNE:='';
    if V_NB_ENREG_TRAITE = V_NB_ENREG THEN V_LIGNE := V_LIGNE || '}';   
    else V_LIGNE := V_LIGNE || '},';    ------------------------------ ajout fin balise
    end if;  
    res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

    N_SAUV := N_SAUV +1;
           
    EXCEPTION WHEN OTHERS THEN COMMIT;
                V_ERR  := 1;
                RES   := MKT.MKTQAUT.F_WRITE(FILE_ID,'EXPORT_PROFIL_JSON ','MESSAGE ERREUR PL/SQL : ' ||SQLERRM || S_MKTQT_CUSTOMER.TECH_ID);
                --RETURN V_ERR;
                RETURN V_ERR;
    END;
  END LOOP;
   V_LIGNE := ']';
   res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
   UTL_FILE.FCLOSE(file_id_cvs);
  res := MKT.MKTQAUT.F_WRITE(file_id,
                               'EXPORT_PROFIL_JSON',
                               'Nombre de sauvegarde :' || N_SAUV);
    res := MKT.MKTQAUT.F_WRITE(file_id, '', '');
    UTL_FILE.FCLOSE(file_id);

  --RETURN V_ERR;
  RETURN V_ERR;
EXCEPTION WHEN OTHERS THEN COMMIT;
          V_ERR  := 1;
          RES     := MKT.MKTQAUT.F_WRITE(FILE_ID,'EXPORT_PROFIL_JSON ','MESSAGE ERREUR PL/SQL : ' ||SQLERRM);
          --RETURN V_ERR;
          RETURN V_ERR;
END EXPORT_PROFIL_JSON;








FUNCTION EXPORT_CUSTOMER_JSON (NOMLOG varchar2,P_DATE_TRAI date, P_PATH VARCHAR2, P_CODE_PAYS VARCHAR2, P_FILENAME_CUSTOMER VARCHAR2) return number IS
    V_ERR       number:=0;
    N_SAUV      NUMBER := 0;
    FILE_ID     UTL_FILE.FILE_TYPE;
    FILE_ID_CVS UTL_FILE.FILE_TYPE;
    V_LIGNE     VARCHAR2(4000);
    RES         NUMBER := 0;
    file_name   VARCHAR2(30);
    V_NB_ENREG  NUMBER(10) := 0;  
    V_NB_ENREG_TRAITE NUMBER(10) := 0;

    V_NB_AGREEMENT  NUMBER(10) := 0;  
    V_NB_AGREEMENT_TRAITE NUMBER(10) := 0;
    
    V_NB_CONTACTS  NUMBER(10) := 0;  
    V_NB_CONTACTS_TRAITE NUMBER(10) := 0;
    
    V_NB_BANKINGS  NUMBER(10) := 0;  
    V_NB_BANKINGS_TRAITE NUMBER(10) := 0;
    
    V_NB_ID  NUMBER(10) := 0;  
    V_NB_ID_TRAITE NUMBER(10) := 0;
    
    V_NB_MEAN  NUMBER(10) := 0;  
    V_NB_MEAN_TRAITE NUMBER(10) := 0;
    
    V_NB_ADRESSES  NUMBER(10) := 0;  
    V_NB_ADRESSES_TRAITE NUMBER(10) := 0;

    V_NB_PHONES  NUMBER(10) := 0;  
    V_NB_PHONES_TRAITE NUMBER(10) := 0;

    V_NB_EMAILS  NUMBER(10) := 0;  
    V_NB_EMAILS_TRAITE NUMBER(10) := 0;
    
    V_NB_INFO  NUMBER(10) := 0;  
    V_NB_INFO_TRAITE NUMBER(10) := 0;

    V_NB_CROSSREF  NUMBER(10) := 0;  
    V_NB_CROSSREF_TRAITE NUMBER(10) := 0;
    V_NB_EXT  NUMBER(10) := 0;  
    V_NB_EXT_TRAITE NUMBER(10) := 0;    
    
    

CURSOR C_MKTQT_CUSTOMER IS

SELECT 
TECH_ID AS TECH_ID,
TO_CHAR(TECH_DATEEXTRACTION, 'YYYY-MM-DD') AS TECH_DATEEXTRACTION	,
COUNTRYBRANCHCODE	AS COUNTRYBRANCHCODE	,
SRCPARTYID	AS SRCPARTYID	,
SRCJVCODE	AS SRCJVCODE	,
SRCAPPCODE	AS SRCAPPCODE	,
CUSTOMERTYPECODE	AS CUSTOMERTYPECODE	,
LASTUPDATEPARTYDATE	AS LASTUPDATEPARTYDATE	,
FULLNAME	AS FULLNAME	,
LEGALENTITYIDENTIFIER	AS LEGALENTITYIDENTIFIER	,
CIVILITYCODE	AS CIVILITYCODE	,
FIRSTNAME	AS FIRSTNAME	,
USAGENAME	AS USAGENAME	,
FISCCOUNTRYCODE	AS FISCCOUNTRYCODE	,
OCCUPATIONLABEL	AS OCCUPATIONLABEL	,
OCCUPATIONTYPECODE	AS OCCUPATIONTYPECODE	,
OCCUPATIONCOMPANYNAME	AS OCCUPATIONCOMPANYNAME	,
ISGROUPEMPLOYEE	AS ISGROUPEMPLOYEE	,
BUSINESSNAME	AS BUSINESSNAME	,
COMPANYNAME	AS COMPANYNAME	,
NACELABEL	AS NACELABEL	,
NBEMPLOYEES	AS NBEMPLOYEES	,
TOTALFLEET	AS TOTALFLEET	,
ISDEALER	AS ISDEALER	,
FLAGDEMATERIALIZATION	AS FLAGDEMATERIALIZATION	,
ISVATELIGIBLE AS ISVATELIGIBLE ,
ISLEASCO	AS ISLEASCO	,
ISFINCO	AS ISFINCO	
FROM MKTOV.MKTQT_CUSTOMER
WHERE  COUNTRYBRANCHCODE = P_CODE_PAYS
;


CURSOR C_MKTQT_AGREEMENT (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION, 'YYYY-MM-DD')	AS TECH_DATEEXTRACTION	,
COUNTRYBRANCHCODE	AS COUNTRYBRANCHCODE	,
SRCPARTYID	AS SRCPARTYID	,
SRCJVCODE	AS SRCJVCODE	,
SRCAPPCODE	AS SRCAPPCODE	,
OPTOUTFLAG	AS OPTOUTFLAG	,
OPTINFLAG	AS OPTINFLAG	,
OPTINCUSTOMERSMS	AS OPTINCUSTOMERSMS	,
OPTINCUSTOMERPAPER	AS OPTINCUSTOMERPAPER	

FROM MKTOV.MKTQT_CUS_AGREEMENT
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_MKTQT_CONTACTS (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION, 'YYYY-MM-DD') AS TECH_DATEEXTRACTION ,
SRCPARTYID AS SRCPARTYID ,
SRCJVCODE AS SRCJVCODE ,
SRCAPPCODE AS SRCAPPCODE ,
CONTACTNAME AS CONTACTNAME ,
CONTACTFIRSTNAME AS CONTACTFIRSTNAME ,
CONTACTCIVILITY AS CONTACTCIVILITY 

FROM MKTOV.MKTQT_CUS_PERSONCONTACTS
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_MKTQT_BANKINGS (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION, 'YYYY-MM-DD')  AS TECH_DATEEXTRACTION ,
SRCPARTYID  AS SRCPARTYID ,
SRCJVCODE  AS SRCJVCODE ,
SRCAPPCODE  AS SRCAPPCODE ,
ROLEBANKINGCODE AS ROLEBANKINGCODE

FROM MKTOV.MKTQT_CUS_ROLEBANKINGS
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_MKTQT_ID (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
SRCPARTYID AS SRCPARTYID,
SRCJVCODE AS SRCJVCODE,
SRCAPPCODE AS SRCAPPCODE,
NATIONALIDENTIFIERTYPECODE AS NATIONALIDENTIFIERTYPECODE,
NATIONALIDENTIFIER AS NATIONALIDENTIFIER

FROM MKTOV.MKTQT_CUS_NATIONALIDENTIFIERS
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_MKTQT_MEAN (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION, 'YYYY-MM-DD') AS TECH_DATEEXTRACTION,
COUNTRYBRANCHCODE AS COUNTRYBRANCHCODE,
SRCPARTYID AS SRCPARTYID,
SRCJVCODE AS SRCJVCODE,
SRCAPPCODE AS SRCAPPCODE

FROM MKTOV.MKTQT_CUS_CONTACTMEAN
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_MKTQT_ADRESSES (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION, 'YYYY-MM-DD') AS TECH_DATEEXTRACTION,
TYPEUSECODE AS TYPEUSECODE,
NUMBERANDSTREET AS NUMBERANDSTREET,
COMPLEMENT AS COMPLEMENT,
ZIPCODE AS ZIPCODE,
LOCALITY AS LOCALITY,
CITY AS CITY,
COUNTRYCODE AS COUNTRYCODE,
COUNTRYISO2 AS COUNTRYISO2,
ISLEASCO AS ISLEASCO,
ISFINCO AS ISFINCO

FROM MKTOV.MKTQT_CUS_CONTACTMEAN_ADRS
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_MKTQT_PHONES (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION, 'YYYY-MM-DD') AS TECH_DATEEXTRACTION,
ASSIGNMENTCODE AS ASSIGNMENTCODE,
VALIDITYDATE AS VALIDITYDATE,
PHONENUMBER AS PHONENUMBER,
ISBUSINESSUSE AS ISBUSINESSUSE,
ISLEASCO AS ISLEASCO,
ISFINCO AS ISFINCO

FROM MKTOV.MKTQT_CUS_CONTACTMEAN_PHONES
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_MKTQT_EMAILS (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION, 'YYYY-MM-DD') AS TECH_DATEEXTRACTION,
VALIDITYDATE AS VALIDITYDATE,
EMAIL AS EMAIL,
ISLEASCO AS ISLEASCO,
ISFINCO AS ISFINCO

FROM MKTOV.MKTQT_CUS_CONTACTMEAN_EMAILS
WHERE TECH_ID = P_TECH_ID
;

CURSOR C_MKTQT_INFO (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION, 'YYYY-MM-DD') AS TECH_DATEEXTRACTION,
SRCPARTYID AS SRCPARTYID,
SRCJVCODE AS SRCJVCODE,
SRCAPPCODE AS SRCAPPCODE,
BANKACCOUNTNUMBER AS BANKACCOUNTNUMBER,
BANKNUMBER AS BANKNUMBER,
BANKNAME AS BANKNAME,
SEPAIBAN AS SEPAIBAN

FROM MKTOV.MKTQT_CUS_CONTACTMEAN_BANKINFO
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_MKTQT_CROSSREF (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
TO_CHAR(TECH_DATEEXTRACTION, 'YYYY-MM-DD') AS TECH_DATEEXTRACTION,
SRCPARTYID AS SRCPARTYID,
SRCJVCODE AS SRCJVCODE,
SRCAPPCODE AS SRCAPPCODE

FROM MKTOV.MKTQT_CUS_CONTACTMEAN_CROSSREF
WHERE TECH_ID = P_TECH_ID
;


CURSOR C_MKTQT_EXT (P_TECH_ID VARCHAR2) IS
SELECT DISTINCT
APPLICATIONEXTCODE AS APPLICATIONEXTCODE,
APPLICATIONEXTLABEL AS APPLICATIONEXTLABEL,
PARTYREFEXT AS PARTYREFEXT

FROM MKTOV.MKTQT_CUS_CONTACTMEAN_EXTREFS
WHERE TECH_ID = P_TECH_ID
;



BEGIN
  file_name := P_FILENAME_CUSTOMER;
  FILE_ID := MKT.MKTQAUT.F_OPEN(NOMLOG);
  RES := MKT.MKTQAUT.F_WRITE(FILE_ID, 'EXPORT_CUSTOMER_JSON', ' ## EXPORT CUSTOMER JSON' ||  ' ##');
  file_id_cvs:= MKT.MKTQAUT.F_OPEN_CVS_UTF8(p_path,file_name);


  BEGIN 
       SELECT COUNT(*)
       INTO   V_NB_ENREG
       FROM   MKTOV.MKTQT_CUSTOMER
       WHERE  COUNTRYBRANCHCODE = P_CODE_PAYS;
  EXCEPTION WHEN OTHERS THEN
       V_NB_ENREG := 0;
  END;

      V_LIGNE := '[';
      res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
      
      FOR S_MKTQT_CUSTOMER IN C_MKTQT_CUSTOMER LOOP
      BEGIN
         V_NB_ENREG_TRAITE := V_NB_ENREG_TRAITE +1;
         
    V_NB_AGREEMENT_TRAITE := 0;
    V_NB_CONTACTS_TRAITE := 0;
    V_NB_BANKINGS_TRAITE := 0;
    V_NB_ID_TRAITE := 0;
    V_NB_MEAN_TRAITE := 0;
    V_NB_INFO_TRAITE := 0;    
    V_NB_CROSSREF_TRAITE := 0;         
    
    
         
              V_LIGNE := '{
"tech_id":"' || S_MKTQT_CUSTOMER.TECH_ID || '",
"tech_dateExtraction":"' || S_MKTQT_CUSTOMER.TECH_DATEEXTRACTION	 || '",
"countryBranchCode":"' || S_MKTQT_CUSTOMER.COUNTRYBRANCHCODE	 || '",
"srcPartyId":"' || S_MKTQT_CUSTOMER.SRCPARTYID	 || '",
"srcJvCode":"' || S_MKTQT_CUSTOMER.SRCJVCODE	 || '",
"srcAppCode":"' || S_MKTQT_CUSTOMER.SRCAPPCODE	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

IF S_MKTQT_CUSTOMER.CUSTOMERTYPECODE IS NOT NULL THEN
V_LIGNE := '"customerTypeCode":"' || S_MKTQT_CUSTOMER.CUSTOMERTYPECODE	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

V_LIGNE := '"lastUpdatePartyDate":"' || S_MKTQT_CUSTOMER.LASTUPDATEPARTYDATE	 || '",
"fullName":"' || S_MKTQT_CUSTOMER.FULLNAME	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

IF S_MKTQT_CUSTOMER.LEGALENTITYIDENTIFIER IS NOT NULL THEN
V_LIGNE := '"legalEntityIdentifier":"' || S_MKTQT_CUSTOMER.LEGALENTITYIDENTIFIER	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

V_LIGNE := '"civilityCode":"' || S_MKTQT_CUSTOMER.CIVILITYCODE	 || '",
"firstName":"' || S_MKTQT_CUSTOMER.FIRSTNAME	 || '",
"usageName":"' || S_MKTQT_CUSTOMER.USAGENAME	 || '",
"fiscCountryCode":"' || S_MKTQT_CUSTOMER.FISCCOUNTRYCODE	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

IF S_MKTQT_CUSTOMER.OCCUPATIONLABEL IS NOT NULL THEN
V_LIGNE := '"occupationLabel":"' || S_MKTQT_CUSTOMER.OCCUPATIONLABEL	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

IF S_MKTQT_CUSTOMER.OCCUPATIONTYPECODE IS NOT NULL THEN
V_LIGNE := '"occupationTypeCode":"' || S_MKTQT_CUSTOMER.OCCUPATIONTYPECODE	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

V_LIGNE := '"occupationCompanyName":"' || S_MKTQT_CUSTOMER.OCCUPATIONCOMPANYNAME	 || '",
"isGroupEmployee":"' || S_MKTQT_CUSTOMER.ISGROUPEMPLOYEE	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

IF S_MKTQT_CUSTOMER.BUSINESSNAME IS NOT NULL THEN
V_LIGNE := '"businessName":"' || S_MKTQT_CUSTOMER.BUSINESSNAME	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

IF S_MKTQT_CUSTOMER.COMPANYNAME IS NOT NULL THEN
V_LIGNE := '"companyName":"' || S_MKTQT_CUSTOMER.COMPANYNAME	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

IF S_MKTQT_CUSTOMER.NACELABEL IS NOT NULL THEN
V_LIGNE := '"naceLabel":"' || S_MKTQT_CUSTOMER.NACELABEL	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;


V_LIGNE := '"nbEmployees":' || S_MKTQT_CUSTOMER.NBEMPLOYEES	 || ',
"totalFleet":"' || S_MKTQT_CUSTOMER.TOTALFLEET	 || '",';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

IF S_MKTQT_CUSTOMER.ISDEALER IS NOT NULL THEN
V_LIGNE := '"isDealer":' || S_MKTQT_CUSTOMER.ISDEALER	 || ',';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

IF S_MKTQT_CUSTOMER.FLAGDEMATERIALIZATION IS NOT NULL THEN
V_LIGNE := '"isVatEligible":' || S_MKTQT_CUSTOMER.FLAGDEMATERIALIZATION	 || ',';
res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
END IF;

V_LIGNE := '"flagDematerialization":' || S_MKTQT_CUSTOMER.ISVATELIGIBLE  || ',
"isLeasco":' || S_MKTQT_CUSTOMER.ISLEASCO	 || ',
"isFinco":' || S_MKTQT_CUSTOMER.ISFINCO	 || '';

res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);


                   --------------------- AGREEMENT DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_AGREEMENT
         FROM  MKTOV.MKTQT_CUS_AGREEMENT
         WHERE TECH_ID = S_MKTQT_CUSTOMER.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_AGREEMENT := NULL;
    END;

    IF NVL(V_NB_AGREEMENT, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       --V_LIGNE := '"agreement": [';
       --res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_AGREEMENT IN C_MKTQT_AGREEMENT (S_MKTQT_CUSTOMER.TECH_ID)LOOP
            V_NB_AGREEMENT_TRAITE := V_NB_AGREEMENT_TRAITE+1;   ---- 
            
            
            V_LIGNE := '"agreement":{
        "tech_dateExtraction":"' || S_MKTQT_AGREEMENT.TECH_DATEEXTRACTION	 || '",
        "srcPartyId":"' || S_MKTQT_AGREEMENT.SRCPARTYID	 || '",
        "srcJvCode":"' || S_MKTQT_AGREEMENT.SRCJVCODE	 || '",
        "srcAppCode":"' || S_MKTQT_AGREEMENT.SRCAPPCODE	 || '",
        "optOutFlag":' || S_MKTQT_AGREEMENT.OPTOUTFLAG	 || ',
        "optInFlag":' || S_MKTQT_AGREEMENT.OPTINFLAG	 || ',
        "OptInCustomerSMS":' || S_MKTQT_AGREEMENT.OPTINCUSTOMERSMS	 || ',
        "OptInCustomerPaper":' || S_MKTQT_AGREEMENT.OPTINCUSTOMERPAPER	 || '';
        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
            
        
                if V_NB_AGREEMENT_TRAITE = V_NB_AGREEMENT THEN V_LIGNE :=  '        }';
                else V_LIGNE :=  '        }';
                end if;

        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       --V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       --res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- AGREEMENT FIN----------------------


                   --------------------- CONTACTS DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_CONTACTS
         FROM  MKTOV.MKTQT_CUS_PERSONCONTACTS
         WHERE TECH_ID = S_MKTQT_CUSTOMER.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_CONTACTS := NULL;
    END;

    IF NVL(V_NB_CONTACTS, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"personContacts": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_CONTACTS IN C_MKTQT_CONTACTS (S_MKTQT_CUSTOMER.TECH_ID)LOOP
            V_NB_CONTACTS_TRAITE := V_NB_CONTACTS_TRAITE+1;   ---- 
            
            
            V_LIGNE := '        {
        "tech_dateExtraction":"' || S_MKTQT_CONTACTS.TECH_DATEEXTRACTION  || '",
        "srcPartyId":"' || S_MKTQT_CONTACTS.SRCPARTYID  || '",
        "srcJvCode":"' || S_MKTQT_CONTACTS.SRCJVCODE  || '",
        "srcAppCode":"' || S_MKTQT_CONTACTS.SRCAPPCODE  || '",
        "contactName":"' || S_MKTQT_CONTACTS.CONTACTNAME  || '",
        "contactFirstname":"' || S_MKTQT_CONTACTS.CONTACTFIRSTNAME  || '"';
        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);  
        
        IF S_MKTQT_CONTACTS.CONTACTCIVILITY IS NOT NULL THEN
            V_LIGNE := '        ,"contactCivility":"' || S_MKTQT_CONTACTS.CONTACTCIVILITY  || '"';
            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
        END IF;    
        
                if V_NB_CONTACTS_TRAITE = V_NB_CONTACTS THEN V_LIGNE :=  '        }';
                else V_LIGNE :=  '        },';
                end if;

        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- CONTACTS FIN----------------------


                   --------------------- BANKINGS DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_BANKINGS
         FROM  MKTOV.MKTQT_CUS_ROLEBANKINGS
         WHERE TECH_ID = S_MKTQT_CUSTOMER.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_BANKINGS := NULL;
    END;

    IF NVL(V_NB_BANKINGS, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"roleBankings": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_BANKINGS IN C_MKTQT_BANKINGS (S_MKTQT_CUSTOMER.TECH_ID)LOOP
            V_NB_BANKINGS_TRAITE := V_NB_BANKINGS_TRAITE+1;   ---- 
            
            
            V_LIGNE := '        {
        "tech_dateExtraction":"' || S_MKTQT_BANKINGS.TECH_DATEEXTRACTION  || '",
        "srcPartyId":"' || S_MKTQT_BANKINGS.SRCPARTYID  || '",
        "srcJvCode":"' || S_MKTQT_BANKINGS.SRCJVCODE  || '",
        "srcAppCode":"' || S_MKTQT_BANKINGS.SRCAPPCODE  || '",
        "roleBankingCode":"' || S_MKTQT_BANKINGS.ROLEBANKINGCODE || '"';
        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
            
        
                if V_NB_BANKINGS_TRAITE = V_NB_BANKINGS THEN V_LIGNE :=  '        }';
                else V_LIGNE :=  '        },';
                end if;

        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- BANKINGS FIN----------------------



                   --------------------- ID DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_ID
         FROM  MKTOV.MKTQT_CUS_NATIONALIDENTIFIERS
         WHERE TECH_ID = S_MKTQT_CUSTOMER.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_ID := NULL;
    END;

    IF NVL(V_NB_ID, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"nationalIdentifiers": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_ID IN C_MKTQT_ID (S_MKTQT_CUSTOMER.TECH_ID)LOOP
            V_NB_ID_TRAITE := V_NB_ID_TRAITE+1;   ---- 
            
            
            V_LIGNE := '        {
        "srcPartyId":"' || S_MKTQT_ID.SRCPARTYID || '",
        "srcJvCode":"' || S_MKTQT_ID.SRCJVCODE || '",
        "srcAppCode":"' || S_MKTQT_ID.SRCAPPCODE || '",
        "nationalIdentifier":"' || S_MKTQT_ID.NATIONALIDENTIFIERTYPECODE || '",
        "nationalIdentifierTypeCode":"' || S_MKTQT_ID.NATIONALIDENTIFIER || '"';
        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
            
        
                if V_NB_ID_TRAITE = V_NB_ID THEN V_LIGNE :=  '        }';
                else V_LIGNE :=  '        },';
                end if;

        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- ID FIN----------------------

                   --------------------- MEAN DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_MEAN
         FROM  MKTOV.MKTQT_CUS_CONTACTMEAN
         WHERE TECH_ID = S_MKTQT_CUSTOMER.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_MEAN := NULL;
    END;

    IF NVL(V_NB_MEAN, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"contactMean":[';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_MEAN IN C_MKTQT_MEAN (S_MKTQT_CUSTOMER.TECH_ID)LOOP
            V_NB_MEAN_TRAITE := V_NB_MEAN_TRAITE+1;   ---- 
            V_NB_ADRESSES_TRAITE := 0;
            V_NB_PHONES_TRAITE := 0;
            V_NB_EMAILS_TRAITE := 0;
            
            V_LIGNE := '        {
        "tech_dateExtraction":"' || S_MKTQT_MEAN.TECH_DATEEXTRACTION || '",
        "countryBranchCode":"' || S_MKTQT_MEAN.COUNTRYBRANCHCODE || '",
        "srcPartyId":"' || S_MKTQT_MEAN.SRCPARTYID || '",
        "srcJvCode":"' || S_MKTQT_MEAN.SRCJVCODE || '",
        "srcAppCode":"' || S_MKTQT_MEAN.SRCAPPCODE || '"';
        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
            

                               --------------------- ADRESSES DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_ADRESSES
         FROM  MKTOV.MKTQT_CUS_CONTACTMEAN_ADRS
         WHERE TECH_ID = S_MKTQT_CUSTOMER.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_ADRESSES := NULL;
    END;

    IF NVL(V_NB_ADRESSES, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '        "adresses": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_ADRESSES IN C_MKTQT_ADRESSES (S_MKTQT_CUSTOMER.TECH_ID)LOOP
            V_NB_ADRESSES_TRAITE := V_NB_ADRESSES_TRAITE+1;   ---- 
            
            
            V_LIGNE := '                {
                "tech_dateExtraction":"' || S_MKTQT_ADRESSES.TECH_DATEEXTRACTION || '",
                "typeUseCode":"' || S_MKTQT_ADRESSES.TYPEUSECODE || '",
                "numberAndStreet":"' || S_MKTQT_ADRESSES.NUMBERANDSTREET || '",
                "complement":"' || S_MKTQT_ADRESSES.COMPLEMENT || '",
                "zipCode":"' || S_MKTQT_ADRESSES.ZIPCODE || '",';
               res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); 
                
               IF S_MKTQT_ADRESSES.LOCALITY IS NOT NULL THEN 
                    V_LIGNE := '                "locality":"' || S_MKTQT_ADRESSES.LOCALITY || '",';
                    res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); 
               END IF; 
                
                
V_LIGNE := '                "city":"' || S_MKTQT_ADRESSES.CITY || '",
                "countryCode":"' || S_MKTQT_ADRESSES.COUNTRYCODE || '",
                "countryIso2":"' || S_MKTQT_ADRESSES.COUNTRYISO2 || '",
                "isLeasco":' || S_MKTQT_ADRESSES.ISLEASCO || ',
                "isFinco":' || S_MKTQT_ADRESSES.ISFINCO || '';
        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
            
        
                if V_NB_ADRESSES_TRAITE = V_NB_ADRESSES THEN V_LIGNE :=  '                }';
                else V_LIGNE :=  '                },';
                end if;

        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '        ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- ADRESSES FIN----------------------
            
            
            
  
                               --------------------- PHONES DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_PHONES
         FROM  MKTOV.MKTQT_CUS_CONTACTMEAN_PHONES
         WHERE TECH_ID = S_MKTQT_CUSTOMER.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_PHONES := NULL;
    END;

    IF NVL(V_NB_PHONES, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '        "phones": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_PHONES IN C_MKTQT_PHONES (S_MKTQT_CUSTOMER.TECH_ID)LOOP
            V_NB_PHONES_TRAITE := V_NB_PHONES_TRAITE+1;   ---- 
            
            
            V_LIGNE := '                {
                "tech_dateExtraction":"' || S_MKTQT_PHONES.TECH_DATEEXTRACTION || '",
                "assignmentCode":"' || S_MKTQT_PHONES.ASSIGNMENTCODE || '",';
                res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);                 
                
                IF S_MKTQT_PHONES.VALIDITYDATE IS NOT NULL THEN
V_LIGNE := '                "validityDate":"' || S_MKTQT_PHONES.VALIDITYDATE || '",';
                    res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);                 
                END IF;
                IF S_MKTQT_PHONES.PHONENUMBER IS NOT NULL THEN
V_LIGNE := '                "phoneNumber":"' || S_MKTQT_PHONES.PHONENUMBER || '",';
                    res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);                 
                END IF;
                
                IF S_MKTQT_PHONES.ISBUSINESSUSE IS NOT NULL THEN
V_LIGNE := '                "isBusinessUse":' || S_MKTQT_PHONES.ISBUSINESSUSE || ',';
                    res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);                 
                END IF;
                
                
V_LIGNE := '                "isLeasco":' || S_MKTQT_PHONES.ISLEASCO || ',
                "isFinco":' || S_MKTQT_PHONES.ISFINCO || '';
        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
            
        
                if V_NB_PHONES_TRAITE = V_NB_PHONES THEN V_LIGNE :=  '                }';
                else V_LIGNE :=  '                },';
                end if;

        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '        ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- PHONES FIN----------------------
   
                               --------------------- EMAILS DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_EMAILS
         FROM  MKTOV.MKTQT_CUS_CONTACTMEAN_EMAILS
         WHERE TECH_ID = S_MKTQT_CUSTOMER.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_EMAILS := NULL;
    END;

    IF NVL(V_NB_EMAILS, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '        "emails": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_EMAILS IN C_MKTQT_EMAILS (S_MKTQT_CUSTOMER.TECH_ID)LOOP
            V_NB_EMAILS_TRAITE := V_NB_EMAILS_TRAITE+1;   ---- 
            
            
            V_LIGNE := '                {
                "tech_dateExtraction":"' || S_MKTQT_EMAILS.TECH_DATEEXTRACTION || '",';
              res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);  
              
              
              IF S_MKTQT_EMAILS.VALIDITYDATE IS NOT NULL THEN  
                    V_LIGNE := '                "validityDate":"' || S_MKTQT_EMAILS.VALIDITYDATE || '",';
                    res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);  
              END IF;  
                
              
V_LIGNE := '                "email":"' || S_MKTQT_EMAILS.EMAIL || '",
                "isLeasco":' || S_MKTQT_EMAILS.ISLEASCO || ',
                "isFinco":' || S_MKTQT_EMAILS.ISFINCO || '';
        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
            
        
                if V_NB_EMAILS_TRAITE = V_NB_EMAILS THEN V_LIGNE :=  '                }';
                else V_LIGNE :=  '                },';
                end if;

        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '        ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- EMAILS FIN----------------------

                if V_NB_MEAN_TRAITE = V_NB_MEAN THEN V_LIGNE :=  '      }';
                else V_LIGNE :=  '      },';
                end if;

        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- MEAN FIN----------------------

                              --------------------- INFO DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_INFO
         FROM  MKTOV.MKTQT_CUS_CONTACTMEAN_BANKINFO
         WHERE TECH_ID = S_MKTQT_CUSTOMER.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_INFO := NULL;
    END;

    IF NVL(V_NB_INFO, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '"bankInformations": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_INFO IN C_MKTQT_INFO (S_MKTQT_CUSTOMER.TECH_ID)LOOP
            V_NB_INFO_TRAITE := V_NB_INFO_TRAITE+1;   ---- 
            
            
            V_LIGNE := '        {
        "tech_dateExtraction":"' || S_MKTQT_INFO.TECH_DATEEXTRACTION || '",
        "srcPartyId":"' || S_MKTQT_INFO.SRCPARTYID || '",
        "srcJvCode":"' || S_MKTQT_INFO.SRCJVCODE || '",
        "srcAppCode":"' || S_MKTQT_INFO.SRCAPPCODE || '",
        "bankAccountNumber":"' || S_MKTQT_INFO.BANKACCOUNTNUMBER || '",
        "bankNumber":"' || S_MKTQT_INFO.BANKNUMBER || '",
        "bankName":"' || S_MKTQT_INFO.BANKNAME || '"';
        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
        
        
        IF S_MKTQT_INFO.SEPAIBAN IS NOT NULL THEN
            V_LIGNE := '        ,"sepaIban":"' || S_MKTQT_INFO.SEPAIBAN || '"';
            res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
        END IF;    
        
                if V_NB_INFO_TRAITE = V_NB_INFO THEN V_LIGNE :=  '        }';
                else V_LIGNE :=  '        },';
                end if;

        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- INFO FIN----------------------
            
                              --------------------- CROSSREF DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_CROSSREF
         FROM  MKTOV.MKTQT_CUS_CONTACTMEAN_CROSSREF
         WHERE TECH_ID = S_MKTQT_CUSTOMER.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_CROSSREF := NULL;
    END;

    IF NVL(V_NB_CROSSREF, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       --V_LIGNE := '"crossref": [';
       --res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_CROSSREF IN C_MKTQT_CROSSREF (S_MKTQT_CUSTOMER.TECH_ID)LOOP
            V_NB_CROSSREF_TRAITE := V_NB_CROSSREF_TRAITE+1;   ---- 
            V_NB_EXT_TRAITE := 0;
            
            V_LIGNE := '"crossref":{
        "tech_dateExtraction":"' || S_MKTQT_CROSSREF.TECH_DATEEXTRACTION || '",
        "srcPartyId":"' || S_MKTQT_CROSSREF.SRCPARTYID || '",
        "srcJvCode":"' || S_MKTQT_CROSSREF.SRCJVCODE || '",
        "srcAppCode":"' || S_MKTQT_CROSSREF.SRCAPPCODE || '"';
        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
         
                                       --------------------- EXT DEBUT----------------------

    BEGIN
         SELECT COUNT(*)
         INTO   V_NB_EXT
         FROM  MKTOV.MKTQT_CUS_CONTACTMEAN_EXTREFS
         WHERE TECH_ID = S_MKTQT_CUSTOMER.TECH_ID;
    EXCEPTION WHEN OTHERS THEN
              V_NB_EXT := NULL;
    END;

    IF NVL(V_NB_EXT, 0) > 0 THEN
       V_LIGNE := ',' ; res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE); --------- virgule ajoutee
    
       V_LIGNE := '        "externalRefs": [';
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
       
       FOR S_MKTQT_EXT IN C_MKTQT_EXT (S_MKTQT_CUSTOMER.TECH_ID)LOOP
            V_NB_EXT_TRAITE := V_NB_EXT_TRAITE+1;   ---- 
            
            
            V_LIGNE := '                {
                "applicationExtCode":"' || S_MKTQT_EXT.APPLICATIONEXTCODE || '",
                "applicationExtLabel":"' || S_MKTQT_EXT.APPLICATIONEXTLABEL || '",
                "partyRefExt":"' || S_MKTQT_EXT.PARTYREFEXT || '"';
        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);            
            
        
                if V_NB_EXT_TRAITE = V_NB_EXT THEN V_LIGNE :=  '                }';
                else V_LIGNE :=  '              },';
                end if;

        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       V_LIGNE := '             ]';      ---------   virgule ajoutee dans la boucle suivant 
       res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- EXT FIN----------------------
         
            
        
                if V_NB_CROSSREF_TRAITE = V_NB_CROSSREF THEN V_LIGNE :=  '        }';
                else V_LIGNE :=  '        },';
                end if;

        res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
            
            
       END LOOP;
       --V_LIGNE := '    ]';      ---------   virgule ajoutee dans la boucle suivant 
       --res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
    END IF;
    V_LIGNE := '';  -------- null


            --------------------- CROSSREF FIN----------------------




    if V_NB_ENREG_TRAITE = V_NB_ENREG THEN V_LIGNE := V_LIGNE || '}';   
    else V_LIGNE := V_LIGNE || '},';    ------------------------------ ajout fin balise
    end if;  
    res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);

    N_SAUV := N_SAUV +1;
           
    EXCEPTION WHEN OTHERS THEN COMMIT;
                V_ERR  := 1;
                RES   := MKT.MKTQAUT.F_WRITE(FILE_ID,'EXPORT_CUSTOMER_JSON ','MESSAGE ERREUR PL/SQL : ' ||SQLERRM || S_MKTQT_CUSTOMER.TECH_ID);
                --RETURN V_ERR;
                RETURN V_ERR;
    END;
  END LOOP;
   V_LIGNE := ']';
   res := MKT.MKTQAUT.F_WRITE_CVS_UTF8(file_id_cvs, V_LIGNE);
   UTL_FILE.FCLOSE(file_id_cvs);
  res := MKT.MKTQAUT.F_WRITE(file_id,
                               'EXPORT_CUSTOMER_JSON',
                               'Nombre de sauvegarde :' || N_SAUV);
    res := MKT.MKTQAUT.F_WRITE(file_id, '', '');
    UTL_FILE.FCLOSE(file_id);

  --RETURN V_ERR;
  RETURN V_ERR;
EXCEPTION WHEN OTHERS THEN COMMIT;
          V_ERR  := 1;
          RES     := MKT.MKTQAUT.F_WRITE(FILE_ID,'EXPORT_CUSTOMER_JSON ','MESSAGE ERREUR PL/SQL : ' ||SQLERRM);
          --RETURN V_ERR;
          RETURN V_ERR;
END EXPORT_CUSTOMER_JSON;




FUNCTION MAIN_EXPORT_JSON(NOMLOG varchar2,P_DATE_TRAI date, P_PATH VARCHAR2, P_CODE_PAYS VARCHAR2,
                            P_FILENAME_CONTRAT VARCHAR2,
                            P_FILENAME_AGREEMENT VARCHAR2,
                            P_FILENAME_ASSET VARCHAR2,
                            P_FILENAME_PROFIL VARCHAR2,
                            P_FILENAME_CUSTOMER VARCHAR2)RETURN NUMBER IS   
        V_ERR number:=0;
        V_RET number:=0;
        ---V_TRT VARCHAR2(100) := null;
        ---V_ERR_TRT number:=0;
        --V_ERRUR NUMBER :=0;
        V_INSERTS NUMBER := 0;
        V_UPDATES NUMBER :=0;
        --P_DATE_TRAI DATE;
        V_ERROR NUMBER :=0;
        ---V_CODE_PAYS VARCHAR2(2);

  BEGIN
     
  

 V_ERR := EXPORT_CONTRACT_JSON (NOMLOG, P_DATE_TRAI, P_PATH, P_CODE_PAYS, P_FILENAME_CONTRAT);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;
                            
 V_ERR := EXPORT_AGREEMENT_JSON(NOMLOG, P_DATE_TRAI, P_PATH, P_CODE_PAYS, P_FILENAME_AGREEMENT);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;

 V_ERR := EXPORT_ASSET_JSON(NOMLOG, P_DATE_TRAI, P_PATH, P_CODE_PAYS, P_FILENAME_ASSET);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if;  

 V_ERR := EXPORT_PROFIL_JSON(NOMLOG, P_DATE_TRAI, P_PATH, P_CODE_PAYS, P_FILENAME_PROFIL);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if; 

 V_ERR := EXPORT_CUSTOMER_JSON(NOMLOG, P_DATE_TRAI, P_PATH, P_CODE_PAYS, P_FILENAME_CUSTOMER);
      if V_ERR=1 then V_RET:=1;
          return V_RET;
      end if; 

       


                            
		return V_RET;
																													
END MAIN_EXPORT_JSON;  




end mktqads;
